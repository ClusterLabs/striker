#!/usr/bin/perl
# 
# This software was created by Alteeve's Niche! Inc. and has been released under the terms of the GNU GPL 
# version 2.
#
# ScanCore Scan Agent for APC/Schneider network connected switched PDUs (AP7900* type).
#
# https://alteeve.com
# 
# Exit Codes:
# 0   - Success
# 1   - Failed to read the number of phases on the PDU.
# 2   - Failed to read the number of outlets on the PDU.
# 
# 255 - The host's UUID isn't in the hosts table yet, ScanCore itself hasn't been run.
# 

# Use my modules.
use strict;
use warnings;
use AN::Tools;
use Data::Dumper;
use Socket;
no warnings 'recursion';

=cut

OIDs of interest;

State data
.1.3.6.1.4.1.318.1.1.4.1.5.0         = Serial Number							<- Global ID
.1.3.6.1.4.1.318.1.1.4.1.4.0         = Model Number
.1.3.6.1.4.1.318.1.1.4.1.3.0         = Date of manufacture (mm/dd/yyyy, if 'yy' year 2000 = '00')
.1.3.6.1.4.1.318.1.1.4.1.2.0         = Firmware version
.1.3.6.1.4.1.318.1.1.4.1.1.0         = Hardware version (never changes)

Variables
.1.3.6.1.2.1.1.3.0                   = Uptime (in timeticks, 900 = 9 seconds)
.1.3.6.1.4.1.318.1.1.12.1.16.0       = Wattage draw (seems to be for the full device, not per phase)

# Phase info
.1.3.6.1.4.1.318.1.1.12.2.1.1.0      = Max Amperage out per phase
.1.3.6.1.4.1.318.1.1.12.2.1.2.0      = Number of phases on the PDU
.1.3.6.1.4.1.318.1.1.12.2.2.1.1.2.1  = Low amp threshold. (0 = Disabled; No alarm on low power. Any digit is the minimum amperage under which we throw an alert)  (NOTE: last digit is phase number, so .1 == phase 1) 
.1.3.6.1.4.1.318.1.1.12.2.2.1.1.3.1  = High amperage warning threshold. If the power draw exceeds this, throw a warning alert, warn on equal or greater
.1.3.6.1.4.1.318.1.1.12.2.2.1.1.4.1  = High amperage critical threshold. If the power draw exceeds this, throw a critical alert (breaker is about to pop), warn on equal or greater	(NOTE: Default == max amp per phase, we should set it lower, Max - 2?)
.1.3.6.1.4.1.318.1.1.12.2.3.1.1.2.1  = Current Amperage on the phase, in 1/10 Amp (x10 to get Amp)

Port information
.1.3.6.1.4.1.318.1.1.4.4.1.0         = Number of outlets (ie: 8)
.1.3.6.1.4.1.318.1.1.4.4.2.1.2.n     = Pending action on state? (1 = command pending, 2 = no command pending, 3 = unknown. If all ports are '3', power cycle is required. If the all devices on the peer report Power is OK, do so immediately)
.1.3.6.1.4.1.318.1.1.4.4.2.1.3.n     = Current state (read: 1 = on, 2 = off, 4 = unknown --- write: 1 = turn on, 2 = turn off, 3 = cycle (~5s), 5 = on after 'sPDUOutletPowerOnTime' delay, 6 = off after sPDUOutletPowerOffTime delay, 7 = off after sPDUOutletPowerOffTime delay, wait sPDUOutletRebootDuration time, then back on.)
.1.3.6.1.4.1.318.1.1.4.5.2.1.3.n     = Outlet name (default is 'Outlet N'), Can be read or set, max 20 chars.		<- Set this when we map the Anvil! 
.1.3.6.1.4.1.318.1.1.4.5.2.1.2.n     = Power on delay (in seconds), default is '0' seconds.  (-1 = stay off, 0 = on with PDU,  X = number of seconds to wait before powering on)
.1.3.6.1.4.1.318.1.1.4.5.2.1.4.n     = Power off delay (in seconds)                          (-1 = stay on,  0 = off with PDU, X = number of seconds to wait before powering off)
.1.3.6.1.4.1.318.1.1.4.5.2.1.5.n     = Reboot delay (sleep time), default is '5' seconds.
.1.3.6.1.4.1.318.1.1.12.3.5.1.1.3.n  = Phase that this outlet is in

Network data  (NOTE: .1 is the loopback interface, .2 is the physical interface)
.1.3.6.1.2.1.2.2.1.4.2 = MTU size
.1.3.6.1.2.1.2.2.1.5.2 = Link speed (in bps)
.1.3.6.1.2.1.2.2.1.6.2 = MAC address	- This is losing the first nibble... It returns type STRING instead of Hex-STRING, even if -Ox is used. If I point to the APC MIB, it returns OK. This is what we should be using.
.1.3.6.1.6.3.10.2.1.1.0 = MAC address (with some prefix) in hex. Not sure if this is supported on other PDUs though...

=cut

# Disable buffering.
$| = 1;

# Figure out who and where I am.
my $THIS_FILE           =  ($0 =~ /^.*\/(.*)$/)[0];
my $running_directory   =  ($0 =~ /^(.*?)\/$THIS_FILE$/)[0];
if (($running_directory =~ /^\./) && ($ENV{PWD}))
{
	$running_directory =~ s/^\./$ENV{PWD}/;
}
my $scancore_directory = ($running_directory =~ /^(.*?)\/agents\/$THIS_FILE$/)[0];

# Get the handle to the AN::Tools and preset some variables I will use.
my $an = AN::Tools->new({data => 
	{
		path			=>	{
			core_strings		=>	"$scancore_directory/ScanCore.xml",
			# This stores this node's UUID. It is used to track all our sensor data in the 
			# database. If you change this here, change it ScanCore, too.
			host_uuid		=>	"/etc/striker/host.uuid",
			snmpget			=>	"/usr/bin/snmpget",
			snmpset			=>	"/usr/bin/snmpset",
			strings			=>	"$running_directory/$THIS_FILE.xml",
			sql			=>	"$running_directory/$THIS_FILE.sql",
			striker_config		=>	"/etc/striker/striker.conf",
			striker_strings		=>	"/sbin/striker/Data/strings.xml",
			striker_mib		=>	"/sbin/striker/ScanCore/agents/$THIS_FILE/Striker-MIB.txt",
		},
		sys			=>	{
			alert_sort		=>	0,
			# This will get set by AN::Tools::DB->connect_to_databases()
			host_uuid_query		=>	"",
			# When a lock is requested, this is set to the time the lock was set. 
			# DB->do_db_write() and DB->do_db_read() will check this and if its age is >50% of
			# scancore::locking::reap_age, it will renew the lock.
			local_lock_active	=>	0,
			sql			=>	[],
		},
		scancore		=>	{
			archive			=>	{
				directory		=>	"/var/ScanCore/archives/",
				division		=>	60000,
				trigger			=>	100000,
				count			=>	50000,
				dump_file_header	=>	"
SET statement_timeout = 0;
SET lock_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET row_security = off;

SET search_path = history, pg_catalog;
",
			},
		},
		# These are values the user might set in striker.conf
		'scan-apc-pdu'			=>	{
			disable				=>	0,
			language			=>	"en_CA",
			log_file			=>	"/var/log/ScanCore.log",
			log_level			=>	1,
			log_language			=>	"en_CA",
			log_db_transactions		=>	0,
			# CSV of PDUs to scan. If set, /etc/hosts will not be processed. If not set, hosts
			# will be searched for any entry with 'pdu' in its name and added to this.
			pdus				=>	"",
			# Once parsed, the PDUs will be scanned using this hash where the key is the PDU 
			# name and the value is the IP address.
			pdu			=>	{},
			# Ticks are genera	lly in 10ms increments
			ticks_per_second		=>	100,
			# By default, the critical amperage is the same as the max amperage. If that is the
			# case here, we will subtract this number of amps from the max and use that as our
			# critical warning threshold. So if the max threshold is 12, and the critical 
			# threshold is also 11 or 12, we will drop it to 10. If the critical is set below 10,
			# we won't adjust it at all.
			critical_amps_below_max		=>	2,
			# This drops the warning to be at least this number of amps below critical's level.
			warning_amps_below_critical	=>	2,
			# A warning or critical alert has to be this number of amps above/below the threshold
			# for the alert to be cleared.
			clear_alert_threshold		=>	2,
			# This is the number of scans in a row that an alert state needs to exist for before 
			# we trigger an alarm.
			sensor_loss_count_to_alarm	=>	3,
		},
		'oids'		=>	{
			apc_pdu			=>	{
				apc_pdu_serial_number		=>	".1.3.6.1.4.1.318.1.1.4.1.5.0", 
				apc_pdu_model_number		=>	".1.3.6.1.4.1.318.1.1.4.1.4.0", 
				apc_pdu_manufacture_date	=>	".1.3.6.1.4.1.318.1.1.4.1.3.0", 
				apc_pdu_firmware_version	=>	".1.3.6.1.4.1.318.1.1.4.1.2.0", 
				apc_pdu_hardware_version	=>	".1.3.6.1.4.1.318.1.1.4.1.1.0", 
				apc_pdu_mac_address		=>	".1.3.6.1.2.1.2.2.1.6.2", 
				apc_pdu_mtu_size		=>	".1.3.6.1.2.1.2.2.1.4.2", 
				apc_pdu_link_speed		=>	".1.3.6.1.2.1.2.2.1.5.2", 
				apc_pdu_phase_count		=>	".1.3.6.1.4.1.318.1.1.12.2.1.2.0", 
				apc_pdu_outlet_count		=>	".1.3.6.1.4.1.318.1.1.4.4.1.0", 
			},
			apc_pdu_phases		=>	{
				# The phase number will be appended to the OID
				apc_pdu_phase_current_amperage	=>	".1.3.6.1.4.1.318.1.1.12.2.3.1.1.2.", 
				apc_pdu_phase_max_amperage	=>	".1.3.6.1.4.1.318.1.1.12.2.1.1.0",
				### NOTE: These aren't recorded, but they are used for alert triggers.
				phase_low_amp_warning		=>	".1.3.6.1.4.1.318.1.1.12.2.2.1.1.2.1",
				# We'll drop these to be at least 2 Amps below max.
				phase_high_amp_warning		=>	".1.3.6.1.4.1.318.1.1.12.2.2.1.1.3.1",
				# If this is less than 'scan-apc-pdu::critical_amps_below_max' below max, it 
				# will be automatically dropped.
				phase_high_amp_critical		=>	".1.3.6.1.4.1.318.1.1.12.2.2.1.1.4.1",
			},
			apc_pdu_outlets		=>	{
				### The outlet number will be appended to all of these OIDs.
				apc_pdu_outlet_name		=>	".1.3.6.1.4.1.318.1.1.4.5.2.1.3.", 
				apc_pdu_outlet_on_phase		=>	".1.3.6.1.4.1.318.1.1.12.3.5.1.1.3.", 
				# read:  1 = on, 2 = off, 4 = unknown
				# write: 1 = on, 2 = off, 3 = cycle
				apc_pdu_outlet_state		=>	".1.3.6.1.4.1.318.1.1.4.4.2.1.3.", 
			},
			apc_pdu_variables	=>	{
				# This is in ticks, so divide the value by 'scan-apc-pdu::ticks_per_second'
				uptime				=>	".1.3.6.1.2.1.1.3.0",
				total_wattage_draw		=>	".1.3.6.1.4.1.318.1.1.12.1.16.0",
			},
		},
		snmp			=>	{
			community		=>	{
				'read'			=>	"public",
				'write'			=>	"private",
			},
		},
	},
});

# Read the config file
$an->Storage->read_conf({file => $an->data->{path}{striker_config}});

# Set some defaults
$an->default_language    ($an->data->{'scan-apc-pdu'}{language});
$an->default_log_language($an->data->{'scan-apc-pdu'}{log_language});
$an->default_log_file    ($an->data->{'scan-apc-pdu'}{log_file});

# Set the log level.
$an->Log->level($an->data->{'scan-apc-pdu'}{log_level});
$an->Log->db_transactions(1) if $an->data->{'scan-apc-pdu'}{log_db_transactions};

# Read in the language strings.
$an->Storage->read_words({file => $an->data->{path}{strings}});
$an->Storage->read_words({file => $an->data->{path}{core_strings}});
$an->Storage->read_words({file => $an->data->{path}{striker_strings}});

# Get the switches before printing anything in case the user is asking for help.
$an->Get->switches();
$an->Log->adjust_log_level({key => $THIS_FILE});

# Help?
if (($an->data->{switches}{h})   or 
    ($an->data->{switches}{'?'}) or
    ($an->data->{switches}{help}))
{
	# Help!
	print_usage($an);
	$an->nice_exit({exit_code => 0});
}

# Exit if we're disabled.
if ($an->data->{'scan-apc-pdu'}{disable})
{
	$an->nice_exit({exit_code => 1});
}

print $an->String->get({key => "scan_apc_pdu_message_0001"})."\n";

# I'll need to loop through the DBs and ensure our schema is loaded for each one.
my $connections = $an->DB->connect_to_databases({file => $THIS_FILE});
$an->Log->entry({ log_level => 3, message_key => "notice_message_0013", message_variables => { connections => $connections }, file => $THIS_FILE, line => __LINE__});

# Make sure this host's UUID is in the 'hosts' table. If the user is running this directly without first
# running ScanCore, it won't be.
if (not $an->DB->verify_host_uuid())
{
	# ScanCore hasn't run, this host isn't in the 'hosts' table.
	$an->Alert->error({title_key => "an_0003", message_key => "scancore_error_0020", message_variables => { uuid => $an->data->{sys}{host_uuid} }, code => 255, file => $THIS_FILE, line => __LINE__});
}

# If we were called with '--prep-db', we'll prep the database schema regardless of whether any pdus are
# found.
if ($an->data->{switches}{'prep-db'})
{
	if ($connections)
	{
		prep_databases($an);
	}
	else
	{
		# Failed
		$an->Log->entry({log_level => 1, message_key => "scancore_warning_0031", file => $THIS_FILE, line => __LINE__});
		print $an->String->get({key => "scancore_warning_0031"})."\n";
	}
}

# Find the PDUs.
find_pdus($an);

# Gather details on PDUs. Returns '1' if no PDUs were found.
if (gather_pdu_data($an))
{
	# No PDUs found.
	$an->Log->entry({log_level => 3, message_key => "scan_apc_pdu_message_0003", file => $THIS_FILE, line => __LINE__});
	$an->nice_exit({exit_code => 1});
}

# Do the loading of the schemas and copying data from more up to date DBs if the DB was loaded.
prep_databases($an);

# Archive, if needed.
archive_if_needed($an);

# Look to see if any databases need to be updated.
update_db($an);

# Look for changes.
find_changes($an);

# Update the database
$an->DB->update_time({file => $THIS_FILE});

# Clean up and go away.
$an->nice_exit({exit_code => 0});

#############################################################################################################
# Functions                                                                                                 #
#############################################################################################################


# This reads in the last scan's data.
sub read_last_scan
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "read_last_scan" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Read in existing data, if any.
	my $query = "
SELECT 
    apc_pdu_uuid, 
    apc_pdu_serial_number, 
    apc_pdu_model_number, 
    apc_pdu_manufacture_date, 
    apc_pdu_firmware_version, 
    apc_pdu_hardware_version, 
    apc_pdu_ipv4_address, 
    apc_pdu_mac_address, 
    apc_pdu_mtu_size, 
    apc_pdu_link_speed, 
    apc_pdu_phase_count, 
    apc_pdu_outlet_count, 
    apc_pdu_note 
FROM 
    apc_pdus 
WHERE 
    apc_pdu_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})."
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query, 
	}, file => $THIS_FILE, line => __LINE__});
	my $results = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__});
	my $count   = @{$results};
	$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
		name1 => "results", value1 => $results, 
		name2 => "count",   value2 => $count
	}, file => $THIS_FILE, line => __LINE__});
	# One or more records were found.
	foreach my $row (@{$results})
	{
		my $apc_pdu_uuid             =         $row->[0];
		my $apc_pdu_serial_number    =         $row->[1];
		my $apc_pdu_model_number     =         $row->[2];
		my $apc_pdu_manufacture_date = defined $row->[3]  ? $row->[3]  : "";
		my $apc_pdu_firmware_version = defined $row->[4]  ? $row->[4]  : "";
		my $apc_pdu_hardware_version = defined $row->[5]  ? $row->[5]  : "";
		my $apc_pdu_ipv4_address     =         $row->[6];
		my $apc_pdu_mac_address      =         $row->[7];
		my $apc_pdu_mtu_size         =         $row->[8];
		my $apc_pdu_link_speed       =         $row->[9];
		my $apc_pdu_phase_count      =         $row->[10];
		my $apc_pdu_outlet_count     =         $row->[11];
		my $apc_pdu_note             = defined $row->[12] ? $row->[12] : "";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0013", message_variables => {
			name1  => "apc_pdu_uuid",             value1  => $apc_pdu_uuid, 
			name2  => "apc_pdu_serial_number",    value2  => $apc_pdu_serial_number, 
			name3  => "apc_pdu_model_number",     value3  => $apc_pdu_model_number, 
			name4  => "apc_pdu_manufacture_date", value4  => $apc_pdu_manufacture_date, 
			name5  => "apc_pdu_firmware_version", value5  => $apc_pdu_firmware_version, 
			name6  => "apc_pdu_hardware_version", value6  => $apc_pdu_hardware_version, 
			name7  => "apc_pdu_ipv4_address",     value7  => $apc_pdu_ipv4_address, 
			name8  => "apc_pdu_mac_address",      value8  => $apc_pdu_mac_address, 
			name9  => "apc_pdu_mtu_size",         value9  => $apc_pdu_mtu_size, 
			name10 => "apc_pdu_link_speed",       value10 => $apc_pdu_link_speed, 
			name11 => "apc_pdu_phase_count",      value11 => $apc_pdu_phase_count, 
			name12 => "apc_pdu_outlet_count",     value12 => $apc_pdu_outlet_count, 
			name13 => "apc_pdu_note",             value13 => $apc_pdu_note, 
		}, file => $THIS_FILE, line => __LINE__});
		
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_uuid}             = $apc_pdu_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_model_number}     = $apc_pdu_model_number;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_manufacture_date} = $apc_pdu_manufacture_date;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_firmware_version} = $apc_pdu_firmware_version;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_hardware_version} = $apc_pdu_hardware_version;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_ipv4_address}     = $apc_pdu_ipv4_address;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mac_address}      = $apc_pdu_mac_address;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mtu_size}         = $apc_pdu_mtu_size;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_link_speed}       = $apc_pdu_link_speed;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_phase_count}      = $apc_pdu_phase_count;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_outlet_count}     = $apc_pdu_outlet_count;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_note}             = $apc_pdu_note;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0012", message_variables => {
			name1  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_uuid",             value1  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_uuid}, 
			name2  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_model_number",     value2  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_model_number}, 
			name3  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_manufacture_date", value3  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_manufacture_date}, 
			name4  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_firmware_version", value4  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_firmware_version}, 
			name5  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_hardware_version", value5  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_hardware_version}, 
			name6  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_ipv4_address",     value6  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_ipv4_address}, 
			name7  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_mac_address",      value7  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mac_address}, 
			name8  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_mtu_size",         value8  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mtu_size}, 
			name9  => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_link_speed",       value9  => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_link_speed}, 
			name10 => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_phase_count",      value10 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_phase_count}, 
			name11 => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_outlet_count",     value11 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_outlet_count}, 
			name12 => "sql::${apc_pdu_serial_number}::apc_pdus::apc_pdu_note",             value12 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_note}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Create a map from UUID to SN
		$an->data->{uuid_to_serial}{$apc_pdu_uuid} = $apc_pdu_serial_number;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "uuid_to_serial::$apc_pdu_uuid", value1 => $an->data->{uuid_to_serial}{$apc_pdu_uuid}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	undef $results;
	
	# Read in the phase data
	$query = "
SELECT 
    apc_pdu_phase_uuid, 
    apc_pdu_phase_apc_pdu_uuid,
    apc_pdu_phase_number, 
    apc_pdu_phase_current_amperage, 
    apc_pdu_phase_max_amperage, 
    apc_pdu_phase_note 
FROM 
    apc_pdu_phases 
WHERE 
    apc_pdu_phase_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	
	# Do the query against the source DB and loop through the results.
	$results = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__});
	$count   = @{$results};
	$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
		name1 => "results", value1 => $results, 
		name2 => "count",   value2 => $count
	}, file => $THIS_FILE, line => __LINE__});
	foreach my $row (@{$results})
	{
		my $apc_pdu_phase_uuid             =         $row->[0];
		my $apc_pdu_phase_apc_pdu_uuid     =         $row->[1];
		my $apc_pdu_phase_number           =         $row->[2];
		my $apc_pdu_phase_current_amperage =         $row->[3];
		my $apc_pdu_phase_max_amperage     = defined $row->[4] ? $row->[4] : "";
		my $apc_pdu_phase_note             = defined $row->[5] ? $row->[5] : "";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0006", message_variables => {
			name1 => "apc_pdu_phase_uuid",             value1 => $apc_pdu_phase_uuid, 
			name2 => "apc_pdu_phase_apc_pdu_uuid",     value2 => $apc_pdu_phase_apc_pdu_uuid, 
			name3 => "apc_pdu_phase_number",           value3 => $apc_pdu_phase_number, 
			name4 => "apc_pdu_phase_current_amperage", value4 => $apc_pdu_phase_current_amperage, 
			name5 => "apc_pdu_phase_max_amperage",     value5 => $apc_pdu_phase_max_amperage, 
			name6 => "apc_pdu_phase_note",             value6 => $apc_pdu_phase_note, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Which serial number does this phase belong to?
		my $apc_pdu_serial_number = $an->data->{uuid_to_serial}{$apc_pdu_phase_apc_pdu_uuid};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "apc_pdu_serial_number", value1 => $apc_pdu_serial_number, 
		}, file => $THIS_FILE, line => __LINE__});
		
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_uuid}             = $apc_pdu_phase_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_apc_pdu_uuid}     = $apc_pdu_phase_apc_pdu_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage} = $apc_pdu_phase_current_amperage;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_max_amperage}     = $apc_pdu_phase_max_amperage;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_note}             = $apc_pdu_phase_note;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0005", message_variables => {
			name1 => "sql::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_uuid",             value1 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_uuid}, 
			name2 => "sql::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_apc_pdu_uuid",     value2 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_apc_pdu_uuid}, 
			name3 => "sql::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_current_amperage", value3 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage}, 
			name4 => "sql::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_max_amperage",     value4 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_max_amperage}, 
			name5 => "sql::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_note",             value5 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_note}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	undef $results;
	
	# Read in the outlets.
	$query = "
SELECT 
    apc_pdu_outlet_uuid, 
    apc_pdu_outlet_apc_pdu_uuid,
    apc_pdu_outlet_number, 
    apc_pdu_outlet_name, 
    apc_pdu_outlet_on_phase, 
    apc_pdu_outlet_state, 
    apc_pdu_outlet_note 
FROM 
    apc_pdu_outlets 
WHERE 
    apc_pdu_outlet_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	
	$results = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__});
	$count   = @{$results};
	$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
		name1 => "results", value1 => $results, 
		name2 => "count",   value2 => $count
	}, file => $THIS_FILE, line => __LINE__});
	foreach my $row (@{$results})
	{
		my $apc_pdu_outlet_uuid         =         $row->[0];
		my $apc_pdu_outlet_apc_pdu_uuid =         $row->[1];
		my $apc_pdu_outlet_number       =         $row->[2];
		my $apc_pdu_outlet_name         = defined $row->[3] ? $row->[3] : "";
		my $apc_pdu_outlet_on_phase     =         $row->[4];
		my $apc_pdu_outlet_state        =         $row->[5];
		my $apc_pdu_outlet_note         = defined $row->[6] ? $row->[6] : "";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0007", message_variables => {
			name1 => "apc_pdu_outlet_uuid",         value1 => $apc_pdu_outlet_uuid, 
			name2 => "apc_pdu_outlet_apc_pdu_uuid", value2 => $apc_pdu_outlet_apc_pdu_uuid, 
			name3 => "apc_pdu_outlet_number",       value3 => $apc_pdu_outlet_number, 
			name4 => "apc_pdu_outlet_name",         value4 => $apc_pdu_outlet_name, 
			name5 => "apc_pdu_outlet_on_phase",     value5 => $apc_pdu_outlet_on_phase, 
			name6 => "apc_pdu_outlet_state",        value6 => $apc_pdu_outlet_state, 
			name7 => "apc_pdu_outlet_note",         value7 => $apc_pdu_outlet_note, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Which serial number does this phase belong to?
		my $apc_pdu_serial_number = $an->data->{uuid_to_serial}{$apc_pdu_outlet_apc_pdu_uuid};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "apc_pdu_serial_number", value1 => $apc_pdu_serial_number, 
		}, file => $THIS_FILE, line => __LINE__});
		
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_uuid}         = $apc_pdu_outlet_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_apc_pdu_uuid} = $apc_pdu_outlet_apc_pdu_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name}         = $apc_pdu_outlet_name;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase}     = $apc_pdu_outlet_on_phase;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}        = $apc_pdu_outlet_state;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_note}         = $apc_pdu_outlet_note;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0006", message_variables => {
			name1 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_uuid",         value1 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_uuid}, 
			name2 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_apc_pdu_uuid", value2 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_apc_pdu_uuid}, 
			name3 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_name",         value3 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name}, 
			name4 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_on_phase",     value4 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase}, 
			name5 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_state",        value5 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}, 
			name6 => "sql::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_note",         value6 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_note}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	undef $results;
	
	# Read in the history schema
	$query = "
SELECT 
    apc_pdu_variable_uuid, 
    apc_pdu_variable_apc_pdu_uuid,
    apc_pdu_variable_is_temperature, 
    apc_pdu_variable_name, 
    apc_pdu_variable_value 
FROM 
    apc_pdu_variables 
WHERE 
    apc_pdu_variable_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	
	$results = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__});
	$count   = @{$results};
	$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
		name1 => "results", value1 => $results, 
		name2 => "count",   value2 => $count
	}, file => $THIS_FILE, line => __LINE__});
	foreach my $row (@{$results})
	{
		my $apc_pdu_variable_uuid           =         $row->[0];
		my $apc_pdu_variable_apc_pdu_uuid   =         $row->[1];
		my $apc_pdu_variable_is_temperature =         $row->[2];
		my $apc_pdu_variable_name           =         $row->[3];
		my $apc_pdu_variable_value          = defined $row->[4] ? $row->[4] : "NULL";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0005", message_variables => {
			name1 => "apc_pdu_variable_uuid",           value1 => $apc_pdu_variable_uuid, 
			name2 => "apc_pdu_variable_apc_pdu_uuid",   value2 => $apc_pdu_variable_apc_pdu_uuid, 
			name3 => "apc_pdu_variable_is_temperature", value3 => $apc_pdu_variable_is_temperature, 
			name4 => "apc_pdu_variable_name",           value4 => $apc_pdu_variable_name, 
			name5 => "apc_pdu_variable_value",          value5 => $apc_pdu_variable_value, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Which serial number does this phase belong to?
		my $apc_pdu_serial_number = $an->data->{uuid_to_serial}{$apc_pdu_variable_apc_pdu_uuid};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "apc_pdu_serial_number", value1 => $apc_pdu_serial_number, 
		}, file => $THIS_FILE, line => __LINE__});
		
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_uuid}           = $apc_pdu_variable_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_apc_pdu_uuid}   = $apc_pdu_variable_apc_pdu_uuid;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_is_temperature} = $apc_pdu_variable_is_temperature;
		$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_value}          = $apc_pdu_variable_value;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
			name1 => "sql::${apc_pdu_serial_number}::apc_pdu_variables::${apc_pdu_variable_name}::apc_pdu_variable_uuid",           value1 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_uuid}, 
			name2 => "sql::${apc_pdu_serial_number}::apc_pdu_variables::${apc_pdu_variable_name}::apc_pdu_variable_apc_pdu_uuid",   value2 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_apc_pdu_uuid}, 
			name3 => "sql::${apc_pdu_serial_number}::apc_pdu_variables::${apc_pdu_variable_name}::apc_pdu_variable_is_temperature", value3 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_is_temperature}, 
			name4 => "sql::${apc_pdu_serial_number}::apc_pdu_variables::${apc_pdu_variable_name}::apc_pdu_variable_value",          value4 => $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{$apc_pdu_variable_name}{apc_pdu_variable_value}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	
	return($count);
}

# This reads in the last scan data from one of the databases and compares it against the just-read data. If 
# anything changed, register an alert.
sub find_changes
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "find_changes" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Read the last state of any PDUs we already know about
	read_last_scan($an);
	
	# Loop through each PDU we've seen this pass
	foreach my $apc_pdu_serial_number (sort {$a cmp $b} keys %{$an->data->{pdu}})
	{
		die "No serial number!\n" if not $apc_pdu_serial_number;
		my $pdu_host_name = $an->data->{pdu}{$apc_pdu_serial_number}{pdu_host_name};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "apc_pdu_serial_number", value1 => $apc_pdu_serial_number, 
			name2 => "pdu_host_name",         value2 => $pdu_host_name, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Convert all the long hashes into shorter variables
		my $new_apc_pdu_model_number     = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_model_number};
		my $new_apc_pdu_manufacture_date = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date};
		my $new_apc_pdu_firmware_version = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_firmware_version};
		my $new_apc_pdu_hardware_version = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_hardware_version};
		my $new_apc_pdu_ipv4_address     = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_ipv4_address};
		my $new_apc_pdu_mac_address      = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mac_address};
		my $new_apc_pdu_mtu_size         = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mtu_size};
		my $new_apc_pdu_link_speed       = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_link_speed};
		my $new_apc_pdu_phase_count      = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count};
		my $new_apc_pdu_outlet_count     = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count};
		my $new_uptime                   = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime};
		my $new_total_wattage_draw       = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw};
		my $new_apc_pdu_note             = "";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0014", message_variables => {
			name1  => "apc_pdu_serial_number",        value1  => $apc_pdu_serial_number, 
			name2  => "new_apc_pdu_model_number",     value2  => $new_apc_pdu_model_number, 
			name3  => "new_apc_pdu_manufacture_date", value3  => $new_apc_pdu_manufacture_date, 
			name4  => "new_apc_pdu_firmware_version", value4  => $new_apc_pdu_firmware_version, 
			name5  => "new_apc_pdu_hardware_version", value5  => $new_apc_pdu_hardware_version, 
			name6  => "new_apc_pdu_ipv4_address",     value6  => $new_apc_pdu_ipv4_address, 
			name7  => "new_apc_pdu_mac_address",      value7  => $new_apc_pdu_mac_address, 
			name8  => "new_apc_pdu_mtu_size",         value8  => $new_apc_pdu_mtu_size, 
			name9  => "new_apc_pdu_link_speed",       value9  => $new_apc_pdu_link_speed, 
			name10 => "new_apc_pdu_phase_count",      value10 => $new_apc_pdu_phase_count, 
			name11 => "new_apc_pdu_outlet_count",     value11 => $new_apc_pdu_outlet_count, 
			name12 => "new_apc_pdu_note",             value12 => $new_apc_pdu_note, 
			name13 => "new_uptime",                   value13 => $new_uptime, 
			name14 => "new_total_wattage_draw",       value14 => $new_total_wattage_draw, 
		}, file => $THIS_FILE, line => __LINE__});

		# These are used later for checking the state of the phases. They are not stored in the 
		# database, except for max amps. They should never change.
		my $new_apc_pdu_phase_max_amperage = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum};
		my $new_phase_low_amp_warning      = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning};
		my $new_phase_high_amp_warning     = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning};
		my $new_phase_high_amp_critical    = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
			name1 => "new_apc_pdu_phase_max_amperage", value1 => $new_apc_pdu_phase_max_amperage, 
			name2 => "new_phase_low_amp_warning",      value2 => $new_phase_low_amp_warning, 
			name3 => "new_phase_high_amp_warning",     value3 => $new_phase_high_amp_warning, 
			name4 => "new_phase_high_amp_critical",    value4 => $new_phase_high_amp_critical, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Have I seen this PDU before?
		if (exists $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_uuid})
		{
			# Yup. Search for changes.
			my $apc_pdu_uuid                 = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_uuid};
			my $old_apc_pdu_model_number     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_model_number};
			my $old_apc_pdu_manufacture_date = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_manufacture_date};
			my $old_apc_pdu_firmware_version = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_firmware_version};
			my $old_apc_pdu_hardware_version = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_hardware_version};
			my $old_apc_pdu_ipv4_address     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_ipv4_address};
			my $old_apc_pdu_mac_address      = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mac_address};
			my $old_apc_pdu_mtu_size         = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_mtu_size};
			my $old_apc_pdu_link_speed       = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_link_speed};
			my $old_apc_pdu_phase_count      = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_phase_count};
			my $old_apc_pdu_outlet_count     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_outlet_count};
			my $old_apc_pdu_note             = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_note};
			
			$an->Log->entry({log_level => 3, message_key => "an_variables_0012", message_variables => {
				name1  => "apc_pdu_uuid",                 value1  => $apc_pdu_uuid, 
				name2  => "old_apc_pdu_model_number",     value2  => $old_apc_pdu_model_number, 
				name3  => "old_apc_pdu_manufacture_date", value3  => $old_apc_pdu_manufacture_date, 
				name4  => "old_apc_pdu_firmware_version", value4  => $old_apc_pdu_firmware_version, 
				name5  => "old_apc_pdu_hardware_version", value5  => $old_apc_pdu_hardware_version, 
				name6  => "old_apc_pdu_ipv4_address",     value6  => $old_apc_pdu_ipv4_address, 
				name7  => "old_apc_pdu_mac_address",      value7  => $old_apc_pdu_mac_address, 
				name8  => "old_apc_pdu_mtu_size",         value8  => $old_apc_pdu_mtu_size, 
				name9  => "old_apc_pdu_link_speed",       value9  => $old_apc_pdu_link_speed, 
				name10 => "old_apc_pdu_phase_count",      value10 => $old_apc_pdu_phase_count, 
				name11 => "old_apc_pdu_outlet_count",     value11 => $old_apc_pdu_outlet_count, 
				name12 => "old_apc_pdu_note",             value12 => $old_apc_pdu_note, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Has the phase data changed?
			my $changes = 0;
			if ($old_apc_pdu_note eq "DELETED")
			{
				# It's back.
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0006",
					alert_message_key	=>	"scan_apc_pdu_message_0042",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						model			=>	$new_apc_pdu_model_number,
						serial_number		=>	$apc_pdu_serial_number,
						ip_address		=>	$new_apc_pdu_ipv4_address, 
					},
				});
			}
			if ($new_apc_pdu_model_number ne $old_apc_pdu_model_number)
			{
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0010",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_model_number	=>	$old_apc_pdu_model_number,
						new_model_number	=>	$new_apc_pdu_model_number,
					},
				});
			}
			if ($new_apc_pdu_manufacture_date ne $old_apc_pdu_manufacture_date)
			{
				# Wat?
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0011",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_manufacture_date	=>	$old_apc_pdu_manufacture_date,
						new_manufacture_date	=>	$new_apc_pdu_manufacture_date,
					},
				});
			}
			if ($new_apc_pdu_firmware_version ne $old_apc_pdu_firmware_version)
			{
				# This is about the only thing that should ever change.
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0016",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_firmware_version	=>	$old_apc_pdu_firmware_version,
						new_firmware_version	=>	$new_apc_pdu_firmware_version,
					},
				});
			}
			if ($new_apc_pdu_hardware_version ne $old_apc_pdu_hardware_version)
			{
				# Wat?
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0017",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_hardware_version	=>	$old_apc_pdu_hardware_version,
						new_hardware_version	=>	$new_apc_pdu_hardware_version,
					},
				});
			}
			if ($new_apc_pdu_ipv4_address ne $old_apc_pdu_ipv4_address)
			{
				# This could change, sure.
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0018",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_ipv4_address	=>	$old_apc_pdu_ipv4_address,
						new_ipv4_address	=>	$new_apc_pdu_ipv4_address,
					},
				});
			}
			if ($new_apc_pdu_mac_address ne $old_apc_pdu_mac_address)
			{
				# How?!
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0019",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_mac_address		=>	$old_apc_pdu_mac_address,
						new_mac_address		=>	$new_apc_pdu_mac_address,
					},
				});
			}
			if ($new_apc_pdu_mtu_size ne $old_apc_pdu_mtu_size)
			{
				# OK, maybe...
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0020",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_mtu_size		=>	$old_apc_pdu_mtu_size,
						new_mtu_size		=>	$new_apc_pdu_mtu_size,
					},
				});
			}
			if ($new_apc_pdu_link_speed ne $old_apc_pdu_link_speed)
			{
				# This could happen, too.
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				
				my $say_new_link_speed_hr   = $an->Readable->bytes_to_hr({ 'bytes' => ($new_apc_pdu_link_speed / 8) })."/s";
				my $say_new_link_speed_mbps = ($new_apc_pdu_link_speed / 100000)." Mbps";
				my $say_old_link_speed_hr   = $an->Readable->bytes_to_hr({ 'bytes' => ($old_apc_pdu_link_speed / 8) })."/s";
				my $say_old_link_speed_mbps = ($old_apc_pdu_link_speed / 100000)." Mbps";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
					name1 => "say_new_link_speed_mbps", value1 => $say_new_link_speed_mbps, 
					name2 => "say_new_link_speed_hr",   value2 => $say_new_link_speed_hr, 
					name3 => "say_old_link_speed_mbps", value3 => $say_old_link_speed_mbps, 
					name4 => "say_old_link_speed_hr",   value4 => $say_old_link_speed_hr, 
				}, file => $THIS_FILE, line => __LINE__});
				
				# The speed has changed. Make this a proper warning
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0004",
					alert_message_key	=>	"scan_apc_pdu_message_0022",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_link_speed_mbps	=>	$say_old_link_speed_mbps,
						old_link_speed_hr	=>	$say_old_link_speed_hr,
						new_link_speed_mbps	=>	$say_new_link_speed_mbps,
						new_link_speed_hr	=>	$say_new_link_speed_hr,
					},
				});
			}
			if ($new_apc_pdu_phase_count ne $old_apc_pdu_phase_count)
			{
				# How?!
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0023",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_phase_count		=>	sprintf("%02d", $old_apc_pdu_phase_count),
						new_phase_count		=>	sprintf("%02d", $new_apc_pdu_phase_count),
					},
				});
			}
			if ($new_apc_pdu_outlet_count ne $old_apc_pdu_outlet_count)
			{
				# I don't even...
				$changes = 1;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "changes", value1 => $changes, 
				}, file => $THIS_FILE, line => __LINE__});
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0024",
					alert_message_variables	=>	{
						name			=>	$pdu_host_name,
						old_outlet_count	=>	sprintf("%02d", $old_apc_pdu_outlet_count),
						new_outlet_count	=>	sprintf("%02d", $new_apc_pdu_outlet_count),
					},
				});
			}
			
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "changes", value1 => $changes, 
			}, file => $THIS_FILE, line => __LINE__});
			if ($changes)
			{
				# Save the changes.
				my $query = "
UPDATE 
    public.apc_pdus 
SET
    apc_pdu_serial_number    = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_serial_number).", 
    apc_pdu_model_number     = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_model_number).", 
    apc_pdu_manufacture_date = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_manufacture_date).", 
    apc_pdu_firmware_version = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_firmware_version).", 
    apc_pdu_hardware_version = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_hardware_version).", 
    apc_pdu_ipv4_address     = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_ipv4_address).", 
    apc_pdu_mac_address      = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_mac_address).", 
    apc_pdu_mtu_size         = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_mtu_size).", 
    apc_pdu_link_speed       = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_link_speed).", 
    apc_pdu_phase_count      = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_count).", 
    apc_pdu_outlet_count     = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_outlet_count).", 
    apc_pdu_note             = '', 
    modified_date            = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_uuid             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid)." 
;";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "query", value1 => $query
				}, file => $THIS_FILE, line => __LINE__});
				push @{$an->data->{sys}{sql}}, $query;
			}
			
			### What about other variables?
			# Do I have a previous uptime?
			if ($an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}{apc_pdu_variable_uuid})
			{
				# Exists, change?
				my $apc_pdu_variable_uuid = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}{apc_pdu_variable_uuid};
				my $old_uptime            = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}{apc_pdu_variable_value};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "apc_pdu_variable_uuid", value1 => $apc_pdu_variable_uuid, 
					name2 => "old_uptime",            value2 => $old_uptime, 
				}, file => $THIS_FILE, line => __LINE__});
				
				if ($new_uptime ne $old_uptime)
				{
					update_variables($an, $apc_pdu_uuid, $apc_pdu_variable_uuid, "uptime", $new_uptime);
					
					# We expect this to change. If the new uptime is less than the old 
					# one, it rebooted.
					if ($new_uptime > $old_uptime)
					{
						# Normal, info-level
						$an->Alert->register_alert({
							alert_level		=>	"info", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0002",
							alert_message_key	=>	"scan_apc_pdu_message_0013",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								old_uptime		=>	$an->Readable->time({ 'time' => $old_uptime }),
								new_uptime		=>	$an->Readable->time({ 'time' => $new_uptime }), 
							},
						});
					}
					else
					{
						# It's rebooted. This is notice level as it's generally just 
						# the NIC rebooting and doesn't interfere with power.
						$an->Alert->register_alert({
							alert_level		=>	"notice", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0003",
							alert_message_key	=>	"scan_apc_pdu_message_0014",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								old_uptime		=>	$an->Readable->time({ 'time' => $old_uptime }),
								new_uptime		=>	$an->Readable->time({ 'time' => $new_uptime }), 
							},
						});
					}
				}
			}
			else
			{
				# New, INSERT it (is_temperature is always false for now).
				insert_variables($an, $apc_pdu_uuid, "uptime", $new_uptime);
			}
			
			# Do I have a previous wattage?
			if ($an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw}{apc_pdu_variable_uuid})
			{
				# Exists, change?
				my $apc_pdu_variable_uuid  = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw}{apc_pdu_variable_uuid};
				my $old_total_wattage_draw = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw}{apc_pdu_variable_value};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "apc_pdu_variable_uuid",  value1 => $apc_pdu_variable_uuid, 
					name2 => "old_total_wattage_draw", value2 => $old_total_wattage_draw, 
				}, file => $THIS_FILE, line => __LINE__});
				
				if ($new_total_wattage_draw ne $old_total_wattage_draw)
				{
					update_variables($an, $apc_pdu_uuid, $apc_pdu_variable_uuid, "total_wattage_draw", $new_total_wattage_draw);
					
					# We expect this to change. 
					$an->Alert->register_alert({
						alert_level		=>	"info", 
						alert_sort		=>	$an->data->{sys}{alert_sort}++,
						alert_agent_name	=>	$THIS_FILE,
						alert_title_key		=>	"an_alert_title_0002",
						alert_message_key	=>	"scan_apc_pdu_message_0015",
						alert_message_variables	=>	{
							name			=>	$pdu_host_name,
							old_total_wattage_draw	=>	$old_total_wattage_draw,
							new_total_wattage_draw	=>	$new_total_wattage_draw, 
						},
					});
				}
			}
			else
			{
				# New, INSERT it (is_temperature is always false for now).
				insert_variables($an, $apc_pdu_uuid, "total_wattage_draw", $new_total_wattage_draw);
			}
			
			# Have any phases changed?
			foreach my $apc_pdu_phase_number (sort {$a cmp $b} keys %{$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}})
			{
				my $new_apc_pdu_phase_current_amperage = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage};
				my $new_apc_pdu_phase_note             = "";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
					name1 => "apc_pdu_phase_number",               value1 => $apc_pdu_phase_number, 
					name2 => "new_apc_pdu_phase_current_amperage", value2 => $new_apc_pdu_phase_current_amperage, 
					name3 => "new_apc_pdu_phase_max_amperage",     value3 => $new_apc_pdu_phase_max_amperage, 
				}, file => $THIS_FILE, line => __LINE__});
				
				if ($an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_uuid})
				{
					# We've seen this phase before. Changes?
					my $apc_pdu_phase_uuid                 = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_uuid};
					my $old_apc_pdu_phase_apc_pdu_uuid     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_apc_pdu_uuid};
					my $old_apc_pdu_phase_current_amperage = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage};
					my $old_apc_pdu_phase_max_amperage     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_max_amperage};
					my $old_apc_pdu_phase_note             = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_note};
					$an->Log->entry({log_level => 3, message_key => "an_variables_0005", message_variables => {
						name1 => "apc_pdu_phase_uuid",                 value1 => $apc_pdu_phase_uuid, 
						name2 => "old_apc_pdu_phase_apc_pdu_uuid",     value2 => $old_apc_pdu_phase_apc_pdu_uuid, 
						name3 => "old_apc_pdu_phase_current_amperage", value3 => $old_apc_pdu_phase_current_amperage, 
						name4 => "old_apc_pdu_phase_max_amperage",     value4 => $old_apc_pdu_phase_max_amperage, 
						name5 => "old_apc_pdu_phase_note",             value5 => $old_apc_pdu_phase_note, 
					}, file => $THIS_FILE, line => __LINE__});
					
					# The max amps per phase is set across all phases. 
					if ($new_apc_pdu_phase_max_amperage ne $old_apc_pdu_phase_max_amperage)
					{
						# This should never change, but OK, whatever
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0004",
							alert_message_key	=>	"scan_apc_pdu_message_0025",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								phase			=>	sprintf("%02d", $apc_pdu_phase_number),
								old_phase_max_amperage	=>	$old_apc_pdu_phase_max_amperage,
								new_phase_max_amperage	=>	$new_apc_pdu_phase_max_amperage,
							},
						});
					}
					if ($old_apc_pdu_phase_current_amperage ne $new_apc_pdu_phase_current_amperage)
					{
						# The phase amperage can change all the time.
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"info", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0002",
							alert_message_key	=>	"scan_apc_pdu_message_0026",
							alert_message_variables	=>	{
								name				=>	$pdu_host_name,
								phase				=>	sprintf("%02d", $apc_pdu_phase_number),
								old_phase_current_amperage	=>	$old_apc_pdu_phase_current_amperage,
								new_phase_current_amperage	=>	$new_apc_pdu_phase_current_amperage, 
							},
						});
					}
					
					# If the note was 'DELETED', the phase has returned.
					if ($old_apc_pdu_phase_note eq "DELETED")
					{
						# The phase amperage can change all the time.
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0006",
							alert_message_key	=>	"scan_apc_pdu_message_0027",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								phase			=>	sprintf("%02d", $apc_pdu_phase_number),
							},
						});
					}
					
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "changes", value1 => $changes, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($changes)
					{
						my $query = "
UPDATE 
    apc_pdu_phases 
SET
    apc_pdu_phase_apc_pdu_uuid     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).",
    apc_pdu_phase_number           = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_number).", 
    apc_pdu_phase_current_amperage = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_current_amperage).", 
    apc_pdu_phase_max_amperage     = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_max_amperage).", 
    apc_pdu_phase_note             = ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_note).", 
    modified_date                  = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_phase_uuid             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid)." 
;";
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "query", value1 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{sys}{sql}}, $query;
					}
					
					# Cheack for low alerts to set or high alerts to clear
					if ($new_apc_pdu_phase_current_amperage < $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning})
					{
						# Dropped too low, clear high warn and high crit
						set_phase_low_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
						
						# Clear the high-warning and high-critical, if needed.
						clear_phase_high_critical($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
						clear_phase_high_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
					elsif ($new_apc_pdu_phase_current_amperage < $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_warning})
					{
						# Dropped low enough to clear high warn and high crit
						clear_phase_high_critical($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
						clear_phase_high_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
					elsif ($new_apc_pdu_phase_current_amperage < $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_critical})
					{
						# Dropped low enough to clear high crit.
						clear_phase_high_critical($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
					
					# Cheack for low alerts to clear or high alerts to set
					if ($new_apc_pdu_phase_current_amperage > $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical})
					{
						# Set high crit, clear low warn
						set_phase_high_critical($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
						clear_phase_low_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
					elsif ($new_apc_pdu_phase_current_amperage > $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning})
					{
						# Set high warn
						set_phase_high_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
						clear_phase_low_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
					elsif ($new_apc_pdu_phase_current_amperage > $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_low_warning})
					{
						# Clear the low warning
						clear_phase_low_warning($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number);
					}
				}
				
				delete $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number};
			}
			
			# Any phases that vanished?
			foreach my $apc_pdu_phase_number (sort {$a cmp $b} keys %{$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}})
			{
				# Did it just vanish?
				my $apc_pdu_phase_uuid = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_uuid};
				my $apc_pdu_phase_note = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_note};
				$an->Log->entry({log_level => 2, message_key => "an_variables_0002", message_variables => {
					name1 => "apc_pdu_phase_uuid", value1 => $apc_pdu_phase_uuid, 
					name2 => "apc_pdu_phase_note", value2 => $apc_pdu_phase_note, 
				}, file => $THIS_FILE, line => __LINE__});
				if ($apc_pdu_phase_note ne "DELETED")
				{
					# Yup
					my $query = "
UPDATE 
    apc_pdu_phases 
SET 
    apc_pdu_phase_note = 'DELETED', 
    modified_date      = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_phase_uuid = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid)." 
;";
					$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
						name1 => "query", value1 => $query, 
					}, file => $THIS_FILE, line => __LINE__});
					push @{$an->data->{sys}{sql}}, $query;

					$an->Alert->register_alert({
						alert_level		=>	"warning", 
						alert_sort		=>	$an->data->{sys}{alert_sort}++,
						alert_agent_name	=>	$THIS_FILE,
						alert_title_key		=>	"an_alert_title_0004",
						alert_message_key	=>	"scan_apc_pdu_message_0028",
						alert_message_variables	=>	{
							name			=>	$pdu_host_name,
							phase			=>	sprintf("%02d", $apc_pdu_phase_number),
						},
					});
				}
			}
			
			# Have any outlets changed?
			foreach my $apc_pdu_outlet_number (sort {$a cmp $b} keys %{$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}})
			{
				my $new_apc_pdu_outlet_name     = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name};
				my $new_apc_pdu_outlet_on_phase = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase};
				my $new_apc_pdu_outlet_state    = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state};
				my $new_apc_pdu_outlet_note     = "";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
					name1 => "new_apc_pdu_outlet_name",     value1 => $new_apc_pdu_outlet_name,
					name2 => "new_apc_pdu_outlet_on_phase", value2 => $new_apc_pdu_outlet_on_phase,
					name3 => "new_apc_pdu_outlet_state",    value3 => $new_apc_pdu_outlet_state,
				}, file => $THIS_FILE, line => __LINE__});
				
				# Do I know about this outlet?
				if ($an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_uuid})
				{
					# Yup!
					my $apc_pdu_outlet_uuid         = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_uuid};
					my $old_apc_pdu_outlet_note     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_note};
					my $old_apc_pdu_outlet_name     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name};
					my $old_apc_pdu_outlet_on_phase = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase};
					my $old_apc_pdu_outlet_state    = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state};
					$an->Log->entry({log_level => 3, message_key => "an_variables_0005", message_variables => {
						name1 => "apc_pdu_outlet_uuid",         value1 => $apc_pdu_outlet_uuid, 
						name2 => "old_apc_pdu_outlet_name",     value2 => $old_apc_pdu_outlet_name,
						name3 => "old_apc_pdu_outlet_on_phase", value3 => $old_apc_pdu_outlet_on_phase,
						name4 => "old_apc_pdu_outlet_state",    value4 => $old_apc_pdu_outlet_state,
						name5 => "old_apc_pdu_outlet_note",     value5 => $old_apc_pdu_outlet_note,
					}, file => $THIS_FILE, line => __LINE__});
					
					# Did a vanished outlet come back?
					my $changes = 0;
					if ($old_apc_pdu_outlet_note eq "DELETED")
					{
						# It's back!
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0004",
							alert_message_key	=>	"scan_apc_pdu_message_0037",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
							},
						});
					}
					if ($new_apc_pdu_outlet_name ne $old_apc_pdu_outlet_name)
					{
						# Name changed.
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0004",
							alert_message_key	=>	"scan_apc_pdu_message_0038",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
								old_outlet_name		=>	$old_apc_pdu_outlet_name,
								new_outlet_name		=>	$new_apc_pdu_outlet_name,
							},
						});
					}
					if ($new_apc_pdu_outlet_on_phase ne $old_apc_pdu_outlet_on_phase)
					{
						# Phase changed, but why tho?
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0004",
							alert_message_key	=>	"scan_apc_pdu_message_0039",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
								old_outlet_on_phase	=>	$old_apc_pdu_outlet_on_phase,
								new_outlet_on_phase	=>	$new_apc_pdu_outlet_on_phase,
							},
						});
					}
					if ($new_apc_pdu_outlet_state ne $old_apc_pdu_outlet_state)
					{
						# This is likely from a fence action, so we make it critical
						$changes = 1;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "changes", value1 => $changes, 
						}, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"critical", 
							alert_sort		=>	$an->data->{sys}{alert_sort}++,
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0005",
							alert_message_key	=>	"scan_apc_pdu_message_0040",
							alert_message_variables	=>	{
								name			=>	$pdu_host_name,
								outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
								old_outlet_state	=>	$old_apc_pdu_outlet_state,
								new_outlet_state	=>	$new_apc_pdu_outlet_state,
							},
						});
					}
					
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "changes", value1 => $changes, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($changes)
					{
						# Save.
						update_outlets($an, $apc_pdu_uuid, $apc_pdu_outlet_uuid, $apc_pdu_outlet_number, $new_apc_pdu_outlet_name, $new_apc_pdu_outlet_on_phase, $new_apc_pdu_outlet_state, $new_apc_pdu_outlet_note);
					}
					
					delete $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number};
				}
				else
				{
					# Nope, INSERT it.
					insert_outlets($an, $apc_pdu_uuid, $apc_pdu_outlet_number, $new_apc_pdu_outlet_name, $new_apc_pdu_outlet_on_phase, $new_apc_pdu_outlet_state, "");
					
					my $say_state = "#!string!an_state_0001!#";
					if ($new_apc_pdu_outlet_state eq "on")
					{
						
						$say_state = "#!string!an_state_0005!#";
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "new_apc_pdu_outlet_state", value1 => $new_apc_pdu_outlet_state, 
						}, file => $THIS_FILE, line => __LINE__});
					}
					elsif ($new_apc_pdu_outlet_state eq "off")
					{
						$say_state = "#!string!an_state_0006!#";
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "new_apc_pdu_outlet_state", value1 => $new_apc_pdu_outlet_state, 
						}, file => $THIS_FILE, line => __LINE__});
					}
					$an->Alert->register_alert({
						alert_level		=>	"warning", 
						alert_sort		=>	$an->data->{sys}{alert_sort}++,
						alert_agent_name	=>	$THIS_FILE,
						alert_title_key		=>	"an_alert_title_0008",
						alert_message_key	=>	"scan_apc_pdu_message_0036",
						alert_message_variables	=>	{
							pdu_name		=>	$pdu_host_name, 
							outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
							'state'			=>	$say_state,
							on_phase		=>	sprintf("%02d", $new_apc_pdu_outlet_on_phase),
							name			=>	$new_apc_pdu_outlet_name,
						},
					});
				}
			}
			
			# Any outlets vanished?
			foreach my $apc_pdu_outlet_number (sort {$a cmp $b} keys %{$an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}})
			{
				# Lost, update the note.
				my $apc_pdu_outlet_uuid     = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_uuid};
				my $old_apc_pdu_outlet_note = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_note};
				my $old_apc_pdu_outlet_name = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
					name1 => "apc_pdu_outlet_uuid",     value1 => $apc_pdu_outlet_uuid, 
					name2 => "old_apc_pdu_outlet_name", value2 => $old_apc_pdu_outlet_name,
					name3 => "old_apc_pdu_outlet_note", value3 => $old_apc_pdu_outlet_note,
				}, file => $THIS_FILE, line => __LINE__});
				
				if ($old_apc_pdu_outlet_note ne "DELETED")
				{
					# Yup
					my $query = "
UPDATE 
    apc_pdu_outlets 
SET 
    apc_pdu_outlet_value = 'DELETED', 
    modified_date        = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_outlet_uuid  = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid)." 
;";
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "query", value1 => $query
					}, file => $THIS_FILE, line => __LINE__});
					push @{$an->data->{sys}{sql}}, $query;

					$an->Alert->register_alert({
						alert_level		=>	"warning", 
						alert_sort		=>	$an->data->{sys}{alert_sort}++,
						alert_agent_name	=>	$THIS_FILE,
						alert_title_key		=>	"an_alert_title_0004",
						alert_message_key	=>	"scan_apc_pdu_message_0035",
						alert_message_variables	=>	{
							name			=>	$pdu_host_name,
							outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
						},
					});
				}
			}
			
			# Delete this from the SQL history 
			delete $an->data->{sql}{$apc_pdu_serial_number};
		}
		else
		{
			# OK, now INSERT it.
			my $apc_pdu_uuid = $an->Get->uuid() or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0024", code => 2, file => $THIS_FILE, line => __LINE__});
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "apc_pdu_uuid", value1 => $apc_pdu_uuid, 
			}, file => $THIS_FILE, line => __LINE__});
			
			my $query = "
INSERT INTO 
    apc_pdus
(
    apc_pdu_host_uuid, 
    apc_pdu_uuid, 
    apc_pdu_serial_number, 
    apc_pdu_model_number, 
    apc_pdu_manufacture_date, 
    apc_pdu_firmware_version, 
    apc_pdu_hardware_version, 
    apc_pdu_ipv4_address, 
    apc_pdu_mac_address, 
    apc_pdu_mtu_size, 
    apc_pdu_link_speed, 
    apc_pdu_phase_count, 
    apc_pdu_outlet_count, 
    apc_pdu_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_serial_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_model_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_manufacture_date).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_firmware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_hardware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_ipv4_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_mac_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_mtu_size).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_link_speed).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_outlet_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
);";
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "query", value1 => $query
			}, file => $THIS_FILE, line => __LINE__});
			push @{$an->data->{sys}{sql}}, $query;
			
			# Send an alert telling the user about this new PDU.
			my $say_link_speed_hr   = "#!string!scan_apc_pdu_message_0006!#";	# "Down"
			my $say_link_speed_mbps = "#!string!scan_apc_pdu_message_0006!#";	# "Down"
			if (($new_apc_pdu_link_speed) && ($new_apc_pdu_link_speed =~ /^\d+$/))
			{
				$say_link_speed_hr   = $an->Readable->bytes_to_hr({ 'bytes' => ($new_apc_pdu_link_speed / 8) })."/s";
				$say_link_speed_mbps = ($new_apc_pdu_link_speed / 1000000)." Mbps";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "say_link_speed_hr",   value1 => $say_link_speed_hr, 
					name2 => "say_link_speed_mbps", value2 => $say_link_speed_mbps, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			$an->Alert->register_alert({
				alert_level		=>	"warning", 
				alert_sort		=>	$an->data->{sys}{alert_sort}++,
				alert_agent_name	=>	$THIS_FILE,
				alert_title_key		=>	"an_alert_title_0008",
				alert_message_key	=>	"scan_apc_pdu_message_0007",
				alert_message_variables	=>	{
					name			=>	$pdu_host_name,
					serial_number		=>	$apc_pdu_serial_number,
					model_number		=>	$new_apc_pdu_model_number,
					manufacture_date	=>	$new_apc_pdu_manufacture_date." #!string!tools_suffix_0082!#",
					firmware_version	=>	$new_apc_pdu_firmware_version,
					hardware_version	=>	$new_apc_pdu_hardware_version,
					ipv4_address		=>	$new_apc_pdu_ipv4_address,
					mac_address		=>	$new_apc_pdu_mac_address,
					mtu_size		=>	$new_apc_pdu_mtu_size,
					link_speed_hr		=>	$say_link_speed_hr,
					link_speed_mbps		=>	$say_link_speed_mbps,
					phase_count		=>	$new_apc_pdu_phase_count,
					outlet_count		=>	$new_apc_pdu_outlet_count,
					phase_max_amperage	=>	$new_apc_pdu_phase_max_amperage,
					phase_low_amp_warning	=>	$new_phase_low_amp_warning,
					phase_high_amp_warning	=>	$new_phase_high_amp_warning,
					phase_high_amp_critical	=>	$new_phase_high_amp_critical,
					uptime			=>	$an->Readable->time({'time' => $new_uptime}), 
					total_wattage_draw	=>	$new_total_wattage_draw, 
				},
			});
			
			# Record the variables (uptime and wattage)
			foreach my $variable (sort {$a cmp $b} keys %{$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}})
			{
				my $value = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{$variable};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "variable", value1 => $variable, 
					name2 => "value",    value2 => $value, 
				}, file => $THIS_FILE, line => __LINE__});
				
				insert_variables($an, $apc_pdu_uuid, $variable, $value);
				
				# NOTE: We don't send an alert here as we incorporated the two variables we care about above.
			}
			
			# Insert the phase data
			foreach my $apc_pdu_phase_number (sort {$a cmp $b} keys %{$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}})
			{
				my $apc_pdu_phase_uuid                 = $an->Get->uuid() or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0024", code => 2, file => $THIS_FILE, line => __LINE__});
				my $new_apc_pdu_phase_current_amperage = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "apc_pdu_phase_uuid",                 value1 => $apc_pdu_phase_uuid, 
					name2 => "new_apc_pdu_phase_current_amperage", value2 => $new_apc_pdu_phase_current_amperage,
				}, file => $THIS_FILE, line => __LINE__});
				
				my $query = "
INSERT INTO 
    apc_pdu_phases 
(
    apc_pdu_phase_host_uuid, 
    apc_pdu_phase_uuid, 
    apc_pdu_phase_apc_pdu_uuid, 
    apc_pdu_phase_number, 
    apc_pdu_phase_current_amperage, 
    apc_pdu_phase_max_amperage, 
    apc_pdu_phase_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_current_amperage).", 
    ".$an->data->{sys}{use_db_fh}->quote($new_apc_pdu_phase_max_amperage).", 
    '', 
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
);";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "query", value1 => $query
				}, file => $THIS_FILE, line => __LINE__});
				push @{$an->data->{sys}{sql}}, $query;
				
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_header		=>	"FALSE",
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0008",
					alert_message_variables	=>	{
						phase			=>	sprintf("%02d", $apc_pdu_phase_number),
						amps			=>	$new_apc_pdu_phase_current_amperage,
					},
				});
			}
			
			# Insert the outlet data
			foreach my $apc_pdu_outlet_number (sort {$a cmp $b} keys %{$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}})
			{
				my $apc_pdu_outlet_uuid         = $an->Get->uuid() or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0024", code => 2, file => $THIS_FILE, line => __LINE__});
				my $new_apc_pdu_outlet_name     = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name};
				my $new_apc_pdu_outlet_on_phase = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase};
				my $new_apc_pdu_outlet_state    = $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
					name1 => "apc_pdu_outlet_uuid",         value1 => $apc_pdu_outlet_uuid, 
					name2 => "new_apc_pdu_outlet_name",     value2 => $new_apc_pdu_outlet_name,
					name3 => "new_apc_pdu_outlet_on_phase", value3 => $new_apc_pdu_outlet_on_phase,
					name4 => "new_apc_pdu_outlet_state",    value4 => $new_apc_pdu_outlet_state,
				}, file => $THIS_FILE, line => __LINE__});
				
				insert_outlets($an, $apc_pdu_uuid, $apc_pdu_outlet_number, $new_apc_pdu_outlet_name, $new_apc_pdu_outlet_on_phase, $new_apc_pdu_outlet_state, "");
				
				my $say_state = "#!string!an_state_0001!#";
				if ($new_apc_pdu_outlet_state eq "on")
				{
					
					$say_state = "#!string!an_state_0005!#";
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "new_apc_pdu_outlet_state", value1 => $new_apc_pdu_outlet_state, 
					}, file => $THIS_FILE, line => __LINE__});
				}
				elsif ($new_apc_pdu_outlet_state eq "off")
				{
					$say_state = "#!string!an_state_0006!#";
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "new_apc_pdu_outlet_state", value1 => $new_apc_pdu_outlet_state, 
					}, file => $THIS_FILE, line => __LINE__});
				}
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_sort		=>	$an->data->{sys}{alert_sort}++,
					alert_header		=>	"FALSE",
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0008",
					alert_message_key	=>	"scan_apc_pdu_message_0009",
					alert_message_variables	=>	{
						outlet			=>	sprintf("%02d", $apc_pdu_outlet_number),
						'state'			=>	$say_state,
						on_phase		=>	sprintf("%02d", $new_apc_pdu_outlet_on_phase),
						name			=>	$new_apc_pdu_outlet_name,
					},
				});
			}
		}
	}
	
	# Look for PDUs that we saw before that are gone now.
	foreach my $apc_pdu_serial_number (sort {$a cmp $b} keys %{$an->data->{sql}})
	{
		# Gone! Is this the first time it's disappeared?
		my $apc_pdu_uuid         = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_uuid};
		my $apc_pdu_note         = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_note};
		my $apc_pdu_model_number = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_model_number};
		my $apc_pdu_ipv4_address = $an->data->{sql}{$apc_pdu_serial_number}{apc_pdus}{apc_pdu_ipv4_address};
		$an->Log->entry({log_level => 2, message_key => "an_variables_0006", message_variables => {
			name1 => "apc_pdu_serial_number",              value1 => $apc_pdu_serial_number, 
			name2 => "apc_pdu_uuid",                       value2 => $apc_pdu_uuid,
			name3 => "apc_pdu_note",                       value3 => $apc_pdu_note,
			name4 => "apc_pdu_model_number",               value4 => $apc_pdu_model_number,
			name5 => "apc_pdu_ipv4_address",               value5 => $apc_pdu_ipv4_address,
			name6 => "dont_delete::$apc_pdu_ipv4_address", value6 => $apc_pdu_ipv4_address,
		}, file => $THIS_FILE, line => __LINE__});
		
		# Skip a PDU that just recently went missing 
		next if $an->data->{dont_delete}{$apc_pdu_ipv4_address};
		
		if ($apc_pdu_note ne "DELETED")
		{
			# Yup! send an alert.
			my $query = "
UPDATE 
    apc_pdus 
SET 
    apc_pdu_note  = 'DELETED', 
    modified_date = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_uuid  = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid)." 
;";
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "query", value1 => $query
			}, file => $THIS_FILE, line => __LINE__});
			push @{$an->data->{sys}{sql}}, $query;

			$an->Alert->register_alert({
				alert_level		=>	"warning", 
				alert_sort		=>	$an->data->{sys}{alert_sort}++,
				alert_agent_name	=>	$THIS_FILE,
				alert_title_key		=>	"an_alert_title_0004",
				alert_message_key	=>	"scan_apc_pdu_message_0041",
				alert_message_variables	=>	{
					model			=>	$apc_pdu_model_number,
					serial_numer		=>	$apc_pdu_serial_number,
					ip_address		=>	$apc_pdu_ipv4_address,
				},
			});
		}
	}
	
	# Commit the queries.
	$an->DB->commit_sql({source => $THIS_FILE, line => __LINE__});
	
	return(0);
}

# Set the phase-low alert, if not set before
sub set_phase_low_warning
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "set_phase_low_warning" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $set = $an->Alert->check_alert_sent({
		type			=>	"warning",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_low_warning",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "set", value1 => $set, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($set)
	{
		# This is a new loss of comms.
		$an->Alert->register_alert({
			alert_level		=>	"warning", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0004",
			alert_message_key	=>	"scan_apc_pdu_message_0029",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0);
}

# Set the phase-low alert, if not clear before
sub clear_phase_low_warning
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "clear_phase_low_warning" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $clear = $an->Alert->check_alert_sent({
		type			=>	"clear",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_low_warning",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "clear", value1 => $clear, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($clear)
	{
		# This is a new loss of comms.
		$an->Alert->register_alert({
			alert_level		=>	"warning", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0006",
			alert_message_key	=>	"scan_apc_pdu_message_0033",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0);
}

# This sets the phase amparage high warning alert, if set.
sub set_phase_high_warning
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "set_phase_high_warning" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $set = $an->Alert->check_alert_sent({
		type			=>	"warning",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_high_warning",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "set", value1 => $set, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($set)
	{
		# This is a new loss of comms.
		$an->Alert->register_alert({
			alert_level		=>	"warning", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0004",
			alert_message_key	=>	"scan_apc_pdu_message_0034",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0)
}

# This clears the phase amparage high warning alert, if set.
sub clear_phase_high_warning
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "clear_phase_high_warning" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $clear = $an->Alert->check_alert_sent({
		type			=>	"clear",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_high_warning",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "clear", value1 => $clear, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($clear)
	{
		# This is a new loss of comms.
		$an->Alert->register_alert({
			alert_level		=>	"warning", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0006",
			alert_message_key	=>	"scan_apc_pdu_message_0031",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0)
}

# This sets the phase high-critical alert, if not already.
sub set_phase_high_critical
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "clear_phase_high_critical" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $set = $an->Alert->check_alert_sent({
		type			=>	"warning",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_high_critical",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "set", value1 => $set, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($set)
	{
		$an->Alert->register_alert({
			alert_level		=>	"critical", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0005",
			alert_message_key	=>	"scan_apc_pdu_message_0032",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0);
}

# This clears the phase amparage high critical alert, if set.
sub clear_phase_high_critical
{
	my ($an, $pdu_host_name, $apc_pdu_phase_number, $apc_pdu_serial_number) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "clear_phase_high_critical" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu_host_name",         value1 => $pdu_host_name, 
		name2 => "apc_pdu_phase_number",  value2 => $apc_pdu_phase_number, 
		name3 => "apc_pdu_serial_number", value3 => $apc_pdu_serial_number, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $clear = $an->Alert->check_alert_sent({
		type			=>	"clear",
		alert_sent_by		=>	$THIS_FILE,
		alert_record_locator	=>	$apc_pdu_serial_number,
		alert_name		=>	"phase_".$apc_pdu_phase_number."_amp_high_critical",
		modified_date		=>	$an->data->{sys}{db_timestamp},
	});
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "clear", value1 => $clear, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($clear)
	{
		# This is a new loss of comms.
		$an->Alert->register_alert({
			alert_level		=>	"critical", 
			alert_agent_name	=>	$THIS_FILE,
			alert_title_key		=>	"an_alert_title_0007",
			alert_message_key	=>	"scan_apc_pdu_message_0030",
			alert_message_variables	=>	{
				pdu_name		=>	$pdu_host_name,
				phase			=>	sprintf("%02d", $apc_pdu_phase_number),
			},
		});
	}
	
	return(0)
}

# This UPDATEs a outlet
sub update_outlets
{
	my ($an, $apc_pdu_uuid, $apc_pdu_outlet_uuid, $apc_pdu_outlet_number, $apc_pdu_outlet_name, $apc_pdu_outlet_on_phase, $apc_pdu_outlet_state, $apc_pdu_outlet_note) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_outlets => { function => "update_outlets" }, message_key => "an_variables_0007", message_outlets => { 
		name1 => "apc_pdu_uuid",            value1 => $apc_pdu_uuid, 
		name2 => "apc_pdu_outlet_uuid",     value2 => $apc_pdu_outlet_uuid, 
		name3 => "apc_pdu_outlet_number",   value3 => $apc_pdu_outlet_number, 
		name4 => "apc_pdu_outlet_name",     value4 => $apc_pdu_outlet_name, 
		name5 => "apc_pdu_outlet_on_phase", value5 => $apc_pdu_outlet_on_phase, 
		name6 => "apc_pdu_outlet_state",    value6 => $apc_pdu_outlet_state, 
		name7 => "apc_pdu_outlet_note",     value7 => $apc_pdu_outlet_note, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $query = "
UPDATE 
    apc_pdu_outlets 
SET
    apc_pdu_outlet_apc_pdu_uuid = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).",
    apc_pdu_outlet_number       = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_number).", 
    apc_pdu_outlet_name         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_name).", 
    apc_pdu_outlet_on_phase     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_on_phase).", 
    apc_pdu_outlet_state        = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_state).", 
    apc_pdu_outlet_note         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_note).", 
    modified_date               = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_outlet_uuid         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid)." 
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_outlets => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	push @{$an->data->{sys}{sql}}, $query;
	
	return(0);
}

# This INSERTs a new outlet
sub insert_outlets
{
	my ($an, $apc_pdu_uuid, $apc_pdu_outlet_number, $apc_pdu_outlet_name, $apc_pdu_outlet_on_phase, $apc_pdu_outlet_state, $apc_pdu_outlet_note) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_outlets => { function => "insert_outlets" }, message_key => "an_variables_0006", message_outlets => { 
		name1 => "apc_pdu_uuid",            value1 => $apc_pdu_uuid, 
		name2 => "apc_pdu_outlet_number",   value2 => $apc_pdu_outlet_number, 
		name3 => "apc_pdu_outlet_name",     value3 => $apc_pdu_outlet_name, 
		name4 => "apc_pdu_outlet_on_phase", value4 => $apc_pdu_outlet_on_phase, 
		name5 => "apc_pdu_outlet_state",    value5 => $apc_pdu_outlet_state, 
		name6 => "apc_pdu_outlet_note",     value6 => $apc_pdu_outlet_note, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $apc_pdu_outlet_uuid = $an->Get->uuid() or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0024", code => 2, file => $THIS_FILE, line => __LINE__});
	my $query               = "
INSERT INTO 
    apc_pdu_outlets 
(
    apc_pdu_outlet_host_uuid, 
    apc_pdu_outlet_uuid, 
    apc_pdu_outlet_apc_pdu_uuid, 
    apc_pdu_outlet_number, 
    apc_pdu_outlet_name, 
    apc_pdu_outlet_on_phase, 
    apc_pdu_outlet_state, 
    apc_pdu_outlet_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_name).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_on_phase).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_state).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
);";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	push @{$an->data->{sys}{sql}}, $query;
	
	return($apc_pdu_outlet_uuid);
}

# This UPDATEs a variable
sub update_variables
{
	my ($an, $apc_pdu_uuid, $apc_pdu_variable_uuid, $variable, $value) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_variables" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "apc_pdu_uuid", value1 => $apc_pdu_uuid, 
		name2 => "variable",     value2 => $variable, 
		name3 => "value",        value3 => $value, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $query = "
UPDATE 
    apc_pdu_variables 
SET
    apc_pdu_variable_apc_pdu_uuid   = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).",
    apc_pdu_variable_is_temperature = FALSE, 
    apc_pdu_variable_name           = ".$an->data->{sys}{use_db_fh}->quote($variable).", 
    apc_pdu_variable_value          = ".$an->data->{sys}{use_db_fh}->quote($value).", 
    modified_date                   = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_variable_uuid           = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_uuid)." 
;";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	push @{$an->data->{sys}{sql}}, $query;
	
	return(0);
}

# This INSERTs a new variable
sub insert_variables
{
	my ($an, $apc_pdu_uuid, $variable, $value) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "insert_variables" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "apc_pdu_uuid", value1 => $apc_pdu_uuid, 
		name2 => "variable",     value2 => $variable, 
		name3 => "value",        value3 => $value, 
	}, file => $THIS_FILE, line => __LINE__});
	
	my $apc_pdu_variable_uuid = $an->Get->uuid() or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0024", code => 2, file => $THIS_FILE, line => __LINE__});
	my $query = "
INSERT INTO 
    apc_pdu_variables 
(
    apc_pdu_variable_host_uuid, 
    apc_pdu_variable_uuid, 
    apc_pdu_variable_apc_pdu_uuid, 
    apc_pdu_variable_is_temperature, 
    apc_pdu_variable_name, 
    apc_pdu_variable_value, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    FALSE, 
    ".$an->data->{sys}{use_db_fh}->quote($variable).", 
    ".$an->data->{sys}{use_db_fh}->quote($value).", 
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
);";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "query", value1 => $query
	}, file => $THIS_FILE, line => __LINE__});
	push @{$an->data->{sys}{sql}}, $query;
	
	return($apc_pdu_variable_uuid);
}

# This looks at each DB's 'updated' table entry to see if any tables are behind. If any are, it will update
# the tables based on the time the last entry was made for a given host.
sub update_db
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_db" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "scancore::db_resync_needed", value1 => $an->data->{scancore}{db_resync_needed}, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($an->data->{scancore}{db_resync_needed})
	{
		# Request a lock.
		$an->DB->locking({request => 1});
		
		# Make a note in the databases that we're starting an update and ask it to wait 10 seconds 
		# before returning to give other instances time to finish their scans. (our scans end quickly
		# enough).
		#$an->DB->set_update_db_flag({set => time, 'wait' => 10});
		
		# Update apc_pdu and outlet/phases/variables
		update_db_apc_pdu($an);
		update_db_apc_pdu_outlets($an);
		update_db_apc_pdu_phases($an);
		update_db_apc_pdu_variables($an);
		
		# Release the lock
		$an->DB->locking({release => 1});
		
		# Clear the update flag.
		#$an->DB->set_update_db_flag({set => 0});
	}
	
	return(0);
}

# Update the 'apc_pdu_variables' table.
sub update_db_apc_pdu_variables
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_db_apc_pdu_variables" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Now read in all the 'apc_pdu' table records that came from us.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# These will store the INSERTs for this DB, if needed.
		$an->data->{db_resync}{$id}{sql}          = [];
		$an->data->{db_resync}{$id}{public}{sql}  = [];
		$an->data->{db_resync}{$id}{history}{sql} = [];
		
		# Read in the history schema
		my $query = "
SELECT 
    apc_pdu_variable_uuid, 
    apc_pdu_variable_apc_pdu_uuid,
    apc_pdu_variable_is_temperature, 
    apc_pdu_variable_name, 
    apc_pdu_variable_value, 
    modified_date 
FROM 
    history.apc_pdu_variables 
WHERE 
    apc_pdu_variable_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "id",    value1 => $id, 
			name2 => "query", value2 => $query
		}, file => $THIS_FILE, line => __LINE__});
		
		# Do the query against the source DB and loop through the results.
		my $results = $an->DB->do_db_query({id => $id, query => $query, source => $THIS_FILE, line => __LINE__});
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "results", value1 => $results
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $row (@{$results})
		{
			my $apc_pdu_variable_uuid           =         $row->[0];
			my $apc_pdu_variable_apc_pdu_uuid   =         $row->[1];
			my $apc_pdu_variable_is_temperature =         $row->[2];
			my $apc_pdu_variable_name           =         $row->[3];
			my $apc_pdu_variable_value          = defined $row->[4] ? $row->[4] : "NULL";
			my $modified_date                   =         $row->[5];
			$an->Log->entry({log_level => 3, message_key => "an_variables_0006", message_variables => {
				name1 => "apc_pdu_variable_uuid",           value1 => $apc_pdu_variable_uuid, 
				name2 => "apc_pdu_variable_apc_pdu_uuid",   value2 => $apc_pdu_variable_apc_pdu_uuid, 
				name3 => "apc_pdu_variable_is_temperature", value3 => $apc_pdu_variable_is_temperature, 
				name4 => "apc_pdu_variable_name",           value4 => $apc_pdu_variable_name, 
				name5 => "apc_pdu_variable_value",          value5 => $apc_pdu_variable_value, 
				name6 => "modified_date",                   value6 => $modified_date, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Record this in the unified and local hashes.
			$an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid} = {
				apc_pdu_variable_apc_pdu_uuid	=>	$apc_pdu_variable_apc_pdu_uuid, 
				apc_pdu_variable_is_temperature	=>	$apc_pdu_variable_is_temperature, 
				apc_pdu_variable_name		=>	$apc_pdu_variable_name, 
				apc_pdu_variable_value		=>	$apc_pdu_variable_value, 
			};
			$an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{'exists'} = 1;
			$an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{seen}     = 0;
			$an->data->{db_data}{$id}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid} = {
				apc_pdu_variable_apc_pdu_uuid	=>	$apc_pdu_variable_apc_pdu_uuid, 
				apc_pdu_variable_is_temperature	=>	$apc_pdu_variable_is_temperature, 
				apc_pdu_variable_name		=>	$apc_pdu_variable_name, 
				apc_pdu_variable_value		=>	$apc_pdu_variable_value, 
			};
		}
	}
	
	### NOTE: Sort '$b cmp $a' on the modified date.
	# Now, loop through each record from the unified table and see if it needs to be added to any DBs.
	foreach my $modified_date (sort {$b cmp $a} keys %{$an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}})
	{
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "modified_date", value1 => $modified_date,
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $apc_pdu_variable_uuid (sort {$a cmp $b} keys %{$an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}})
		{
			my $apc_pdu_variable_apc_pdu_uuid   = $an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{apc_pdu_variable_apc_pdu_uuid};
			my $apc_pdu_variable_is_temperature = $an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{apc_pdu_variable_is_temperature};
			my $apc_pdu_variable_name           = $an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{apc_pdu_variable_name};
			my $apc_pdu_variable_value          = $an->data->{db_data}{unified}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{apc_pdu_variable_value};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0005", message_variables => {
				name1 => "apc_pdu_variable_uuid",           value1 => $apc_pdu_variable_uuid, 
				name2 => "apc_pdu_variable_apc_pdu_uuid",   value2 => $apc_pdu_variable_apc_pdu_uuid, 
				name3 => "apc_pdu_variable_is_temperature", value3 => $apc_pdu_variable_is_temperature, 
				name4 => "apc_pdu_variable_name",           value4 => $apc_pdu_variable_name, 
				name5 => "apc_pdu_variable_value",          value5 => $apc_pdu_variable_value, 
			}, file => $THIS_FILE, line => __LINE__});
			foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
			{
				# For each 'apc_pdu_variable_uuid' we see;
				# - Check if we've *seen* it before
				#   |- If not; See if it *exists* in the public schema yet.
				#   |  |- If so, check to see if the entry in the public schema is up to date.
				#   |  |  \- If not, _UPDATE_ public schema.
				#   |  \- If not, do an _INSERT_ into public schema.
				#   \- If we have, see if it exists at the current timestamp.
				#      \- If not, _INSERT_ it into history schema.
				#
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "db_data::${id}::apc_pdu_variables::apc_pdu_variable_uuid::${apc_pdu_variable_uuid}::seen", value1 => $an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{seen}, 
				}, file => $THIS_FILE, line => __LINE__});
				if (not $an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{seen})
				{
					# Mark this record as now having been seen.
					$an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{seen} = 1;
					
					# Never seen it. Check if it exists.
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "db_data::${id}::apc_pdu_variables::apc_pdu_variable_uuid::${apc_pdu_variable_uuid}::exists", value1 => $an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{'exists'}, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($an->data->{db_data}{$id}{apc_pdu_variables}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}{'exists'})
					{
						# It exists, but does it exist at this time stamp?
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1  => "db_data::${id}::apc_pdu_variables::modified_date::${modified_date}::apc_pdu_variable_uuid::${apc_pdu_variable_uuid}", value1 => $an->data->{db_data}{$id}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid}, 
						}, file => $THIS_FILE, line => __LINE__});
						if (not $an->data->{db_data}{$id}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid})
						{
							# No, so UPDATE it.
							my $query = "
UPDATE 
    public.apc_pdu_variables 
SET
    apc_pdu_variable_apc_pdu_uuid   = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_apc_pdu_uuid).",
    apc_pdu_variable_is_temperature = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_is_temperature).", 
    apc_pdu_variable_name           = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_name).", 
    apc_pdu_variable_value          = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_value).", 
    modified_date                   = ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
WHERE 
    apc_pdu_variable_host_uuid      = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
AND 
    apc_pdu_variable_uuid           = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_uuid)." 
;";
							# Now record the query in the array
							$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
								name1 => "id",    value1 => $id, 
								name2 => "query", value2 => $query
							}, file => $THIS_FILE, line => __LINE__});
							push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
						}
					}
					else
					{
						# It doesn't exist, so INSERT it.
						my $query = "
INSERT INTO 
    public.apc_pdu_variables 
(
    apc_pdu_variable_host_uuid, 
    apc_pdu_variable_uuid, 
    apc_pdu_variable_apc_pdu_uuid, 
    apc_pdu_variable_is_temperature, 
    apc_pdu_variable_name, 
    apc_pdu_variable_value, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_is_temperature).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_name).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_value).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
					}
				}
				else
				{
					# We've seen this 'apc_pdu_variable_uuid' before, so it is just a question of 
					# whether the entry for the current timestamp exists in the history 
					# schema.
					if (not $an->data->{db_data}{$id}{apc_pdu_variables}{modified_date}{$modified_date}{apc_pdu_variable_uuid}{$apc_pdu_variable_uuid})
					{
						# It doesn't, INSERT it.
						my $query = "
INSERT INTO 
    history.apc_pdu_variables 
(
    apc_pdu_variable_host_uuid, 
    apc_pdu_variable_uuid, 
    apc_pdu_variable_apc_pdu_uuid, 
    apc_pdu_variable_is_temperature, 
    apc_pdu_variable_name, 
    apc_pdu_variable_value, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_is_temperature).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_name).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_variable_value).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{history}{sql}}, $query;
					} # Exist in history at timestamp?
				} # Seen apc_pdu_variable_uuid?
			} # foreach my $id 
		} # foreach my $apc_pdu_variable_uuid ...
	} # foreach $modified_date ...
	
	# Free up memory by deleting the DB data from the main hash.
	delete $an->data->{db_data};
	
	# Do the INSERTs now and then release the memory.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# Merge the queries with public schema queries being first.
		@{$an->data->{db_resync}{$id}{sql}} = (@{$an->data->{db_resync}{$id}{public}{sql}}, @{$an->data->{db_resync}{$id}{history}{sql}});
		if (@{$an->data->{db_resync}{$id}{sql}} > 0)
		{
			$an->DB->do_db_write({id => $id, query => $an->data->{db_resync}{$id}{sql}, source => $THIS_FILE, line => __LINE__});
			delete $an->data->{db_resync}{$id}{sql};
		}
	}
	
	return(0);
}

# Update the 'apc_pdu_phases' table.
sub update_db_apc_pdu_phases
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_db_apc_pdu_phases" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Now read in all the 'apc_pdu' table records that came from us.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# These will store the INSERTs for this DB, if needed.
		$an->data->{db_resync}{$id}{sql}          = [];
		$an->data->{db_resync}{$id}{public}{sql}  = [];
		$an->data->{db_resync}{$id}{history}{sql} = [];
		
		# Read in the history schema
		my $query = "
SELECT 
    apc_pdu_phase_uuid, 
    apc_pdu_phase_apc_pdu_uuid,
    apc_pdu_phase_number, 
    apc_pdu_phase_current_amperage, 
    apc_pdu_phase_max_amperage, 
    apc_pdu_phase_note, 
    modified_date 
FROM 
    history.apc_pdu_phases 
WHERE 
    apc_pdu_phase_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "id",    value1 => $id, 
			name2 => "query", value2 => $query
		}, file => $THIS_FILE, line => __LINE__});
		
		# Do the query against the source DB and loop through the results.
		my $results = $an->DB->do_db_query({id => $id, query => $query, source => $THIS_FILE, line => __LINE__});
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "results", value1 => $results
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $row (@{$results})
		{
			my $apc_pdu_phase_uuid             =         $row->[0];
			my $apc_pdu_phase_apc_pdu_uuid     =         $row->[1];
			my $apc_pdu_phase_number           =         $row->[2];
			my $apc_pdu_phase_current_amperage =         $row->[3];
			my $apc_pdu_phase_max_amperage     = defined $row->[4] ? $row->[4] : "NULL";
			my $apc_pdu_phase_note             = defined $row->[5] ? $row->[5] : "NULL";
			my $modified_date                  =         $row->[6];
			$an->Log->entry({log_level => 3, message_key => "an_variables_0007", message_variables => {
				name1 => "apc_pdu_phase_uuid",             value1 => $apc_pdu_phase_uuid, 
				name2 => "apc_pdu_phase_apc_pdu_uuid",     value2 => $apc_pdu_phase_apc_pdu_uuid, 
				name3 => "apc_pdu_phase_number",           value3 => $apc_pdu_phase_number, 
				name4 => "apc_pdu_phase_current_amperage", value4 => $apc_pdu_phase_current_amperage, 
				name5 => "apc_pdu_phase_max_amperage",     value5 => $apc_pdu_phase_max_amperage, 
				name6 => "apc_pdu_phase_note",             value6 => $apc_pdu_phase_note, 
				name7 => "modified_date",                  value7 => $modified_date, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Record this in the unified and local hashes.
			$an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid} = {
				apc_pdu_phase_apc_pdu_uuid	=>	$apc_pdu_phase_apc_pdu_uuid, 
				apc_pdu_phase_number		=>	$apc_pdu_phase_number, 
				apc_pdu_phase_current_amperage	=>	$apc_pdu_phase_current_amperage, 
				apc_pdu_phase_max_amperage	=>	$apc_pdu_phase_max_amperage, 
				apc_pdu_phase_note		=>	$apc_pdu_phase_note, 
			};
			$an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{'exists'} = 1;
			$an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{seen}     = 0;
			$an->data->{db_data}{$id}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid} = {
				apc_pdu_phase_apc_pdu_uuid	=>	$apc_pdu_phase_apc_pdu_uuid, 
				apc_pdu_phase_number		=>	$apc_pdu_phase_number, 
				apc_pdu_phase_current_amperage	=>	$apc_pdu_phase_current_amperage, 
				apc_pdu_phase_max_amperage	=>	$apc_pdu_phase_max_amperage, 
				apc_pdu_phase_note		=>	$apc_pdu_phase_note, 
			};
		}
	}
	
	### NOTE: Sort '$b cmp $a' on the modified date.
	# Now, loop through each record from the unified table and see if it needs to be added to any DBs.
	foreach my $modified_date (sort {$b cmp $a} keys %{$an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}})
	{
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "modified_date", value1 => $modified_date,
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $apc_pdu_phase_uuid (sort {$a cmp $b} keys %{$an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}})
		{
			my $apc_pdu_phase_apc_pdu_uuid     = $an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{apc_pdu_phase_apc_pdu_uuid};
			my $apc_pdu_phase_number           = $an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{apc_pdu_phase_number};
			my $apc_pdu_phase_current_amperage = $an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{apc_pdu_phase_current_amperage};
			my $apc_pdu_phase_max_amperage     = $an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{apc_pdu_phase_max_amperage};
			my $apc_pdu_phase_note             = $an->data->{db_data}{unified}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{apc_pdu_phase_note};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0006", message_variables => {
				name1 => "apc_pdu_phase_uuid",             value1 => $apc_pdu_phase_uuid, 
				name2 => "apc_pdu_phase_apc_pdu_uuid",     value2 => $apc_pdu_phase_apc_pdu_uuid, 
				name3 => "apc_pdu_phase_number",           value3 => $apc_pdu_phase_number, 
				name4 => "apc_pdu_phase_current_amperage", value4 => $apc_pdu_phase_current_amperage, 
				name5 => "apc_pdu_phase_max_amperage",     value5 => $apc_pdu_phase_max_amperage, 
				name6 => "apc_pdu_phase_note",             value6 => $apc_pdu_phase_note, 
			}, file => $THIS_FILE, line => __LINE__});
			foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
			{
				# For each 'apc_pdu_phase_uuid' we see;
				# - Check if we've *seen* it before
				#   |- If not; See if it *exists* in the public schema yet.
				#   |  |- If so, check to see if the entry in the public schema is up to date.
				#   |  |  \- If not, _UPDATE_ public schema.
				#   |  \- If not, do an _INSERT_ into public schema.
				#   \- If we have, see if it exists at the current timestamp.
				#      \- If not, _INSERT_ it into history schema.
				#
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "db_data::${id}::apc_pdu_phases::apc_pdu_phase_uuid::${apc_pdu_phase_uuid}::seen", value1 => $an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{seen}, 
				}, file => $THIS_FILE, line => __LINE__});
				if (not $an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{seen})
				{
					# Mark this record as now having been seen.
					$an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{seen} = 1;
					
					# Never seen it. Check if it exists.
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "db_data::${id}::apc_pdu_phases::apc_pdu_phase_uuid::${apc_pdu_phase_uuid}::exists", value1 => $an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{'exists'}, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($an->data->{db_data}{$id}{apc_pdu_phases}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}{'exists'})
					{
						# It exists, but does it exist at this time stamp?
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1  => "db_data::${id}::apc_pdu_phases::modified_date::${modified_date}::apc_pdu_phase_uuid::${apc_pdu_phase_uuid}", value1 => $an->data->{db_data}{$id}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid}, 
						}, file => $THIS_FILE, line => __LINE__});
						if (not $an->data->{db_data}{$id}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid})
						{
							# No, so UPDATE it.
							my $query = "
UPDATE 
    public.apc_pdu_phases 
SET
    apc_pdu_phase_apc_pdu_uuid     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_apc_pdu_uuid).",
    apc_pdu_phase_number           = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_number).", 
    apc_pdu_phase_current_amperage = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_current_amperage).", 
    apc_pdu_phase_max_amperage     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_max_amperage).", 
    apc_pdu_phase_note             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_note).", 
    modified_date                  = ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
WHERE 
    apc_pdu_phase_host_uuid        = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
AND 
    apc_pdu_phase_uuid             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid)." 
;";
							# Now record the query in the array
							$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
								name1 => "id",    value1 => $id, 
								name2 => "query", value2 => $query
							}, file => $THIS_FILE, line => __LINE__});
							push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
						}
					}
					else
					{
						# It doesn't exist, so INSERT it.
						my $query = "
INSERT INTO 
    public.apc_pdu_phases 
(
    apc_pdu_phase_host_uuid, 
    apc_pdu_phase_uuid, 
    apc_pdu_phase_apc_pdu_uuid, 
    apc_pdu_phase_number, 
    apc_pdu_phase_current_amperage, 
    apc_pdu_phase_max_amperage, 
    apc_pdu_phase_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_current_amperage).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_max_amperage).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
					}
				}
				else
				{
					# We've seen this 'apc_pdu_phase_uuid' before, so it is just a question of 
					# whether the entry for the current timestamp exists in the history 
					# schema.
					if (not $an->data->{db_data}{$id}{apc_pdu_phases}{modified_date}{$modified_date}{apc_pdu_phase_uuid}{$apc_pdu_phase_uuid})
					{
						# It doesn't, INSERT it.
						my $query = "
INSERT INTO 
    history.apc_pdu_phases 
(
    apc_pdu_phase_host_uuid, 
    apc_pdu_phase_uuid, 
    apc_pdu_phase_apc_pdu_uuid, 
    apc_pdu_phase_number, 
    apc_pdu_phase_current_amperage, 
    apc_pdu_phase_max_amperage, 
    apc_pdu_phase_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_current_amperage).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_max_amperage).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{history}{sql}}, $query;
					} # Exist in history at timestamp?
				} # Seen apc_pdu_phase_uuid?
			} # foreach my $id 
		} # foreach my $apc_pdu_phase_uuid ...
	} # foreach $modified_date ...
	
	# Free up memory by deleting the DB data from the main hash.
	delete $an->data->{db_data};
	
	# Do the INSERTs now and then release the memory.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# Merge the queries with public schema queries being first.
		@{$an->data->{db_resync}{$id}{sql}} = (@{$an->data->{db_resync}{$id}{public}{sql}}, @{$an->data->{db_resync}{$id}{history}{sql}});
		if (@{$an->data->{db_resync}{$id}{sql}} > 0)
		{
			$an->DB->do_db_write({id => $id, query => $an->data->{db_resync}{$id}{sql}, source => $THIS_FILE, line => __LINE__});
			delete $an->data->{db_resync}{$id}{sql};
		}
	}
	
	return(0);
}

# Update the 'apc_pdu_outlets' table.
sub update_db_apc_pdu_outlets
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_db_apc_pdu_outlets" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Now read in all the 'apc_pdu' table records that came from us.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# These will store the INSERTs for this DB, if needed.
		$an->data->{db_resync}{$id}{sql}          = [];
		$an->data->{db_resync}{$id}{public}{sql}  = [];
		$an->data->{db_resync}{$id}{history}{sql} = [];
		
		# Read in the history schema
		my $query = "
SELECT 
    apc_pdu_outlet_uuid, 
    apc_pdu_outlet_apc_pdu_uuid,
    apc_pdu_outlet_number, 
    apc_pdu_outlet_name, 
    apc_pdu_outlet_on_phase, 
    apc_pdu_outlet_state, 
    apc_pdu_outlet_note, 
    modified_date 
FROM 
    history.apc_pdu_outlets 
WHERE 
    apc_pdu_outlet_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "id",    value1 => $id, 
			name2 => "query", value2 => $query
		}, file => $THIS_FILE, line => __LINE__});
		
		# Do the query against the source DB and loop through the results.
		my $results = $an->DB->do_db_query({id => $id, query => $query, source => $THIS_FILE, line => __LINE__});
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "results", value1 => $results
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $row (@{$results})
		{
			my $apc_pdu_outlet_uuid         =         $row->[0];
			my $apc_pdu_outlet_apc_pdu_uuid =         $row->[1];
			my $apc_pdu_outlet_number       =         $row->[2];
			my $apc_pdu_outlet_name         = defined $row->[3] ? $row->[3] : "NULL";
			my $apc_pdu_outlet_on_phase     =         $row->[4];
			my $apc_pdu_outlet_state        =         $row->[5];
			my $apc_pdu_outlet_note         = defined $row->[6] ? $row->[6] : "NULL";
			my $modified_date               =         $row->[7];
			$an->Log->entry({log_level => 3, message_key => "an_variables_0008", message_variables => {
				name1 => "apc_pdu_outlet_uuid",         value1 => $apc_pdu_outlet_uuid, 
				name2 => "apc_pdu_outlet_apc_pdu_uuid", value2 => $apc_pdu_outlet_apc_pdu_uuid, 
				name3 => "apc_pdu_outlet_number",       value3 => $apc_pdu_outlet_number, 
				name4 => "apc_pdu_outlet_name",         value4 => $apc_pdu_outlet_name, 
				name5 => "apc_pdu_outlet_on_phase",     value5 => $apc_pdu_outlet_on_phase, 
				name6 => "apc_pdu_outlet_state",        value6 => $apc_pdu_outlet_state, 
				name7 => "apc_pdu_outlet_note",         value7 => $apc_pdu_outlet_note, 
				name8 => "modified_date",               value8 => $modified_date, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Record this in the unified and local hashes.
			$an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid} = {
				apc_pdu_outlet_apc_pdu_uuid	=>	$apc_pdu_outlet_apc_pdu_uuid, 
				apc_pdu_outlet_number		=>	$apc_pdu_outlet_number, 
				apc_pdu_outlet_name		=>	$apc_pdu_outlet_name, 
				apc_pdu_outlet_on_phase		=>	$apc_pdu_outlet_on_phase, 
				apc_pdu_outlet_state		=>	$apc_pdu_outlet_state, 
				apc_pdu_outlet_note		=>	$apc_pdu_outlet_note, 
			};
			$an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{'exists'} = 1;
			$an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{seen}     = 0;
			$an->data->{db_data}{$id}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid} = {
				apc_pdu_outlet_apc_pdu_uuid	=>	$apc_pdu_outlet_apc_pdu_uuid, 
				apc_pdu_outlet_number		=>	$apc_pdu_outlet_number, 
				apc_pdu_outlet_name		=>	$apc_pdu_outlet_name, 
				apc_pdu_outlet_on_phase		=>	$apc_pdu_outlet_on_phase, 
				apc_pdu_outlet_state		=>	$apc_pdu_outlet_state, 
				apc_pdu_outlet_note		=>	$apc_pdu_outlet_note, 
			};
		}
	}
	
	### NOTE: Sort '$b cmp $a' on the modified date.
	# Now, loop through each record from the unified table and see if it needs to be added to any DBs.
	foreach my $modified_date (sort {$b cmp $a} keys %{$an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}})
	{
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "modified_date", value1 => $modified_date,
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $apc_pdu_outlet_uuid (sort {$a cmp $b} keys %{$an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}})
		{
			my $apc_pdu_outlet_apc_pdu_uuid = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_apc_pdu_uuid};
			my $apc_pdu_outlet_number       = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_number};
			my $apc_pdu_outlet_name         = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_name};
			my $apc_pdu_outlet_on_phase     = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_on_phase};
			my $apc_pdu_outlet_state        = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_state};
			my $apc_pdu_outlet_note         = $an->data->{db_data}{unified}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{apc_pdu_outlet_note};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0007", message_variables => {
				name1 => "apc_pdu_outlet_uuid",         value1 => $apc_pdu_outlet_uuid, 
				name2 => "apc_pdu_outlet_apc_pdu_uuid", value2 => $apc_pdu_outlet_apc_pdu_uuid, 
				name3 => "apc_pdu_outlet_number",       value3 => $apc_pdu_outlet_number, 
				name4 => "apc_pdu_outlet_name",         value4 => $apc_pdu_outlet_name, 
				name5 => "apc_pdu_outlet_on_phase",     value5 => $apc_pdu_outlet_on_phase, 
				name6 => "apc_pdu_outlet_state",        value6 => $apc_pdu_outlet_state, 
				name7 => "apc_pdu_outlet_note",         value7 => $apc_pdu_outlet_note, 
			}, file => $THIS_FILE, line => __LINE__});
			foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
			{
				# For each 'apc_pdu_outlet_uuid' we see;
				# - Check if we've *seen* it before
				#   |- If not; See if it *exists* in the public schema yet.
				#   |  |- If so, check to see if the entry in the public schema is up to date.
				#   |  |  \- If not, _UPDATE_ public schema.
				#   |  \- If not, do an _INSERT_ into public schema.
				#   \- If we have, see if it exists at the current timestamp.
				#      \- If not, _INSERT_ it into history schema.
				#
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "db_data::${id}::apc_pdu_outlets::apc_pdu_outlet_uuid::${apc_pdu_outlet_uuid}::seen", value1 => $an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{seen}, 
				}, file => $THIS_FILE, line => __LINE__});
				if (not $an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{seen})
				{
					# Mark this record as now having been seen.
					$an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{seen} = 1;
					
					# Never seen it. Check if it exists.
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "db_data::${id}::apc_pdu_outlets::apc_pdu_outlet_uuid::${apc_pdu_outlet_uuid}::exists", value1 => $an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{'exists'}, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($an->data->{db_data}{$id}{apc_pdu_outlets}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}{'exists'})
					{
						# It exists, but does it exist at this time stamp?
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1  => "db_data::${id}::apc_pdu_outlets::modified_date::${modified_date}::apc_pdu_outlet_uuid::${apc_pdu_outlet_uuid}", value1 => $an->data->{db_data}{$id}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid}, 
						}, file => $THIS_FILE, line => __LINE__});
						if (not $an->data->{db_data}{$id}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid})
						{
							# No, so UPDATE it.
							my $query = "
UPDATE 
    public.apc_pdu_outlets 
SET
    apc_pdu_outlet_apc_pdu_uuid = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_apc_pdu_uuid).",
    apc_pdu_outlet_number       = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_number).", 
    apc_pdu_outlet_name         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_name).", 
    apc_pdu_outlet_on_phase     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_on_phase).", 
    apc_pdu_outlet_state        = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_state).", 
    apc_pdu_outlet_note         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_note).", 
    modified_date               = ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
WHERE 
    apc_pdu_outlet_host_uuid    = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
AND 
    apc_pdu_outlet_uuid         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid)." 
;";
							# Now record the query in the array
							$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
								name1 => "id",    value1 => $id, 
								name2 => "query", value2 => $query
							}, file => $THIS_FILE, line => __LINE__});
							push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
						}
					}
					else
					{
						# It doesn't exist, so INSERT it.
						my $query = "
INSERT INTO 
    public.apc_pdu_outlets 
(
    apc_pdu_outlet_host_uuid, 
    apc_pdu_outlet_uuid, 
    apc_pdu_outlet_apc_pdu_uuid, 
    apc_pdu_outlet_number, 
    apc_pdu_outlet_name, 
    apc_pdu_outlet_on_phase, 
    apc_pdu_outlet_state, 
    apc_pdu_outlet_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_name).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_on_phase).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_state).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
					}
				}
				else
				{
					# We've seen this 'apc_pdu_outlet_uuid' before, so it is just a question of 
					# whether the entry for the current timestamp exists in the history 
					# schema.
					if (not $an->data->{db_data}{$id}{apc_pdu_outlets}{modified_date}{$modified_date}{apc_pdu_outlet_uuid}{$apc_pdu_outlet_uuid})
					{
						# It doesn't, INSERT it.
						my $query = "
INSERT INTO 
    history.apc_pdu_outlets 
(
    apc_pdu_outlet_host_uuid, 
    apc_pdu_outlet_uuid, 
    apc_pdu_outlet_apc_pdu_uuid, 
    apc_pdu_outlet_number, 
    apc_pdu_outlet_name, 
    apc_pdu_outlet_on_phase, 
    apc_pdu_outlet_state, 
    apc_pdu_outlet_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_name).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_on_phase).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_state).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{history}{sql}}, $query;
					} # Exist in history at timestamp?
				} # Seen apc_pdu_outlet_uuid?
			} # foreach my $id 
		} # foreach my $apc_pdu_outlet_uuid ...
	} # foreach $modified_date ...
	
	# Free up memory by deleting the DB data from the main hash.
	delete $an->data->{db_data};
	
	# Do the INSERTs now and then release the memory.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# Merge the queries with public schema queries being first.
		@{$an->data->{db_resync}{$id}{sql}} = (@{$an->data->{db_resync}{$id}{public}{sql}}, @{$an->data->{db_resync}{$id}{history}{sql}});
		if (@{$an->data->{db_resync}{$id}{sql}} > 0)
		{
			$an->DB->do_db_write({id => $id, query => $an->data->{db_resync}{$id}{sql}, source => $THIS_FILE, line => __LINE__});
			delete $an->data->{db_resync}{$id}{sql};
		}
	}
	
	return(0);
}

# Update the 'apc_pdu' table.
sub update_db_apc_pdu
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "update_db_apc_pdu" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Now read in all the 'apc_pdu' table records that came from us.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# These will store the INSERTs for this DB, if needed.
		$an->data->{db_resync}{$id}{sql}          = [];
		$an->data->{db_resync}{$id}{public}{sql}  = [];
		$an->data->{db_resync}{$id}{history}{sql} = [];
		
		# Read in the history schema
		my $query = "
SELECT 
    apc_pdu_uuid, 
    apc_pdu_serial_number, 
    apc_pdu_model_number, 
    apc_pdu_manufacture_date, 
    apc_pdu_firmware_version, 
    apc_pdu_hardware_version, 
    apc_pdu_ipv4_address, 
    apc_pdu_mac_address, 
    apc_pdu_mtu_size, 
    apc_pdu_link_speed, 
    apc_pdu_phase_count, 
    apc_pdu_outlet_count, 
    apc_pdu_note, 
    modified_date 
FROM 
    history.apc_pdus 
WHERE 
    apc_pdu_host_uuid = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
;";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "id",    value1 => $id, 
			name2 => "query", value2 => $query
		}, file => $THIS_FILE, line => __LINE__});
		
		# Do the query against the source DB and loop through the results.
		my $results = $an->DB->do_db_query({id => $id, query => $query, source => $THIS_FILE, line => __LINE__});
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "results", value1 => $results
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $row (@{$results})
		{
			my $apc_pdu_uuid             =         $row->[0];
			my $apc_pdu_serial_number    =         $row->[1];
			my $apc_pdu_model_number     =         $row->[2];
			my $apc_pdu_manufacture_date = defined $row->[3]  ? $row->[3]  : "NULL";
			my $apc_pdu_firmware_version = defined $row->[4]  ? $row->[4]  : "NULL";
			my $apc_pdu_hardware_version = defined $row->[5]  ? $row->[5]  : "NULL";
			my $apc_pdu_ipv4_address     =         $row->[6];
			my $apc_pdu_mac_address      =         $row->[7];
			my $apc_pdu_mtu_size         =         $row->[8];
			my $apc_pdu_link_speed       =         $row->[9];
			my $apc_pdu_phase_count      =         $row->[10];
			my $apc_pdu_outlet_count     =         $row->[11];
			my $apc_pdu_note             = defined $row->[12] ? $row->[12] : "NULL";
			my $modified_date            =         $row->[13];
			$an->Log->entry({log_level => 3, message_key => "an_variables_0014", message_variables => {
				name1  => "apc_pdu_uuid",             value1  => $apc_pdu_uuid, 
				name2  => "apc_pdu_serial_number",    value2  => $apc_pdu_serial_number, 
				name3  => "apc_pdu_model_number",     value3  => $apc_pdu_model_number, 
				name4  => "apc_pdu_manufacture_date", value4  => $apc_pdu_manufacture_date, 
				name5  => "apc_pdu_firmware_version", value5  => $apc_pdu_firmware_version, 
				name6  => "apc_pdu_hardware_version", value6  => $apc_pdu_hardware_version, 
				name7  => "apc_pdu_ipv4_address",     value7  => $apc_pdu_ipv4_address, 
				name8  => "apc_pdu_mac_address",      value8  => $apc_pdu_mac_address, 
				name9  => "apc_pdu_mtu_size",         value9  => $apc_pdu_mtu_size, 
				name10 => "apc_pdu_link_speed",       value10 => $apc_pdu_link_speed, 
				name11 => "apc_pdu_phase_count",      value11 => $apc_pdu_phase_count, 
				name12 => "apc_pdu_outlet_count",     value12 => $apc_pdu_outlet_count, 
				name13 => "apc_pdu_note",             value13 => $apc_pdu_note, 
				name14 => "modified_date",            value14 => $modified_date
			}, file => $THIS_FILE, line => __LINE__});
			
			# Record this in the unified and local hashes.
			$an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid} = {
				apc_pdu_serial_number		=>	$apc_pdu_serial_number, 
				apc_pdu_model_number		=>	$apc_pdu_model_number, 
				apc_pdu_manufacture_date	=>	$apc_pdu_manufacture_date, 
				apc_pdu_firmware_version	=>	$apc_pdu_firmware_version, 
				apc_pdu_hardware_version	=>	$apc_pdu_hardware_version, 
				apc_pdu_ipv4_address		=>	$apc_pdu_ipv4_address, 
				apc_pdu_mac_address		=>	$apc_pdu_mac_address, 
				apc_pdu_mtu_size		=>	$apc_pdu_mtu_size, 
				apc_pdu_link_speed		=>	$apc_pdu_link_speed, 
				apc_pdu_phase_count		=>	$apc_pdu_phase_count, 
				apc_pdu_outlet_count		=>	$apc_pdu_outlet_count, 
				apc_pdu_note			=>	$apc_pdu_note, 
			};
			$an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{'exists'} = 1;
			$an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{seen}     = 0;
			$an->data->{db_data}{$id}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid} = {
				apc_pdu_serial_number		=>	$apc_pdu_serial_number, 
				apc_pdu_model_number		=>	$apc_pdu_model_number, 
				apc_pdu_manufacture_date	=>	$apc_pdu_manufacture_date, 
				apc_pdu_firmware_version	=>	$apc_pdu_firmware_version, 
				apc_pdu_hardware_version	=>	$apc_pdu_hardware_version, 
				apc_pdu_ipv4_address		=>	$apc_pdu_ipv4_address, 
				apc_pdu_mac_address		=>	$apc_pdu_mac_address, 
				apc_pdu_mtu_size		=>	$apc_pdu_mtu_size, 
				apc_pdu_link_speed		=>	$apc_pdu_link_speed, 
				apc_pdu_phase_count		=>	$apc_pdu_phase_count, 
				apc_pdu_outlet_count		=>	$apc_pdu_outlet_count, 
				apc_pdu_note			=>	$apc_pdu_note, 
			};
		}
	}
	
	### NOTE: Sort '$b cmp $a' on the modified date.
	# Now, loop through each record from the unified table and see if it needs to be added to any DBs.
	foreach my $modified_date (sort {$b cmp $a} keys %{$an->data->{db_data}{unified}{apc_pdu}{modified_date}})
	{
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "modified_date", value1 => $modified_date,
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $apc_pdu_uuid (sort {$a cmp $b} keys %{$an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}})
		{
			my $apc_pdu_serial_number    = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_serial_number};
			my $apc_pdu_model_number     = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_model_number};
			my $apc_pdu_manufacture_date = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_manufacture_date};
			my $apc_pdu_firmware_version = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_firmware_version};
			my $apc_pdu_hardware_version = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_hardware_version};
			my $apc_pdu_ipv4_address     = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_ipv4_address};
			my $apc_pdu_mac_address      = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_mac_address};
			my $apc_pdu_mtu_size         = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_mtu_size};
			my $apc_pdu_link_speed       = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_link_speed};
			my $apc_pdu_phase_count      = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_phase_count};
			my $apc_pdu_outlet_count     = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_outlet_count};
			my $apc_pdu_note             = $an->data->{db_data}{unified}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}{apc_pdu_note};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0013", message_variables => {
				name1  => "apc_pdu_uuid",             value1  => $apc_pdu_uuid, 
				name2  => "apc_pdu_serial_number",    value2  => $apc_pdu_serial_number, 
				name3  => "apc_pdu_model_number",     value3  => $apc_pdu_model_number, 
				name4  => "apc_pdu_manufacture_date", value4  => $apc_pdu_manufacture_date, 
				name5  => "apc_pdu_firmware_version", value5  => $apc_pdu_firmware_version, 
				name6  => "apc_pdu_hardware_version", value6  => $apc_pdu_hardware_version, 
				name7  => "apc_pdu_ipv4_address",     value7  => $apc_pdu_ipv4_address, 
				name8  => "apc_pdu_mac_address",      value8  => $apc_pdu_mac_address, 
				name9  => "apc_pdu_mtu_size",         value9  => $apc_pdu_mtu_size, 
				name10 => "apc_pdu_link_speed",       value10 => $apc_pdu_link_speed, 
				name11 => "apc_pdu_phase_count",      value11 => $apc_pdu_phase_count, 
				name12 => "apc_pdu_outlet_count",     value12 => $apc_pdu_outlet_count, 
				name13 => "apc_pdu_note",             value13 => $apc_pdu_note, 
			}, file => $THIS_FILE, line => __LINE__});
			foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
			{
				# For each 'apc_pdu_uuid' we see;
				# - Check if we've *seen* it before
				#   |- If not; See if it *exists* in the public schema yet.
				#   |  |- If so, check to see if the entry in the public schema is up to date.
				#   |  |  \- If not, _UPDATE_ public schema.
				#   |  \- If not, do an _INSERT_ into public schema.
				#   \- If we have, see if it exists at the current timestamp.
				#      \- If not, _INSERT_ it into history schema.
				#
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "db_data::${id}::apc_pdu::apc_pdu_uuid::${apc_pdu_uuid}::seen", value1 => $an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{seen}, 
				}, file => $THIS_FILE, line => __LINE__});
				if (not $an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{seen})
				{
					# Mark this record as now having been seen.
					$an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{seen} = 1;
					
					# Never seen it. Check if it exists.
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "db_data::${id}::apc_pdu::apc_pdu_uuid::${apc_pdu_uuid}::exists", value1 => $an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{'exists'}, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($an->data->{db_data}{$id}{apc_pdu}{apc_pdu_uuid}{$apc_pdu_uuid}{'exists'})
					{
						# It exists, but does it exist at this time stamp?
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1  => "db_data::${id}::apc_pdu::modified_date::${modified_date}::apc_pdu_uuid::${apc_pdu_uuid}", value1 => $an->data->{db_data}{$id}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid}, 
						}, file => $THIS_FILE, line => __LINE__});
						if (not $an->data->{db_data}{$id}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid})
						{
							# No, so UPDATE it.
							my $query = "
UPDATE 
    public.apc_pdus 
SET
    apc_pdu_serial_number    = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_serial_number).", 
    apc_pdu_model_number     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_model_number).", 
    apc_pdu_manufacture_date = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_manufacture_date).", 
    apc_pdu_firmware_version = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_firmware_version).", 
    apc_pdu_hardware_version = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_hardware_version).", 
    apc_pdu_ipv4_address     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_ipv4_address).", 
    apc_pdu_mac_address      = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mac_address).", 
    apc_pdu_mtu_size         = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mtu_size).", 
    apc_pdu_link_speed       = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_link_speed).", 
    apc_pdu_phase_count      = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_count).", 
    apc_pdu_outlet_count     = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_count).", 
    apc_pdu_note             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_note).", 
    modified_date            = ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
WHERE 
    apc_pdu_host_uuid        = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})." 
AND 
    apc_pdu_uuid             = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid)." 
;";
							# Now record the query in the array
							$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
								name1 => "id",    value1 => $id, 
								name2 => "query", value2 => $query
							}, file => $THIS_FILE, line => __LINE__});
							push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
						}
					}
					else
					{
						# It doesn't exist, so INSERT it.
						my $query = "
INSERT INTO 
    public.apc_pdus 
(
    apc_pdu_host_uuid, 
    apc_pdu_uuid, 
    apc_pdu_serial_number, 
    apc_pdu_model_number, 
    apc_pdu_manufacture_date, 
    apc_pdu_firmware_version, 
    apc_pdu_hardware_version, 
    apc_pdu_ipv4_address, 
    apc_pdu_mac_address, 
    apc_pdu_mtu_size, 
    apc_pdu_link_speed, 
    apc_pdu_phase_count, 
    apc_pdu_outlet_count, 
    apc_pdu_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_serial_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_model_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_manufacture_date).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_firmware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_hardware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_ipv4_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mac_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mtu_size).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_link_speed).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{public}{sql}}, $query;
					}
				}
				else
				{
					# We've seen this 'apc_pdu_uuid' before, so it is just a question of 
					# whether the entry for the current timestamp exists in the history 
					# schema.
					if (not $an->data->{db_data}{$id}{apc_pdu}{modified_date}{$modified_date}{apc_pdu_uuid}{$apc_pdu_uuid})
					{
						# It doesn't, INSERT it.
						my $query = "
INSERT INTO 
    history.apc_pdus 
(
    apc_pdu_host_uuid, 
    apc_pdu_uuid, 
    apc_pdu_serial_number, 
    apc_pdu_model_number, 
    apc_pdu_manufacture_date, 
    apc_pdu_firmware_version, 
    apc_pdu_hardware_version, 
    apc_pdu_ipv4_address, 
    apc_pdu_mac_address, 
    apc_pdu_mtu_size, 
    apc_pdu_link_speed, 
    apc_pdu_phase_count, 
    apc_pdu_outlet_count, 
    apc_pdu_note, 
    modified_date 
) VALUES (
    ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid}).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_serial_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_model_number).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_manufacture_date).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_firmware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_hardware_version).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_ipv4_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mac_address).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_mtu_size).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_link_speed).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_phase_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_outlet_count).", 
    ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_note).", 
    ".$an->data->{sys}{use_db_fh}->quote($modified_date)."
);";
						# Now record the query in the array
						$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
							name1 => "id",    value1 => $id, 
							name2 => "query", value2 => $query
						}, file => $THIS_FILE, line => __LINE__});
						push @{$an->data->{db_resync}{$id}{history}{sql}}, $query;
					} # Exist in history at timestamp?
				} # Seen apc_pdu_uuid?
			} # foreach my $id 
		} # foreach my $apc_pdu_uuid ...
	} # foreach $modified_date ...
	
	# Free up memory by deleting the DB data from the main hash.
	delete $an->data->{db_data};
	
	# Do the INSERTs now and then release the memory.
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{dbh}})
	{
		# Merge the queries with public schema queries being first.
		@{$an->data->{db_resync}{$id}{sql}} = (@{$an->data->{db_resync}{$id}{public}{sql}}, @{$an->data->{db_resync}{$id}{history}{sql}});
		if (@{$an->data->{db_resync}{$id}{sql}} > 0)
		{
			$an->DB->do_db_write({id => $id, query => $an->data->{db_resync}{$id}{sql}, source => $THIS_FILE, line => __LINE__});
			delete $an->data->{db_resync}{$id}{sql};
		}
	}
	
	return(0);
}

# This calls each PDU, first to get the model number and update the OIDs to use if needed, then gathers the 
# information from the PDU.
sub gather_pdu_data
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "gather_pdu_data" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# This will flip to 0 if any PDUs are reached.
	my $no_pdu_found = 1;
	foreach my $pdu_name (sort {$a cmp $b} keys %{$an->data->{'scan-apc-pdu'}{pdu}})
	{
		my $pdu_ip = $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name};
		$an->Log->entry({log_level => 2, message_key => "an_variables_0002", message_variables => {
			name1 => "pdu_name", value1 => $pdu_name,
			name2 => "pdu_ip",   value2 => $pdu_ip,
		}, file => $THIS_FILE, line => __LINE__});
		
		# This will be set if we can query the PDU.
		my $apc_pdu_serial_number = "";
		
		# This will get set to '1' if the PDU doesn't respond but hasn't been missing for 
		# 'scan-apc-pdu::sensor_loss_count_to_alarm' scans yet.
		$an->data->{dont_delete}{$pdu_ip} = 0;
		
		# This is used to determine if we need to set or clear a comms-lost alert.
		my $variable_name = "apc_pdu_communication_lost:$pdu_name";
		$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
			name1 => "variable_name", value1 => $variable_name, 
		}, file => $THIS_FILE, line => __LINE__});
		
		my ($pdu_missing, $variable_uuid, $modified_date) = $an->ScanCore->read_variable({
				variable_name         => $variable_name,
				variable_source_uuid  => $an->data->{sys}{host_uuid},
				variable_source_table => "apc_pdus",
			});
		$an->Log->entry({log_level => 2, message_key => "an_variables_0004", message_variables => {
			name1 => "pdu_missing",                              value1 => $pdu_missing, 
			name2 => "variable_uuid",                            value2 => $variable_uuid, 
			name3 => "modified_date",                            value3 => $modified_date, 
			name4 => "scan-apc-pdu::sensor_loss_count_to_alarm", value4 => $an->data->{'scan-apc-pdu'}{sensor_loss_count_to_alarm}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Can I ping it? This returns '1' if it was pingable, '0' if not.
		my ($pinged) = $an->Check->ping({ping => $pdu_ip});
		$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
			name1 => "pinged", value1 => $pinged, 
		}, file => $THIS_FILE, line => __LINE__});
		if (not $pinged)
		{
			# Nope. Alert the user, if this is the PDU has been missing long enough.
			if ((($pdu_missing =~ /^\d+$/) && ($pdu_missing > 0)) or ($an->data->{'scan-apc-pdu'}{sensor_loss_count_to_alarm} == 1))
			{
				# Bump the missing count to account for this scan.
				$pdu_missing++;
				$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
					name1 => "pdu_missing", value1 => $pdu_missing, 
				}, file => $THIS_FILE, line => __LINE__});
				
				# This isn't the first time it was lost. has it passed the threshold?
				if ($pdu_missing >= $an->data->{'scan-apc-pdu'}{sensor_loss_count_to_alarm})
				{
					# Is this the first time hitting this number?
					my $set = $an->Alert->check_alert_sent({
						type			=>	"warning",
						alert_sent_by		=>	$THIS_FILE,
						alert_record_locator	=>	$pdu_name,
						alert_name		=>	"apc_pdu_communication_lost",
						modified_date		=>	$an->data->{sys}{db_timestamp},
					});
					$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
						name1 => "set", value1 => $set, 
					}, file => $THIS_FILE, line => __LINE__});
					if ($set)
					{
						# It's really gone, sound the alarm.
						$an->Log->entry({log_level => 1, message_key => "scan_apc_pdu_message_0043", message_variables => { pdu_name => $pdu_name }, file => $THIS_FILE, line => __LINE__});
						$an->Alert->register_alert({
							alert_level		=>	"warning", 
							alert_agent_name	=>	$THIS_FILE,
							alert_title_key		=>	"an_alert_title_0004",
							alert_message_key	=>	"scan_apc_pdu_message_0004",
							alert_message_variables	=>	{
								pdu_name		=>	$pdu_name,
							},
						});
						
						# If we've seen this PDU before, make it's note as DELETED
						my $query = "
SELECT 
    apc_pdu_uuid 
FROM 
    apc_pdus 
WHERE 
    apc_pdu_ipv4_address = ".$an->data->{sys}{use_db_fh}->quote($pdu_ip)."
AND 
    apc_pdu_host_uuid    = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})."
;";
						$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
							name1 => "query", value1 => $query, 
						}, file => $THIS_FILE, line => __LINE__});
						
						my $apc_pdu_uuid = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__})->[0]->[0];
						$apc_pdu_uuid = "" if not defined $apc_pdu_uuid;
						$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
							name1 => "apc_pdu_uuid", value1 => $apc_pdu_uuid, 
						}, file => $THIS_FILE, line => __LINE__});
						if ($apc_pdu_uuid)
						{
							# Mark it as DELETED
							my $query = "
UPDATE 
    apc_pdus 
SET 
    apc_pdu_note  = 'DELETED', 
    modified_date = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{db_timestamp})."
WHERE 
    apc_pdu_uuid  = ".$an->data->{sys}{use_db_fh}->quote($apc_pdu_uuid)."
;";
							$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
								name1 => "query", value1 => $query, 
							}, file => $THIS_FILE, line => __LINE__});
							$an->DB->do_db_write({query => $query, source => $THIS_FILE, line => __LINE__});
						}
					}
				}
				else
				{
					# It is gone, but it's not the first time and we've not 
					# passed the alert threshold. 
					$an->data->{dont_delete}{$pdu_ip} = 1;
					$an->Log->entry({log_level => 1, message_key => "scan_apc_pdu_message_0044", message_variables => { 
						pdu_name => $pdu_name,
						scans    => $pdu_missing,
					}, file => $THIS_FILE, line => __LINE__});
					$an->ScanCore->insert_or_update_variables({
						variable_uuid         => $variable_uuid, 
						variable_name         => $variable_name,
						variable_value        => $pdu_missing,
						variable_source_uuid  => $an->data->{sys}{host_uuid}, 
						variable_source_table => "apc_pdus", 
						update_value_only     => 1,
					});
				}
			}
			else
			{
				# It is. Set the loss count to 1
				$an->data->{dont_delete}{$pdu_ip} = 1;
				$an->Log->entry({log_level => 1, message_key => "scan_apc_pdu_message_0045", message_variables => { pdu_name => $pdu_name }, file => $THIS_FILE, line => __LINE__});
				$an->ScanCore->insert_or_update_variables({
					variable_uuid         => $variable_uuid, 
					variable_name         => $variable_name,
					variable_value        => 1,
					variable_source_uuid  => $an->data->{sys}{host_uuid}, 
					variable_source_table => "apc_pdus", 
					update_value_only     => 1,
				});
			}
		}
		else
		{
			# Yup!
			$apc_pdu_serial_number = read_oid($an, $pdu_ip,, $an->data->{oids}{apc_pdu}{apc_pdu_serial_number});
			$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
				name1 => "apc_pdu_serial_number", value1 => $apc_pdu_serial_number, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# These are set to avoid 'undefined' variable warnings later if we fail to reach this PDU.
			$an->data->{pdu}{$apc_pdu_serial_number}{pdu_host_name}                         = $pdu_name;
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_serial_number}        = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_model_number}         = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date}     = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_firmware_version}     = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_hardware_version}     = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_ipv4_address}         = $pdu_ip;
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mac_address}          = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mtu_size}             = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_link_speed}           = 0;
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count}          = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count}         = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}             = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw} = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum}                     = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning}                 = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning}                = "";
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical}               = "";
			
			# Record the SN, mark that we accessed it and create a look-up for SN to name
			$an->data->{serial_to_name}{$apc_pdu_serial_number} = $pdu_name;
			$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
				name1 => "serial_to_name::$apc_pdu_serial_number", value1 => $an->data->{serial_to_name}{$apc_pdu_serial_number}, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# If I had previously lost this PDU, clear the alert and let the user know we're 
			# back.
			my $cleared = $an->Alert->check_alert_sent({
				type			=>	"clear",
				alert_sent_by		=>	$THIS_FILE,
				alert_record_locator	=>	$pdu_name,
				alert_name		=>	"apc_pdu_communication_lost",
				modified_date		=>	$an->data->{sys}{db_timestamp},
			});
			$an->Log->entry({log_level => 2, message_key => "an_variables_0001", message_variables => {
				name1 => "cleared", value1 => $cleared, 
			}, file => $THIS_FILE, line => __LINE__});
			if ($cleared)
			{
				# There was an alert and it has now been cleared.
				$an->Alert->register_alert({
					alert_level		=>	"warning", 
					alert_agent_name	=>	$THIS_FILE,
					alert_title_key		=>	"an_alert_title_0006",
					alert_message_key	=>	"scan_apc_pdu_message_0005",
					alert_message_variables	=>	{
						pdu_name		=>	$pdu_name,
					},
				});
			}
			
			# If the PDU was missing before, clear it.
			if (($pdu_missing =~ /^\d+$/) && ($pdu_missing > 0))
			{
				# It disappeared in a previous sweep. Set the variable to 0.
				$an->Log->entry({log_level => 1, message_key => "scan_apc_pdu_message_0046", message_variables => { pdu_name => $pdu_name }, file => $THIS_FILE, line => __LINE__});
				$an->ScanCore->insert_or_update_variables({
					variable_uuid         => $variable_uuid, 
					variable_name         => $variable_name,
					variable_value        => 0,
					variable_source_uuid  => $an->data->{sys}{host_uuid}, 
					variable_source_table => "apc_pdus", 
					update_value_only     => 1,
				});
			}
		}
		
		# If I got the serial number, I found the PDU.
		next if not $apc_pdu_serial_number;
		
		# If I am still alive, I've found at least one PDU.
		$no_pdu_found = 0;
		
		#############################################################################################
		# Base PDU info                                                                             #
		#############################################################################################
		
		# Get the base PDU info.
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_model_number}     =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_model_number});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date} =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_manufacture_date});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_firmware_version} =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_firmware_version});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_hardware_version} =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_hardware_version});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mac_address}      =  lc(read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_mac_address}, $an->data->{path}{striker_mib}));
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mac_address}      =~ s/ /:/g;
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mtu_size}         =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_mtu_size});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_link_speed}       =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_link_speed});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count}      =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_phase_count});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count}     =  read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu}{apc_pdu_outlet_count});
		
		# These change often and will go into the 'variables' table
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}             = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_variables}{uptime});
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw} = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_variables}{total_wattage_draw});
		
		# These are used later for checking the state of the phases. They are not stored in the database.
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum}       = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_phases}{apc_pdu_phase_max_amperage});
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning}   = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_phases}{phase_low_amp_warning});
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning}  = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_phases}{phase_high_amp_warning});
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical} = read_oid($an, $pdu_ip, $an->data->{oids}{apc_pdu_phases}{phase_high_amp_critical});
		
		$an->Log->entry({log_level => 3, message_key => "an_variables_0016", message_variables => {
			name1  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_model_number",         value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_model_number}, 
			name2  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_manufacture_date",     value2  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date}, 
			name3  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_firmware_version",     value3  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_firmware_version}, 
			name4  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_hardware_version",     value4  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_hardware_version}, 
			name5  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_ipv4_address",         value5  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_ipv4_address}, 
			name6  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_mac_address",          value6  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mac_address}, 
			name7  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_mtu_size",             value7  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_mtu_size}, 
			name8  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_link_speed",           value8  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_link_speed}, 
			name9  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_phase_count",          value9  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count}, 
			name10 => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_outlet_count",         value10 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count}, 
			name11 => "pdu::${apc_pdu_serial_number}::apc_pdu_variables::uptime",             value11 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}, 
			name12 => "pdu::${apc_pdu_serial_number}::apc_pdu_variables::total_wattage_draw", value12 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{total_wattage_draw}, 
			name13 => "pdu::${apc_pdu_serial_number}::amperage::maximum",                     value13 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum}, 
			name14 => "pdu::${apc_pdu_serial_number}::amperage::low_warning",                 value14 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning}, 
			name15 => "pdu::${apc_pdu_serial_number}::amperage::high_warning",                value15 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning}, 
			name16 => "pdu::${apc_pdu_serial_number}::amperage::high_critical",               value16 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		### TODO: We should probably sanity check the various values. Error or set?
		
		# If the (high critical amperage + 'scan-apc-pdu::critical_amps_below_max') > maximum 
		# amperage, we'll set the critical warning level to be 
		# (maximum - 'scan-apc-pdu::critical_amps_below_max')
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1  => "scan-apc-pdu::critical_amps_below_max", value1  => $an->data->{'scan-apc-pdu'}{critical_amps_below_max}, 
		}, file => $THIS_FILE, line => __LINE__});
		if (($an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical} + $an->data->{'scan-apc-pdu'}{critical_amps_below_max}) > $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum})
		{
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical} = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{maximum} - $an->data->{'scan-apc-pdu'}{critical_amps_below_max};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1  => "pdu::${apc_pdu_serial_number}::amperage::high_critical", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical}, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		
		# Make sure that the warning is at least 'scan-apc-pdu::warning_amps_below_critical'
		if (($an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning} + $an->data->{'scan-apc-pdu'}{warning_amps_below_critical}) > $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical})
		{
			$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning} = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical} - $an->data->{'scan-apc-pdu'}{warning_amps_below_critical};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1  => "pdu::${apc_pdu_serial_number}::amperage::high_warning", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning}, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		
		# Set the alert clear levels
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_critical} = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_critical} - $an->data->{'scan-apc-pdu'}{clear_alert_threshold};
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_warning}  = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{high_warning} - $an->data->{'scan-apc-pdu'}{clear_alert_threshold};
		$an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_low_warning}   = $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{low_warning} + $an->data->{'scan-apc-pdu'}{clear_alert_threshold};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
			name1 => "pdu::${apc_pdu_serial_number}::amperage::clear_high_critical", value1 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_critical}, 
			name2 => "pdu::${apc_pdu_serial_number}::amperage::clear_high_warning",  value2 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_high_warning}, 
			name3 => "pdu::${apc_pdu_serial_number}::amperage::clear_low_warning",   value3 => $an->data->{pdu}{$apc_pdu_serial_number}{amperage}{clear_low_warning}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Uptime is in ticks
		$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime} /= $an->data->{'scan-apc-pdu'}{ticks_per_second};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1  => "pdu:${apc_pdu_serial_number}::apc_pdu_variables::uptime", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_variables}{uptime}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# The dates are in 'mm/dd/yyyy' or 'mm/dd/yy' format, convert them to 'yyyy/mm/dd'
		if ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date} =~ /(\d\d)\/(\d\d)\/(\d\d\d\d)$/)
		{
			my $year  = $3;
			my $month = $1;
			my $day   = $2;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "year",  value1 => $year, 
				name2 => "month", value2 => $month, 
				name3 => "day",   value3 => $day, 
			}, file => $THIS_FILE, line => __LINE__});
			
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date} = $year."/".$month."/".$day;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_manufacture_date", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date}, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		elsif ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date} =~ /(\d\d)\/(\d\d)\/(\d\d)$/)
		{
			my $year  = $3;
			my $month = $1;
			my $day   = $2;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "year",  value1 => $year, 
				name2 => "month", value2 => $month, 
				name3 => "day",   value3 => $day, 
			}, file => $THIS_FILE, line => __LINE__});
			
			if ($year < 70)
			{
				$year += 2000;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "year", value1 => $year, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			else
			{
				$year += 1900;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "year", value1 => $year, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date} = $year."/".$month."/".$day;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1  => "pdu::${apc_pdu_serial_number}::apc_pdu::apc_pdu_manufacture_date", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_manufacture_date}, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		
		# Read the phase data
		if ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count} !~ /^\d+$/)
		{
			### TODO: Should this be an error?
			print "Failed to read the number of phases for the PDU: [$apc_pdu_serial_number]\n";
			exit(1);
		}
		foreach my $apc_pdu_phase_number (1..$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_phase_count})
		{
			# Stick the phase onto the end of the OID.
			my $oid = $an->data->{oids}{apc_pdu_phases}{apc_pdu_phase_current_amperage}.$apc_pdu_phase_number;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
				name1 => "apc_pdu_phase_number", value1 => $apc_pdu_phase_number, 
				name2 => "oid",                  value2 => $oid, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Read the OID
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage} = read_oid($an, $pdu_ip, $oid);
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1  => "pdu::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_current_amperage", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage}, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# The amperage is in 1/10 amps, so divide by 10.
			if ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage} =~ /^\d+$/)
			{
				$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage} /= 10;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1  => "pdu::${apc_pdu_serial_number}::apc_pdu_phases::${apc_pdu_phase_number}::apc_pdu_phase_current_amperage", value1  => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_phases}{$apc_pdu_phase_number}{apc_pdu_phase_current_amperage}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
		}
		
		# Read the outlet data
		if ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count} !~ /^\d+$/)
		{
			### TODO: Should this be an error?
			print "Failed to read the number of outlets for the PDU: [$apc_pdu_serial_number]\n";
			exit(2);
		}
		foreach my $apc_pdu_outlet_number (1..$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu}{apc_pdu_outlet_count})
		{
			# Stick the outlet onto the end of the OIDs.
			my $outlet_name_oid  = $an->data->{oids}{apc_pdu_outlets}{apc_pdu_outlet_name}.$apc_pdu_outlet_number;
			my $outlet_phase_oid = $an->data->{oids}{apc_pdu_outlets}{apc_pdu_outlet_on_phase}.$apc_pdu_outlet_number;
			my $outlet_state_oid = $an->data->{oids}{apc_pdu_outlets}{apc_pdu_outlet_state}.$apc_pdu_outlet_number;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "outlet_name_oid",  value1 => $outlet_name_oid, 
				name2 => "outlet_phase_oid", value2 => $outlet_phase_oid, 
				name3 => "outlet_state_oid", value3 => $outlet_state_oid, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Read the OID
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name}     = read_oid($an, $pdu_ip, $outlet_name_oid);
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase} = read_oid($an, $pdu_ip, $outlet_phase_oid);
			$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}    = read_oid($an, $pdu_ip, $outlet_state_oid);
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_name",     value1 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_name}, 
				name2 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_on_phase", value2 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_on_phase}, 
				name3 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_state",    value3 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# The state is; 1 = on, 2 = off, 4 = unknown
			if ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} eq "1")
			{
				$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} = "on";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_state", value1 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			elsif ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} eq "2")
			{
				$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} = "off";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_state", value1 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			elsif ($an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} eq "3")
			{
				$an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state} = "unknown";
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "pdu::${apc_pdu_serial_number}::apc_pdu_outlets::${apc_pdu_outlet_number}::apc_pdu_outlet_state", value1 => $an->data->{pdu}{$apc_pdu_serial_number}{apc_pdu_outlets}{$apc_pdu_outlet_number}{apc_pdu_outlet_state}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
		}
	}
	
	return($no_pdu_found);
}

# This will archive stuff in the 'history' schema, if needed.
sub archive_if_needed
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "archive_if_needed" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# If the 'trigger' is '0', archiving is disabled.
	if (not $an->data->{scancore}{archive}{trigger})
	{
		return(1);
	}
	
	### NOTE: If a ScanCore db server was offline when an archive ran, when it returns, it's records will
	###       sync back, triggering a sooner-than-expected subsequent archive. This shouldn't happen 
	###       often, and the complexity of tracking archive dates is such that we'll not try to account
	###       for these cases. 
	### TODO: What we can do later is, when we write the restore stuff, build in a dedupe function.
	
	### Process:
	# 1. Count the records in history for each table, restricting the results to those from this host 
	#    (save for special tables like 'server') and if the number of records is greater than 
	#    'scancore::archive::trigger', start an archive.
	# 2. Set/update the 'archive_date' state.
	# 3. Lock the database.
	# 4. Select 'modified_date' from history.foo, offset by 
	#    ('scancore::archive::trigger' - 'scancore::archive::count').
	# 5. Make sure the 'scancore::archive::directory' exists, creating it if needed.
	# 6. Select all records older that the 'modified_date', write them to a file and then DELETE those
	#    records from the database.
	
	# Update the archive path, if set by a user. Also verify that there are sane archive values.
	$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
		name1 => "path::scancore_archive",       value1 => $an->data->{path}{scancore_archive}, 
		name2 => "scancore::archive::directory", value2 => $an->data->{scancore}{archive}{directory}, 
		name3 => "scancore::archive::trigger",   value3 => $an->data->{scancore}{archive}{trigger}, 
		name4 => "scancore::archive::count",     value4 => $an->data->{scancore}{archive}{count}, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($an->data->{scancore}{archive}{directory} =~ /\/.*/)
	{
		$an->data->{path}{scancore_archive} = $an->data->{scancore}{archive}{directory};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "path::scancore_archive", value1 => $an->data->{path}{scancore_archive}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	if ((not $an->data->{scancore}{archive}{trigger}) or ($an->data->{scancore}{archive}{trigger} =~ /\D/))
	{
		$an->data->{scancore}{archive}{trigger} = 100000;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "scancore::archive::trigger", value1 => $an->data->{scancore}{archive}{trigger}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	if ((not $an->data->{scancore}{archive}{count}) or ($an->data->{scancore}{archive}{count} =~ /\D/))
	{
		$an->data->{scancore}{archive}{count} = 50000;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "scancore::archive::count", value1 => $an->data->{scancore}{archive}{count}, 
		}, file => $THIS_FILE, line => __LINE__});
	}
	
	if (not -e $an->data->{path}{scancore_archive})
	{
		my $shell_call = $an->data->{path}{'mkdir'}." -p '".$an->data->{path}{scancore_archive}."'";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "shell_call", value1 => $shell_call, 
		}, file => $THIS_FILE, line => __LINE__});
		open (my $file_handle, "$shell_call 2>&1 |") or $an->Alert->error({title_key => "an_0003", message_key => "error_title_0014", message_variables => { shell_call => $shell_call, error => $! }, code => 2, file => $THIS_FILE, line => __LINE__});
		while(<$file_handle>)
		{
			chomp;
			my $line = $_;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "line", value1 => $line, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		close $file_handle;
		
		# Did it work?
		if (not -e $an->data->{path}{scancore_archive})
		{
			# Nope. :(
			$an->Alert->warning({message_key => "scancore_warning_0030", message_variables => { directory => $an->data->{path}{scancore_archive} }, quiet => 1, file => $THIS_FILE, line => __LINE__});
			return(1);
		}
	}
	
	$an->data->{archive}{table} = {
		apc_pdus		=>	{
			archive_date		=>	"",
			host_column		=>	"apc_pdu_host_uuid",
			offset			=>	0,
		},
		apc_pdu_phases		=>	{
			archive_date		=>	"",
			host_column		=>	"apc_pdu_phase_host_uuid",
			offset			=>	0,
		},
		apc_pdu_outlets		=>	{
			archive_date		=>	"",
			host_column		=>	"apc_pdu_outlet_host_uuid",
			offset			=>	0,
		},
		apc_pdu_variables	=>	{
			archive_date		=>	"",
			host_column		=>	"apc_pdu_variable_host_uuid",
			offset			=>	0,
		},
	};
	my $archive_needed = 0;
	foreach my $table (sort {$a cmp $b} keys %{$an->data->{archive}{table}})
	{
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "table", value1 => $table, 
		}, file => $THIS_FILE, line => __LINE__});
		
		my $query = "
SELECT 
    COUNT(*) 
FROM 
    history.$table 
WHERE 
    ".$an->data->{archive}{table}{$table}{host_column}." = ".$an->data->{sys}{use_db_fh}->quote($an->data->{sys}{host_uuid})."
;";
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "query", value1 => $query, 
		}, file => $THIS_FILE, line => __LINE__});
		
		my $records = $an->DB->do_db_query({query => $query, source => $THIS_FILE, line => __LINE__})->[0]->[0];
		   $records = 0 if not defined $records;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "records", value1 => $records, 
		}, file => $THIS_FILE, line => __LINE__});
		
		if ($records > $an->data->{scancore}{archive}{trigger})
		{
			   $archive_needed                             = 1;
			my $records_to_save                            = ($an->data->{scancore}{archive}{trigger} - $an->data->{scancore}{archive}{count});
			my $offset                                     = $records - $records_to_save;
			   $an->data->{archive}{table}{$table}{offset} = $offset;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "archive_needed",                   value1 => $archive_needed, 
				name2 => "records_to_save",                  value2 => $records_to_save, 
				name3 => "archive::table::${table}::offset", value3 => $an->data->{archive}{table}{$table}{offset}, 
			}, file => $THIS_FILE, line => __LINE__});
		}
	}
	
	# If I have something to archive, do so now.
	if ($archive_needed)
	{
		# This will store the files to compress after we release the locks.
		my $compress = [];
		
		# Request a lock.
		$an->DB->locking({request => 1});
		
		# Now loop through the table(s) that need to be archived.
		foreach my $table (sort {$a cmp $b} keys %{$an->data->{archive}{table}})
		{
			next if not $an->data->{archive}{table}{$table}{offset};
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "table", value1 => $table, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Now to do the archive.
			if ($table eq "apc_pdus")
			{
				$an->DB->archive_table({
					table        => $table, 
					offset       => $an->data->{archive}{table}{$table}{offset}, 
					conditionals => { $an->data->{archive}{table}{$table}{host_column} => $an->data->{sys}{host_uuid} },
					columns      => ["apc_pdu_uuid", "apc_pdu_host_uuid", "apc_pdu_serial_number", "apc_pdu_model_number", "apc_pdu_manufacture_date", "apc_pdu_firmware_version", "apc_pdu_hardware_version", "apc_pdu_ipv4_address", "apc_pdu_mac_address", "apc_pdu_mtu_size", "apc_pdu_link_speed", "apc_pdu_phase_count", "apc_pdu_outlet_count", "apc_pdu_note"],
				});
			}
			elsif ($table eq "apc_pdu_phases")
			{
				$an->DB->archive_table({
					table        => $table, 
					offset       => $an->data->{archive}{table}{$table}{offset}, 
					conditionals => { $an->data->{archive}{table}{$table}{host_column} => $an->data->{sys}{host_uuid} },
					columns      => ["apc_pdu_phase_uuid", "apc_pdu_phase_apc_pdu_uuid", "apc_pdu_phase_host_uuid", "apc_pdu_phase_number", "apc_pdu_phase_current_amperage", "apc_pdu_phase_max_amperage", "apc_pdu_phase_note"],
				});
			}
			elsif ($table eq "apc_pdu_outlets")
			{
				$an->DB->archive_table({
					table        => $table, 
					offset       => $an->data->{archive}{table}{$table}{offset}, 
					conditionals => { $an->data->{archive}{table}{$table}{host_column} => $an->data->{sys}{host_uuid} },
					columns      => ["apc_pdu_outlet_uuid", "apc_pdu_outlet_apc_pdu_uuid", "apc_pdu_outlet_host_uuid", "apc_pdu_outlet_number", "apc_pdu_outlet_name", "apc_pdu_outlet_on_phase", "apc_pdu_outlet_state", "apc_pdu_outlet_note"],
				});
			}
			elsif ($table eq "apc_pdu_variables")
			{
				$an->DB->archive_table({
					table        => $table, 
					offset       => $an->data->{archive}{table}{$table}{offset}, 
					conditionals => { $an->data->{archive}{table}{$table}{host_column} => $an->data->{sys}{host_uuid} },
					columns      => ["apc_pdu_variable_uuid", "apc_pdu_variable_host_uuid", "apc_pdu_variable_apc_pdu_uuid", "apc_pdu_variable_is_temperature", "apc_pdu_variable_name", "apc_pdu_variable_value"],
				});
			}
		}
		
		### TODO: Make this less of a hackish mc-hackington...
		# VACUUM FULL, if the database is on this machine. I need to do this from the command line 
		# because the user we connect as isn't allowed to do it. We'll also only vacuum our DB.
		my $db_name = "";
		foreach my $id (sort {$a cmp $b} keys %{$an->data->{scancore}{db}})
		{
			$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
				name1 => "id",                        value1 => $id, 
				name2 => "scancore::db::${id}::host", value2 => $an->data->{scancore}{db}{$id}{host}, 
				name3 => "hostname",                  value3 => $an->hostname, 
				name4 => "short_hostname",            value4 => $an->short_hostname, 
			}, file => $THIS_FILE, line => __LINE__});
			if (($an->data->{scancore}{db}{$id}{host} eq $an->hostname) or ($an->data->{scancore}{db}{$id}{host} eq $an->short_hostname))
			{
				$db_name = $an->data->{scancore}{db}{$id}{name};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
					name1 => "db_name",                   value1 => $db_name, 
					name2 => "scancore::db::${id}::name", value2 => $an->data->{scancore}{db}{$id}{name}, 
				}, file => $THIS_FILE, line => __LINE__});
				last;
			}
		}
		if ($db_name)
		{
			my $start      = time;
			my $shell_call = $an->data->{path}{su}." - postgres -c \"".$an->data->{path}{psql}." $db_name -c 'VACUUM FULL;'\"";
			$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
				name1 => "start",      value1 => $start, 
				name2 => "shell_call", value2 => $shell_call, 
			}, file => $THIS_FILE, line => __LINE__});
			open (my $file_handle, "$shell_call 2>&1 |") or $an->Alert->error({title_key => "an_0003", message_key => "error_title_0014", message_variables => { shell_call => $shell_call, error => $! }, code => 2, file => $THIS_FILE, line => __LINE__});
			while(<$file_handle>)
			{
				chomp;
				my $line = $_;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "line", value1 => $line, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			close $file_handle;
			
			my $finished = time - $start;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "finished", value1 => $finished, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		
		# Release the lock
		$an->DB->locking({release => 1});
	}
	
	return(0);
}

# This looks for APC PDUs.
sub find_pdus
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "find_pdus" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	$an->data->{'scan-apc-pdu'}{pdus} = $an->data->{switches}{pdus} if $an->data->{switches}{pdus};
	if ($an->data->{'scan-apc-pdu'}{pdus})
	{
		# User has specified the PDUs to query. We'll resolve them to IPs.
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "scan-apc-pdu::pdus", value1 => $an->data->{'scan-apc-pdu'}{pdus}, 
		}, file => $THIS_FILE, line => __LINE__});
		foreach my $pdu_name (split/,/, $an->data->{'scan-apc-pdu'}{pdu})
		{
			next if not $pdu_name;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "pdu_name", value1 => $pdu_name, 
			}, file => $THIS_FILE, line => __LINE__});
			
			my $ip        = "";
			my $packed_ip = gethostbyname($pdu_name);
			if ($packed_ip)
			{
				$ip = inet_ntoa($packed_ip);
				$an->data->{'scan-apc-pdu'}{pdu}{$pdu_name} = $ip;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "scan-apc-pdu::pdu::$pdu_name", value1 => $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			else
			{
				# Failed to get IP
				die "$THIS_FILE ".__LINE__."; No IP found for PDU name: [$pdu_name].\n";
			}
		}
	}
	else
	{
		# Read in /etc/hosts and look for anything with 'pdu' in the name.
		my $shell_call = "<".$an->data->{path}{etc_hosts};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "shell_call", value1 => $shell_call, 
		}, file => $THIS_FILE, line => __LINE__});
		open (my $file_handle, $shell_call) or $an->Alert->error({title_key => "an_0003", message_key => "error_title_0016", message_variables => { shell_call => $shell_call, error => $! }, code => 2, file => $THIS_FILE, line => __LINE__});
		while(<$file_handle>)
		{
			chomp;
			my $line = $_;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "line", value1 => $line, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Clear out comments, knock out white spaces and then skip anything without 'pdu' in
			# the name.
			$line =~ s/#.*$//;
			$line =~ s/^\s+//;
			$line =~ s/\s+$//;
			$line =~ s/\s+/ /g;
			next if not $line;
			next if $line !~ /pdu/;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "line", value1 => $line, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# This should be a PDU entry.
			my ($ip, $names) = ($line =~ /^(\d+\.\d+\.\d+\.\d+) (.*)/);
			$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
				name1 => "ip",    value1 => $ip, 
				name2 => "names", value2 => $names,
			}, file => $THIS_FILE, line => __LINE__});
			
			# It is crude, but we'll use the longest host name.
			my $pdu_name = "";
			foreach my $name (split/ /, $names)
			{
				if (length($name) > length($pdu_name))
				{
					$pdu_name = $name;
				}
			}
			if (($pdu_name) && ($ip))
			{
				$an->data->{'scan-apc-pdu'}{pdu}{$pdu_name} = $ip;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "scan-apc-pdu::pdu::$pdu_name", value1 => $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name}, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			else
			{
				# Bad name or IP.
				die "$THIS_FILE ".__LINE__."; Bad name: [$pdu_name] or IP: [$ip]\n";
			}
		}
		close $file_handle;
		
		# If I am a dashboard, read in the cache files for the PDUs that nodes know about and see if
		# we can ping them. If we can, we'll scan them. This will be important for dashboards to 
		# determine if/when it is safe to boot a node.
		my $host_type = $an->Get->what_am_i();
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "host_type", value1 => $host_type, 
		}, file => $THIS_FILE, line => __LINE__});
		if ($host_type eq "dashboard")
		{
			# Loop through all Anvil! systems.
			my $all_pdus  = {};
			my $anvil_data = $an->ScanCore->get_anvils();
			foreach my $hash_ref (@{$anvil_data})
			{
				my $anvil_uuid = $hash_ref->{anvil_uuid};
				$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
					name1 => "anvil_uuid", value1 => $anvil_uuid, 
				}, file => $THIS_FILE, line => __LINE__});
				
				my ($pdus) = $an->Get->node_pdus({
						anvil_uuid => $anvil_uuid,
						node_name  => "both",
					});
				
				# Record 
				foreach my $ip (sort {$a cmp $b} keys %{$pdus})
				{
					my $pdu_name = $pdus->{$ip}{name};
					$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
						name1 => "pdu_name", value1 => $pdu_name, 
					}, file => $THIS_FILE, line => __LINE__});
					
					if (not exists $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name})
					{
						$an->data->{'scan-apc-pdu'}{pdu}{$pdu_name} = $ip;
						$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
							name1 => "scan-apc-pdu::pdu::$pdu_name", value1 => $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name}, 
						}, file => $THIS_FILE, line => __LINE__});
					}
				}
			}
		}
	}
	
	# Here is what I found;
	foreach my $pdu_name (sort {$a cmp $b} keys %{$an->data->{'scan-apc-pdu'}{pdu}})
	{
		my $ip = $an->data->{'scan-apc-pdu'}{pdu}{$pdu_name};
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "pdu_name", value1 => $pdu_name, 
			name2 => "ip",       value2 => $ip, 
		}, file => $THIS_FILE, line => __LINE__});
	}
}

# This reads an OID and returns the results.
sub read_oid
{
	my ($an, $pdu, $oid, $mib) = @_;
	$mib = "" if not defined $mib;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "read_oid" }, message_key => "an_variables_0003", message_variables => { 
		name1 => "pdu", value1 => $pdu, 
		name2 => "oid", value2 => $oid, 
		name3 => "mib", value3 => $mib, 
	}, file => $THIS_FILE, line => __LINE__});
	
	### TODO: Make these proper errors
	die "No PDU passed!\n" if not $pdu;
	die "No OID passed!\n" if not $oid;
	
	my $value      = "#!no_value!#";
	my $shell_call = $an->data->{path}{snmpget}." -v 2c -c ".$an->data->{snmp}{community}{'read'}." $pdu $oid";
	if ($mib)
	{
		$shell_call = $an->data->{path}{snmpget}." -v 2c -c ".$an->data->{snmp}{community}{'read'}." -m $mib $pdu $oid";
	}
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "shell_call", value1 => "$shell_call"
	}, file => $THIS_FILE, line => __LINE__});
	open (my $file_handle, "$shell_call 2>&1 |") or $an->Alert->error({title_key => "an_0003", message_key => "error_title_0015", message_variables => { shell_call => $shell_call, error => $! }, code => 2, file => $THIS_FILE, line => __LINE__});
	while(<$file_handle>)
	{
		chomp;
		my $line = $_;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "line", value1 => "$line"
		}, file => $THIS_FILE, line => __LINE__});
		
		if ($line =~ /No Response/i)
		{
			$value = "#!no_connection!#";
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /STRING: "(.*)"$/i)
		{
			$value = $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		elsif ($line =~ /STRING: (.*)$/i)
		{
			$value = $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /INTEGER: (\d+)$/i)
		{
			$value = $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /Hex-STRING: (.*)$/i)
		{
			$value = $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /Gauge32: (.*)$/i)
		{
			$value =  $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /Timeticks: \((\d+)\) /i)
		{
			$value =  $1;
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		if ($line =~ /No Such Instance/i)
		{
			$value = "--";
			$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
				name1 => "value", value1 => $value, 
			}, file => $THIS_FILE, line => __LINE__});
		}
	}
	close $file_handle;
	
	# Strip leading and trailing white spaces
	$value =~ s/^\s+//;
	$value =~ s/\s+$//;
	
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "value", value1 => $value, 
	}, file => $THIS_FILE, line => __LINE__});
	return($value);
}

# This checks to see if this agent's databases tables exist and, if not, load the schema. If the schema gets
# loaded, we'll check other databases for older information and load it.
sub prep_databases
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "prep_databases" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	$an->Log->entry({log_level => 3, message_key => "scancore_log_0016", message_variables => { agent => $THIS_FILE }, file => $THIS_FILE, line => __LINE__});
	foreach my $id (sort {$a cmp $b} keys %{$an->data->{scancore}{db}})
	{
		my $query = "SELECT COUNT(*) FROM pg_catalog.pg_tables WHERE tablename='apc_pdus' AND schemaname='public';";
		#                     The actual query -----------------.        .------- Row 0
		#                        Query this DB --.              |        |    .-- Columns 0
		my $count = $an->DB->do_db_query({id => $id, query => $query, source => $THIS_FILE, line => __LINE__})->[0]->[0];
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "count", value1 => $count
		}, file => $THIS_FILE, line => __LINE__});
		if ($count < 1)
		{
			# Need to load the database schema.
			$an->Log->entry({log_level => 1, message_key => "scancore_log_0017", file => $THIS_FILE, line => __LINE__});
			$an->DB->load_schema({id => $id, file => $an->data->{path}{sql}});
			
			# Send an alert telling the user that we've initialized this database.
			$an->Alert->register_alert({
				alert_level		=>	"notice", 
				alert_agent_name	=>	$THIS_FILE,
				alert_title_key		=>	"an_alert_title_0003",
				alert_message_key	=>	"notice_message_0002",
				alert_message_variables	=>	{
					name			=>	$an->data->{scancore}{db}{$id}{name},
					host			=>	$an->data->{scancore}{db}{$id}{host},
					agent			=>	$THIS_FILE,
				},
			});
		}
		else
		{
			# Table exists, schema load is not needed.
			$an->Log->entry({log_level => 3, message_key => "scancore_log_0018", file => $THIS_FILE, line => __LINE__});
		}
	}
	
	return(0);
}

# Print the usage information.
sub print_usage
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "print_usage" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	print $an->String->get({key => "scan_apc_pdu_message_0002"})."\n";

	return(0);
}
