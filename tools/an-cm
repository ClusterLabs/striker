#!/usr/bin/perl
# 
# AN!CM - Cluster Monitor
# 
# This program watches the hardware and cluster stack for changes, sending
# alert emails when needed.
# 

use strict;
use warnings;
require "./an-cm.lib";
our $THIS_FILE = "an-cm";

$SIG{INT}  = \&catch_sig;
$SIG{TERM} = \&catch_sig;

my $conf = {
	cluster		=>	{
# 		name		=>	"pp-cluster-01",
# 		description	=>	"Plastic Plus \"Cluster 01\"",
# 		nodes		=>	["pp-c01n01", "pp-c01n02"],
# 		company		=>	"CC Systems",

# 		name		=>	"cc-cluster-02",
# 		description	=>	"CC Systems \"Cluster 02\" in Oakville",
# 		nodes		=>	["cc-c02n01", "cc-c02n02"],
# 		company		=>	"CC Systems",
		
		name		=>	"an-cluster-01",
		description	=>	"Alteeve's Niche! \"Cluster 01\" (in Oakville)",
		nodes		=>	["an-c01n01", "an-c01n02"],
		company		=>	"Alteeve's Niche!",
	},
	node		=>	{
		me		=>	{
			long_name	=>	"",
			short_name	=>	"",
		},
		peer		=>	{
			long_name	=>	"",
			short_name	=>	"",
		},
	},
	smtp		=>	{
		server		=>	"mail.alteeve.ca",
		port		=>	587,
		timeout		=>	60,
		username	=>	"clusters\@alteeve.ca",
		password	=>	"file:./email_pw.txt",
		security	=>	"STARTTLS",
		encrypt_pass	=>	1,
		helo_domain	=>	"alteeve.ca",
	},
	mail_data	=>	{
		to		=>	"alert\@alteeve.ca",
		sending_domain	=>	"mail.alteeve.ca",
		subject		=>	"test",
		body		=>	"test",
	},
	handles			=>	{
		'log'			=>	"",
	},
	path		=>	{
		'log'		=>	"/var/log/an-cm.log",
		uname		=>	"/bin/uname",
		clustat		=>	"/usr/sbin/clustat",
		pgrep		=>	"/usr/bin/pgrep",
		ifconfig	=>	"/sbin/ifconfig",
		brctl		=>	"/usr/sbin/brctl",
		MegaCli64	=>	"/opt/MegaRAID/MegaCli/MegaCli64",
	},
	'system'	=>	{
		sleep_time	=>	10,
		storage_type	=>	"",
	},
};

avoid_duplicate_run($conf);
get_hostname($conf);
$conf->{mail_data}{subject_prefix} = "[ AN-CM ] - $conf->{cluster}{company} - $conf->{cluster}{name} - $conf->{node}{me}{short_name}";
$conf->{mail_data}{body_suffix}    = "
--[ Source Details ]--------------------------------------------------
Company: $conf->{cluster}{company}
Cluster: $conf->{cluster}{name}
Node:    $conf->{node}{me}{long_name}
Description:
 - $conf->{cluster}{description}

If you have any questions or concerns, please don't hesitate to
contact support. 

                    https://alteeve.com/w/Support

                                                     Alteeve's Niche!
                                                      Cluster Monitor
----------------------------------------------------------------------
--
You received this email because you were listed as a contact for the
AN!Cluster described in this email. If you do not wish to receives
these emails, please contact your systems administrator. AN!CM runs on
cluster nodes directly, and are not sent by Alteeve's Niche!. If you
do not know who controls these servers, please visit the support link
above and we will try to help you identify the person who can assist
you.
";
read_states($conf);
initial_report($conf);

# Infinite loop time
while (1)
{
	check_for_changes($conf);
	sleep $conf->{'system'}{sleep_time};
}

exit(0);



# This catches SIGINT and SIGTERM and fires out an email before shutting down.
sub catch_sig
{
	my $signame = shift;
	
	$conf->{mail_data}{subject} = "Cluster Monitor Shutdown";
	$conf->{mail_data}{body}    = "
The $conf->{node}{me}{short_name} cluster node's monitor program has stopped.
It received a SIG${signame} signal and shut down.
";
	send_email($conf);
	
	die "Process with PID $$ Exiting on SIG${signame}.\n";
}
