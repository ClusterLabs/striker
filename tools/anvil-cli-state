#!/usr/bin/perl
# 
# This tool does not do or change anything. It uses the information from 'anvil-report-state' and formats a 
# subset of it for display in a clean(ish) way on the command line.
# 
# Return Codes:
# 0  = OK
# 

use strict;
use warnings;
use IO::Handle;
use AN::Tools;
use Term::ANSIColor;

# Turn off buffering.
$| = 1;

# Strip the 'PATH' variable down so that it doesn't cause problems when called
# via a setuid wrapper.
$ENV{'PATH'} = "/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin";

# Prevent a discrepency between UID/GID and EUID/EGID from throwing an error.
$< = $>;
$( = $);

# Figure out who and where I am.
my $program_name        =  $0;
my $THIS_FILE           =  ($program_name =~ /^.*\/(.*)$/)[0];
my $running_directory   =  ($program_name =~ /^(.*?)\/$THIS_FILE$/)[0];
if (($running_directory =~ /^\./) && ($ENV{PWD}))
{
	$running_directory =~ s/^\./$ENV{PWD}/;
}
my $time = time;

=cut colours (from the Term::ANSIColor source)
%ATTRIBUTES = ('clear'      => 0,
               'reset'      => 0,
               'bold'       => 1,
               'dark'       => 2,
               'faint'      => 2,
               'underline'  => 4,
               'underscore' => 4,
               'blink'      => 5,
               'reverse'    => 7,
               'concealed'  => 8,

               'black'      => 30,   'on_black'   => 40,
               'red'        => 31,   'on_red'     => 41,
               'green'      => 32,   'on_green'   => 42,
               'yellow'     => 33,   'on_yellow'  => 43,
               'blue'       => 34,   'on_blue'    => 44,
               'magenta'    => 35,   'on_magenta' => 45,
               'cyan'       => 36,   'on_cyan'    => 46,
               'white'      => 37,   'on_white'   => 47);
=cut 

my $an = AN::Tools->new({
	data		=> {
		colours		=>	{
			anvil		=>	{
				name		=>	"bold cyan",
				hostnames	=>	"bold blue",
				node_offline	=>	"bold white",
				node_hung	=>	"bold red",
				node_starting	=>	"yellow",
				short_hostnames	=>	"bold blue",
				servers		=>	{
					name		=>	"bold blue",
					node1_host	=>	"bold green",		# The idea is to have a quick visual queue to tell when all servers are on the same node
					node2_host	=>	"bold cyan",
				},
			},
			bond	=>	{
				active_interface =>	"bold green", 
				bond_name	=>	"bold blue",
				duplex		=>	{
					full		=>	"bold green", 
					half		=>	"yellow",
					unknown_entry	=>	"bold magenta",
				},
				interface	=>	"bold blue",
				speed		=>	{
					'10'		=>	"red", 
					'100'		=>	"yellow",
					'1000'		=>	"bold green", 
					'10000'		=>	"bold cyan", 	# Anything over 10 Gbps will get this
					unknown_entry	=>	"bold magenta",
				},
				'state'		=>	{
					up		=>	"bold green",
					down		=>	"bold red", 
					unknown_entry	=>	"bold magenta",
				},
				updelay		=>	{
					good		=>	"bold green",
					unknown_entry	=>	"bold magenta",
				},
			},
			drbd		=>	{
				connection_state =>	{
					StandAlone	=>	"bold cyan",
					Disconnecting	=>	"yellow", 
					Unconnected	=>	"yellow",
					Timeout		=>	"bold red",
					BrokenPipe	=>	"bold red",
					NetworkFailure	=>	"bold red",
					ProtocolError	=>	"bold red",
					TearDown	=>	"yellow",
					WFConnection	=>	"bold blue",
					WFReportParams	=>	"bold blue",
					Connected	=>	"bold green",
					StartingSyncS	=>	"bold green",
					StartingSyncT	=>	"yellow",
					WFBitMapS	=>	"bold green",
					WFBitMapT	=>	"yellow",
					WFSyncUUID	=>	"bold cyan",
					SyncSource	=>	"bold green",
					SyncTarget	=>	"yellow",
					PausedSyncS	=>	"bold green",
					PausedSyncT	=>	"yellow",
					VerifyS		=>	"bold green",
					VerifyT		=>	"yellow",
					unknown_entry	=>	"bold magenta",
				},
				disk_state	=>	{
					Diskless	=>	"bold red",
					Attaching	=>	"yellow",
					Failed		=>	"bold red",
					Negotiating	=>	"yellow",
					Inconsistent	=>	"yellow",
					Outdated	=>	"yellow",
					DUnknown	=>	"yellow",
					Consistent	=>	"bold cyan",
					UpToDate	=>	"bold green",
					unknown_entry	=>	"bold magenta",
				},
				module		=>	{
					loaded		=>	"bold white",
					unloaded	=>	"faint white",
				},
				resource	=>	{
					name		=>	"bold blue", 
					online		=>	"bold green",
					offline		=>	"faint white",
				},
				role		=>	{
					Primary		=>	"bold green",
					Secondary	=>	"yellow",
					Unknown		=>	"faint white",
					unknown_entry	=>	"bold magenta",
				},
				starting	=>	"yellow",	# or stopping
				to_resync	=>	{
					nothing		=>	"faint white", 
					something	=>	"yellow", 
					eta		=>	"yellow",
					percent		=>	"yellow",
				},
				timeout		=>	"bold white",
				version		=>	"bold white",
			},
			# https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/High_Availability_Add-On_Overview/s2-rgmanager-opstates-states.html
			services	=>	{
				online		=>	"bold green",
				offline		=>	"faint white",	# stopped or disabled
				starting	=>	"yellow",	# or stopping, recovering
				failed		=>	"bold red",
				unknown_entry	=>	"bold magenta",
			},
		},
		padding		=>	{
			anvil		=>	{
				name		=>	14,
				hostnames	=>	30,
				short_hostnames	=>	14,
				whole_line	=>	106,
			},
			bond	=>	{
				bond_name	=>	10,
				'state'		=>	4,
				interface	=>	10,
				'link'		=>	{
					speed		=>	5,
					duplex		=>	2,
				},
				updelay		=>	11,
			},
			drbd		=>	{
				connection_state =>	15, 
				disk_state	=>	12, 
				header_state	=>	20, 
				ping_timeout	=>	10, 
				resource_name	=>	14, 
				role		=>	12,
				to_resync	=>	11, 
				version		=>	10, 
				sync_eta	=>	50, 
				sync_percent	=>	6,
			},
			status		=>	{
				services	=>	20,
				server		=>	{
					name		=>	40,
					'state'		=>	12,
					host		=>	30,
				},
			},
		},
		status		=>	{
			anvil		=>	{
				name		=>	"",
				hostname	=>	{
					me		=>	"",
					peer		=>	"",
				},
			},
		},
		sys		=>	{
			current_time	=>	"",
			log_level	=>	2,
			interval	=>	0,
		},
	},
});

# Initialize.
$an->default_language    ($an->data->{sys}{language});
$an->default_log_language($an->data->{sys}{log_language});
$an->default_log_file    ($an->data->{path}{log_file});
$an->Log->level          ($an->data->{sys}{log_level});
$an->Storage->read_conf  ({file => $an->data->{path}{striker_config}});
$an->Storage->read_words ({file => $an->data->{path}{striker_strings}});
$an->Get->switches();
$an->Log->db_transactions(1) if $an->data->{'anvil-safe-start'}{log_db_transactions};
$an->Readable->base2(1);

if (($an->data->{switches}{h})   or 
    ($an->data->{switches}{'?'}) or 
    ($an->data->{switches}{help}))
{
	print_usage($an);
	$an->nice_exit({exit_code => 0});
}

if (($an->data->{switches}{interval}) && ($an->data->{switches}{interval} =~ /^\d+$/))
{
	$an->data->{sys}{interval} = $an->data->{switches}{interval};
}
if (($an->data->{switches}{i}) && ($an->data->{switches}{i} =~ /^\d+$/))
{
	$an->data->{sys}{interval} = $an->data->{switches}{i};
}

my $run = 1;
while($run)
{
	# Gather whatever we can find.
	gather_data($an);
	
	# Get the current time
	$an->data->{sys}{current_time} = $an->Get->date_and_time({time_only => 1});
	
	# Clear the screen and reposition the cursor to 0,0
	print "\033[2J";    #clear the screen
	print "\033[0;0H"; #jump to 0,0
	
	# Display the data
	report_status($an);
	
	if ($an->data->{sys}{interval})
	{
		# Delete the previously gathered data and then go to sleep.
		delete $an->data->{gathered};
		sleep $an->data->{sys}{interval};
	}
	else
	{
		$run = 0;
	}
}

$an->nice_exit({exit_code => 0});


#############################################################################################################
# Functions                                                                                                 #
#############################################################################################################

# This builds the header
sub build_header
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "build_header" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	### Pad left
	# sprintf("%${padding}s", $1);
	### Pad right
	# sprintf("%-${padding}s", $1);
	my $coloured_anvil_name    = colored(sprintf("%-".$an->data->{padding}{anvil}{name}."s",      $an->data->{gathered}{anvil}{name}),    $an->data->{colours}{anvil}{name});
	my $coloured_my_hostname   = colored(sprintf("%-".$an->data->{padding}{anvil}{hostnames}."s", $an->data->{gathered}{hostname}{me}),   $an->data->{colours}{anvil}{hostnames});
	my $coloured_peer_hostname = colored(sprintf("%-".$an->data->{padding}{anvil}{hostnames}."s", $an->data->{gathered}{hostname}{peer}), $an->data->{colours}{anvil}{hostnames});
	my $page                   = $an->String->get({key => "acs_report_0001", variables => {
		anvil_name          => $coloured_anvil_name,
		my_hostname         => $coloured_my_hostname,
		peer_hostname       => $coloured_peer_hostname,
	}})."\n";
	
	return($page);
}

# This builds the clustat section
sub build_clustat_section
{
	my ($an, $node1_key, $node2_key) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "build_clustat_section" }, message_key => "an_variables_0002", message_variables => { 
		name1 => "node1_key", value1 => $node1_key,  
		name2 => "node2_key", value2 => $node2_key,  
	}, file => $THIS_FILE, line => __LINE__});
	
	# If this node is not running cman or rgmanager, we can't report on any state information.
	if (not $an->data->{gathered}{clustat}{cman}{me})
	{
		my $say_offline = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0003"}), width => $an->data->{padding}{anvil}{whole_line}});
		   $say_offline = colored($say_offline, $an->data->{colours}{anvil}{node_offline});
		my $say_message = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0008"}), width => $an->data->{padding}{anvil}{whole_line}});
		my $page        = $an->String->get({key => "acs_report_0003", variables => { 
			'state' => $say_offline,
			message => $say_message,
		}})."\n";
		return($page);
	}
	elsif (not $an->data->{gathered}{clustat}{rgmanager}{me})
	{
		my $say_starting = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0011"}), width => $an->data->{padding}{anvil}{whole_line}});
		   $say_starting = colored($say_starting, $an->data->{colours}{anvil}{node_starting});
		my $say_message  = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0010"}), width => $an->data->{padding}{anvil}{whole_line}});
		my $page         = $an->String->get({key => "acs_report_0003", variables => { 
			'state' => $say_starting,
			message => $say_message,
		}})."\n";
		return($page);
	}
	elsif ($an->data->{gathered}{clustat}{hung})
	{
		# This node's clustat is hung.
		my $say_hung    = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0007"}), width => $an->data->{padding}{anvil}{whole_line}});
		   $say_hung    = colored($say_hung, $an->data->{colours}{anvil}{node_hung});
		my $say_message = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0009"}), width => $an->data->{padding}{anvil}{whole_line}});
		my $page        = $an->String->get({key => "acs_report_0003", variables => { 
			'state' => $say_hung,
			message => $say_message,
		}})."\n";
		return($page);
	}
	
	### Setup my values
	# Top row (node 1)
	my $node1_name               = ($an->data->{gathered}{hostname}{$node1_key} =~ /^(.*?)\./)[0];
	my $say_node1_name           = $an->Readable->center_text({string => $node1_name, width => $an->data->{padding}{anvil}{short_hostnames}});
	   $say_node1_name           = colored($say_node1_name, $an->data->{colours}{anvil}{short_hostnames});
	my $node1_cluster_member     = "";
	my $node1_resource_manager   = "";
	my $node1_storage_services   = "";
	my $node1_hypervisor_service = "";
	# cman/corosync
	if ($an->data->{gathered}{clustat}{cman}{$node1_key})
	{
		$node1_cluster_member = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node1_cluster_member = colored($node1_cluster_member, $an->data->{colours}{services}{online});
	}
	else
	{
		$node1_cluster_member = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node1_cluster_member = colored($node1_cluster_member, $an->data->{colours}{services}{offline});
	}
	# rgmanager
	if ($an->data->{gathered}{clustat}{rgmanager}{$node1_key})
	{
		$node1_resource_manager = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node1_resource_manager = colored($node1_resource_manager, $an->data->{colours}{services}{online});
	}
	else
	{
		$node1_resource_manager = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node1_resource_manager = colored($node1_resource_manager, $an->data->{colours}{services}{offline});
	}
	# Storage services
	if ($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "started")
	{
		$node1_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{online});
	}
	elsif (($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "stopped") or ($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "disabled"))
	{
		$node1_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{offline});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "starting")
	{
		$node1_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0004!#", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "stopping")
	{
		$node1_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0006!#", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n01}{'state'} eq "failed")
	{
		$node1_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0005!#", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{failed});
	}
	else
	{
		# ?? This will print the raw string we got
		$node1_storage_services = $an->Readable->center_text({string => "?".$an->data->{gathered}{clustat}{service}{storage_n01}{'state'}."?", width => $an->data->{padding}{status}{services}});
		$node1_storage_services = colored($node1_storage_services, $an->data->{colours}{services}{unknown_entry});
	}
	# Hypervisor service
	if ($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "started")
	{
		$node1_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{online});
	}
	elsif (($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "stopped") or ($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "disabled"))
	{
		$node1_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{offline});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "starting")
	{
		$node1_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0004!#", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "stopping")
	{
		$node1_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0006!#", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'} eq "failed")
	{
		$node1_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0005!#", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{failed});
	}
	else
	{
		# ?? This will print the raw string we got
		$node1_hypervisor_service = $an->Readable->center_text({string => "?".$an->data->{gathered}{clustat}{service}{libvirtd_n01}{'state'}."?", width => $an->data->{padding}{status}{services}});
		$node1_hypervisor_service = colored($node1_hypervisor_service, $an->data->{colours}{services}{unknown_entry});
	}
	
	# Bottom row (node 2)
	my $node2_name               = ($an->data->{gathered}{hostname}{$node2_key} =~ /^(.*?)\./)[0];
	my $say_node2_name           = $an->Readable->center_text({string => $node2_name, width => $an->data->{padding}{anvil}{short_hostnames}});
	   $say_node2_name           = colored($say_node2_name, $an->data->{colours}{anvil}{short_hostnames});
	my $node2_cluster_member     = "";
	my $node2_resource_manager   = "";
	my $node2_storage_services   = "";
	my $node2_hypervisor_service = "";
	# cman/corosync
	if ($an->data->{gathered}{clustat}{cman}{$node2_key})
	{
		$node2_cluster_member = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node2_cluster_member = colored($node2_cluster_member, $an->data->{colours}{services}{online});
	}
	else
	{
		$node2_cluster_member = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node2_cluster_member = colored($node2_cluster_member, $an->data->{colours}{services}{offline});
	}
	# rgmanager
	if ($an->data->{gathered}{clustat}{rgmanager}{$node2_key})
	{
		$node2_resource_manager = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node2_resource_manager = colored($node2_resource_manager, $an->data->{colours}{services}{online});
	}
	else
	{
		$node2_resource_manager = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node2_resource_manager = colored($node2_resource_manager, $an->data->{colours}{services}{offline});
	}
	# Storage services
	if ($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "started")
	{
		$node2_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{online});
	}
	elsif (($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "stopped") or ($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "disabled"))
	{
		$node2_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{offline});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "starting")
	{
		$node2_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0004!#", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "stopping")
	{
		$node2_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0006!#", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{storage_n02}{'state'} eq "failed")
	{
		$node2_storage_services = $an->Readable->center_text({string => "#!string!acs_message_0005!#", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{failed});
	}
	else
	{
		# ?? This will print the raw string we got
		$node2_storage_services = $an->Readable->center_text({string => "?".$an->data->{gathered}{clustat}{service}{storage_n02}{'state'}."?", width => $an->data->{padding}{status}{services}});
		$node2_storage_services = colored($node2_storage_services, $an->data->{colours}{services}{unknown_entry});
	}
	# Hypervisor service
	if ($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "started")
	{
		$node2_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{online});
	}
	elsif (($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "stopped") or ($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "disabled"))
	{
		$node2_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{offline});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "starting")
	{
		$node2_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0004!#", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "stopping")
	{
		$node2_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0006!#", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{starting});
	}
	elsif ($an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'} eq "failed")
	{
		$node2_hypervisor_service = $an->Readable->center_text({string => "#!string!acs_message_0005!#", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{failed});
	}
	else
	{
		# ?? This will print the raw string we got
		$node2_hypervisor_service = $an->Readable->center_text({string => "?".$an->data->{gathered}{clustat}{service}{libvirtd_n02}{'state'}."?", width => $an->data->{padding}{status}{services}});
		$node2_hypervisor_service = colored($node2_hypervisor_service, $an->data->{colours}{services}{unknown_entry});
	}
	
	my $page = $an->String->get({key => "acs_report_0002", variables => {
		node1_name               => $say_node1_name,
		node1_cluster_member     => $node1_cluster_member,
		node1_resource_manager   => $node1_resource_manager,
		node1_storage_services   => $node1_storage_services,
		node1_hypervisor_service => $node1_hypervisor_service, 
		node2_name               => $say_node2_name,
		node2_cluster_member     => $node2_cluster_member,
		node2_resource_manager   => $node2_resource_manager,
		node2_storage_services   => $node2_storage_services,
		node2_hypervisor_service => $node2_hypervisor_service, 
	}})."\n";
	
	# Get the total available RAM and then tally the amount assigned to servers so that we car report the available RAM in reserve
	
	# Loop through the VGs and report their free disk space.
	
	# Now show the servers.
	my $server_count = 0;
	foreach my $server (sort {$a cmp $b} keys %{$an->data->{gathered}{clustat}{server}})
	{
		$server_count++;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
			name1 => "server_count",                                value1 => $server_count, 
			name2 => "server",                                      value2 => $server, 
			name3 => "gathered::clustat::server::${server}::host",  value3 => $an->data->{gathered}{clustat}{server}{$server}{host}, 
			name4 => "gathered::clustat::server::${server}::state", value4 => $an->data->{gathered}{clustat}{server}{$server}{'state'}, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# If this is the first server, print the header.
		if ($server_count == 1)
		{
			$page .= $an->String->get({key => "acs_report_0011"})."\n";
		}
		
		my $padding    = $an->data->{padding}{status}{server}{name};
		my $say_server = sprintf("%-${padding}s", $server);
		   $say_server = colored($say_server, $an->data->{colours}{anvil}{servers}{name});
		   $padding    = $an->data->{padding}{status}{server}{host};
		my $say_host   = $an->data->{gathered}{clustat}{server}{$server}{host};
		my $say_state  = "";
		if ($say_host eq "none")
		{
			$say_host  = sprintf("%-${padding}s", $an->data->{gathered}{clustat}{server}{$server}{host});
			$say_host  = sprintf("%-${padding}s", "--");
			$say_host  = colored($say_host, $an->data->{colours}{services}{offline});
			$say_state = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{server}{'state'}});
			$say_state = colored($say_state, $an->data->{colours}{services}{offline});
			$an->Log->entry({log_level => 3, message_key => "an_variables_0003", message_variables => {
				name1 => "server",    value1 => $server, 
				name2 => "say_host",  value2 => $say_host, 
				name3 => "say_state", value3 => $say_state, 
			}, file => $THIS_FILE, line => __LINE__});
		}
		else
		{
			# We colour the host names to make it easy to visually see if all servers are on the
			# same node.
			if (($say_host =~ /n01/) or ($say_host =~ /n1/) or ($say_host =~ /node01/) or ($say_host =~ /node01/))
			{
				$say_host = sprintf("%-${padding}s", $an->data->{gathered}{clustat}{server}{$server}{host});
				$say_host = colored($say_host, $an->data->{colours}{anvil}{servers}{node1_host});
			}
			else
			{
				$say_host = sprintf("%-${padding}s", $an->data->{gathered}{clustat}{server}{$server}{host});
				$say_host = colored($say_host, $an->data->{colours}{anvil}{servers}{node2_host});
			}
			$say_state = $an->data->{gathered}{clustat}{server}{$server}{'state'};
			if ($say_state eq "started")
			{
				$say_state = $an->Readable->center_text({string => "#!string!acs_message_0002!#", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{online});
			}
			elsif (($say_state eq "disabled") or ($say_state eq "stopped"))
			{
				$say_state = $an->Readable->center_text({string => "#!string!acs_message_0003!#", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{offline});
			}
			elsif (($say_state eq "starting") or ($say_state eq "recovering"))
			{
				$say_state = $an->Readable->center_text({string => "#!string!acs_message_0004!#", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{starting});
			}
			elsif ($say_state eq "stopping")
			{
				$say_state = $an->Readable->center_text({string => "#!string!acs_message_0006!#", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{starting});
			}
			elsif (($say_state eq "failed") or ($say_state or "recoverable"))
			{
				$say_state = $an->Readable->center_text({string => "#!string!acs_message_0005!#", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{failed});
			}
			else
			{
				$say_state = $an->Readable->center_text({string => "?".$say_state."?", width => $an->data->{padding}{status}{server}{'state'}});
				$say_state = colored($say_state, $an->data->{colours}{services}{unknown_entry});
			}
		}
		
		$page .= $an->String->get({key => "acs_report_0012", variables => {
			server_name => $say_server,
			'state'     => $say_state,
			host        => $say_host, 
		}})."\n";
	}
	
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "server_count", value1 => $server_count, 
	}, file => $THIS_FILE, line => __LINE__});
	if ($server_count)
	{
		# Print the footer
		$page .= $an->String->get({key => "acs_report_0009"})."\n";
	}
	else
	{
		# Print the 'no servers found' message.
		$page .= $an->String->get({key => "acs_report_0013"})."\n";
	}
	
	return($page);
}

# This builds the clustat section
sub build_drbd_section
{
	my ($an, $node1_key, $node2_key) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "build_drbd_section" }, message_key => "an_variables_0002", message_variables => { 
		name1 => "node1_key", value1 => $node1_key,  
		name2 => "node2_key", value2 => $node2_key,  
	}, file => $THIS_FILE, line => __LINE__});
	
	my $page              = "";
	my $say_version       = $an->Readable->center_text({string => $an->data->{gathered}{drbd}{version}, width => $an->data->{padding}{drbd}{version}});
	   $say_version       = colored($say_version, $an->data->{colours}{drbd}{version});
	my $say_timeout       = $an->Readable->center_text({string => $an->data->{gathered}{drbd}{net}{'ping-timeout'}, width => $an->data->{padding}{drbd}{ping_timeout}});
	   $say_timeout       = colored($say_timeout, $an->data->{colours}{drbd}{timeout});
	my $say_module_status = "";
	if ($an->data->{gathered}{drbd}{status} eq "offline")
	{
		# We're offline. Only show the header section.
		   $say_module_status = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0013"}), width => $an->data->{padding}{drbd}{header_state}});
		   $say_module_status = colored($say_module_status, $an->data->{colours}{drbd}{module}{loaded});
		   $say_module_status = colored($say_module_status, $an->data->{colours}{drbd}{module}{unloaded});
		my $say_offline       = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0003"}), width => $an->data->{padding}{anvil}{whole_line}});
		   $say_offline       = colored($say_offline, $an->data->{colours}{drbd}{module}{unloaded});
		my $say_message       = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0014"}), width => $an->data->{padding}{anvil}{whole_line}});
		
		# Return, nothing more to show.
		$page .= $an->String->get({key => "acs_report_0005", variables => {
			version      => $say_version,
			header_state => $say_module_status, 
			timeout      => $say_timeout,
		}})."\n";
		$page .= $an->String->get({key => "acs_report_0003", variables => { 
			'state' => $say_offline,
			message => $say_message,
		}})."\n";
		return($page);
	}
	else
	{
		# Online
		$say_module_status = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0012"}), width => $an->data->{padding}{drbd}{header_state}});
		$say_module_status = colored($say_module_status, $an->data->{colours}{drbd}{module}{loaded});
		$page .= $an->String->get({key => "acs_report_0005", variables => {
			version      => $say_version,
			header_state => $say_module_status, 
			timeout      => $say_timeout,
		}})."\n";
		
		# But how many resources?
		my $resource_count = 0;
		foreach my $resource (sort {$a cmp $b} keys %{$an->data->{gathered}{drbd}{resource}})
		{
			if ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state})
			{
				$resource_count++;
			}
		}
		
		if (not $resource_count)
		{
			# Module is loaded but no resources are running.
			my $say_no_resources = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0011"}), width => $an->data->{padding}{anvil}{whole_line}});
			   $say_no_resources = colored($say_no_resources, $an->data->{colours}{drbd}{starting});
			my $say_message      = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0015"}), width => $an->data->{padding}{anvil}{whole_line}});
			
			# Return, nothing more to show.
			$page .= $an->String->get({key => "acs_report_0003", variables => { 
				'state' => $say_no_resources,
				message => $say_message,
			}})."\n";
			return($page);
		}
	}
	
	### Still here? At least one resource is running!
	# print the column headers
	my $node1_name               = ($an->data->{gathered}{hostname}{$node1_key} =~ /^(.*?)\./)[0];
	my $node2_name               = ($an->data->{gathered}{hostname}{$node2_key} =~ /^(.*?)\./)[0];
	
	my $say_disk_state_node1 = $an->Readable->center_text({string => $node1_name, width => $an->data->{padding}{drbd}{disk_state}});
	   $say_disk_state_node1 = colored($say_disk_state_node1, $an->data->{colours}{anvil}{short_hostnames});
	my $say_disk_state_node2 = $an->Readable->center_text({string => $node2_name, width => $an->data->{padding}{drbd}{disk_state}});
	   $say_disk_state_node2 = colored($say_disk_state_node2, $an->data->{colours}{anvil}{short_hostnames});
	my $say_role_node1       = $an->Readable->center_text({string => $node1_name, width => $an->data->{padding}{drbd}{role}});
	   $say_role_node1       = colored($say_role_node1, $an->data->{colours}{anvil}{short_hostnames});
	my $say_role_node2       = $an->Readable->center_text({string => $node2_name, width => $an->data->{padding}{drbd}{role}});
	   $say_role_node2       = colored($say_role_node2, $an->data->{colours}{anvil}{short_hostnames});
	$page .= $an->String->get({key => "acs_report_0006", variables => { 
			disk_state_node1 => $say_disk_state_node1,
			disk_state_node2 => $say_disk_state_node2,
			role_node1       => $say_role_node1,
			role_node2       => $say_role_node2,
		}})."\n";
	
	# Now loop through the resources.
	foreach my $resource (sort {$a cmp $b} keys %{$an->data->{gathered}{drbd}{resource}})
	{
		my $say_resource_name    = $resource.":".$an->data->{gathered}{drbd}{resource}{$resource}{drbd_device};
		   $say_resource_name    = $an->Readable->center_text({string => $say_resource_name, width => $an->data->{padding}{drbd}{resource_name}});
		my $say_connection_state = "";
		my $say_node1_disk_state = "";
		my $say_node1_role       = "";
		my $say_node2_disk_state = "";
		my $say_node2_role       = "";
		my $bytes_to_resync      = ($an->data->{gathered}{drbd}{resource}{$resource}{out_of_sync} =~ /^(\d+) Bytes/i)[0]; 
		my $say_to_resync        = "";
		my $resync_in_progress   = "";
		
		if ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state})
		{
			# Resource is up!
			$say_resource_name = colored($say_resource_name, $an->data->{colours}{drbd}{resource}{name});
			
			# Connection states, lots of connection states... - http://www.drbd.org/en/doc/users-guide-84/ch-admin#s-connection-states
			if ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "StandAlone")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0016!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{StandAlone});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "Disconnecting")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0017!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{Disconnecting});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "Unconnected")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0018!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{Unconnected});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "Timeout")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0019!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{Timeout});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "BrokenPipe")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0020!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{BrokenPipe});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "NetworkFailure")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0021!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{NetworkFailure});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "ProtocolError")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0022!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{ProtocolError});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "TearDown")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0023!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{TearDown});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "WFConnection")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0024!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{WFConnection});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "WFReportParams")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0025!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{WFReportParams});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "Connected")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0026!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{Connected});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "StartingSyncS")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0027!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{StartingSyncS});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "StartingSyncT")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0028!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{StartingSyncT});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "WFBitMapS")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0029!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{WFBitMapS});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "WFBitMapT")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0030!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{WFBitMapT});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "WFSyncUUID")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0031!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{WFSyncUUID});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "SyncSource")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0032!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{SyncSource});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "SyncTarget")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0033!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{SyncTarget});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "PausedSyncS")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0034!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{PausedSyncS});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "PausedSyncT")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0035!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{PausedSyncT});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "VerifyS")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0036!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{VerifyS});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{connection_state} eq "VerifyT")
			{
				$say_connection_state = $an->Readable->center_text({string => "#!string!acs_message_0037!#", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{VerifyT});
			}
			else
			{
				# Dunno what this is...
				$say_connection_state = $an->Readable->center_text({string => "?".$an->data->{gathered}{drbd}{resource}{$resource}{connection_state}."?", width => $an->data->{padding}{drbd}{connection_state}});
				$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{connection_state}{unknown_entry});
			}
			
			### Disk states, one per node. - http://www.drbd.org/en/doc/users-guide-84/ch-admin#s-disk-states
			# Node 1
			if ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Diskless")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0038!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Diskless});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Attaching")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0039!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Attaching});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Failed")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0040!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Failed});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Negotiating")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0041!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Negotiating});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Inconsistent")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0042!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Inconsistent});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Outdated")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0043!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Outdated});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "DUnknown")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0044!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{DUnknown});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "Consistent")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0045!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{Consistent});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key} eq "UpToDate")
			{
				$say_node1_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0046!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{UpToDate});
			}
			else
			{
				# Dunno what this is...
				$say_node1_disk_state = $an->Readable->center_text({string => "?".$an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node1_key}."?", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{disk_state}{unknown_entry});
			}
			# Node 2
			if ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Diskless")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0038!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Diskless});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Attaching")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0039!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Attaching});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Failed")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0040!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Failed});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Negotiating")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0041!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Negotiating});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Inconsistent")
			{
				
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0042!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Inconsistent});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Outdated")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0043!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Outdated});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "DUnknown")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0044!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{DUnknown});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "Consistent")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0045!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{Consistent});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key} eq "UpToDate")
			{
				$say_node2_disk_state = $an->Readable->center_text({string => "#!string!acs_message_0046!#", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{UpToDate});
			}
			else
			{
				# Dunno what this is...
				$say_node2_disk_state = $an->Readable->center_text({string => "?".$an->data->{gathered}{drbd}{resource}{$resource}{disk_state}{$node2_key}."?", width => $an->data->{padding}{drbd}{disk_state}});
				$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{disk_state}{unknown_entry});
			}
			
			### Resource Roles - http://www.drbd.org/en/doc/users-guide-84/ch-admin#s-roles
			# Node 1
			if ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node1_key} eq "Primary")
			{
				$say_node1_role = $an->Readable->center_text({string => "#!string!acs_message_0047!#", width => $an->data->{padding}{drbd}{role}});
				$say_node1_role = colored($say_node1_role, $an->data->{colours}{drbd}{role}{Primary});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node1_key} eq "Secondary")
			{
				$say_node1_role = $an->Readable->center_text({string => "#!string!acs_message_0048!#", width => $an->data->{padding}{drbd}{role}});
				$say_node1_role = colored($say_node1_role, $an->data->{colours}{drbd}{role}{Secondary});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node1_key} eq "Unknown")
			{
				$say_node1_role = $an->Readable->center_text({string => "#!string!acs_message_0049!#", width => $an->data->{padding}{drbd}{role}});
				$say_node1_role = colored($say_node1_role, $an->data->{colours}{drbd}{role}{Unknown});
			}
			else
			{
				# Dunno what this is...
				$say_node1_role = $an->Readable->center_text({string => "?".$an->data->{gathered}{drbd}{resource}{$resource}{role}{$node1_key}."?", width => $an->data->{padding}{drbd}{role}});
				$say_node1_role = colored($say_node1_role, $an->data->{colours}{drbd}{role}{unknown_entry});
			}
			# Node 2
			if ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node2_key} eq "Primary")
			{
				$say_node2_role = $an->Readable->center_text({string => "#!string!acs_message_0047!#", width => $an->data->{padding}{drbd}{role}});
				$say_node2_role = colored($say_node2_role, $an->data->{colours}{drbd}{role}{Primary});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node2_key} eq "Secondary")
			{
				$say_node2_role = $an->Readable->center_text({string => "#!string!acs_message_0048!#", width => $an->data->{padding}{drbd}{role}});
				$say_node2_role = colored($say_node2_role, $an->data->{colours}{drbd}{role}{Secondary});
			}
			elsif ($an->data->{gathered}{drbd}{resource}{$resource}{role}{$node2_key} eq "Unknown")
			{
				$say_node2_role = $an->Readable->center_text({string => "#!string!acs_message_0049!#", width => $an->data->{padding}{drbd}{role}});
				$say_node2_role = colored($say_node2_role, $an->data->{colours}{drbd}{role}{Unknown});
			}
			else
			{
				# Dunno what this is...
				$say_node2_role = $an->Readable->center_text({string => "?".$an->data->{gathered}{drbd}{resource}{$resource}{role}{$node2_key}."?", width => $an->data->{padding}{drbd}{role}});
				$say_node2_role = colored($say_node2_role, $an->data->{colours}{drbd}{role}{unknown_entry});
			}
			
			my $bytes_to_resync = ($an->data->{gathered}{drbd}{resource}{$resource}{out_of_sync} =~ /^(\d+) Bytes/i)[0]; 
			if (($bytes_to_resync) && ($bytes_to_resync > 0))
			{
				# Stuff to sync
				$say_to_resync      = $an->Readable->center_text({string => $an->Readable->bytes_to_hr({'bytes' => $bytes_to_resync}), width => $an->data->{padding}{drbd}{to_resync}});
				$say_to_resync      = colored($say_to_resync, $an->data->{colours}{drbd}{to_resync}{something});
			}
			else
			{
				# Nothing to sync.
				$say_to_resync = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{to_resync}});
				$say_to_resync = colored($say_to_resync, $an->data->{colours}{drbd}{to_resync}{nothing});
			}
			
				$resync_in_progress = 1;
		}
		else
		{
			# Resource is down.
			$say_resource_name    = colored($say_resource_name, $an->data->{colours}{drbd}{resource}{offline});
			$say_connection_state = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{connection_state}});
			$say_connection_state = colored($say_connection_state, $an->data->{colours}{drbd}{resource}{offline});
			$say_node1_disk_state = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{disk_state}});
			$say_node1_disk_state = colored($say_node1_disk_state, $an->data->{colours}{drbd}{resource}{offline});
			$say_node1_role       = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{role}});
			$say_node1_role       = colored($say_node1_role, $an->data->{colours}{drbd}{resource}{offline});
			$say_node2_disk_state = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{disk_state}});
			$say_node2_disk_state = colored($say_node2_disk_state, $an->data->{colours}{drbd}{resource}{offline});
			$say_node2_role       = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{role}});
			$say_node2_role       = colored($say_node2_role, $an->data->{colours}{drbd}{resource}{offline});
			$say_to_resync        = $an->Readable->center_text({string => "--", width => $an->data->{padding}{drbd}{to_resync}});
			$say_to_resync        = colored($say_to_resync, $an->data->{colours}{drbd}{resource}{offline});
		}
		
		# Put this resource string together.
		$page .= $an->String->get({key => "acs_report_0007", variables => { 
			resource_name    => $say_resource_name,
			connection_state => $say_connection_state,
			node1_disk_state => $say_node1_disk_state, 
			node2_disk_state => $say_node2_disk_state, 
			node1_role       => $say_node1_role, 
			node2_role       => $say_node2_role, 
			to_resync        => $say_to_resync, 
		}})."\n";

		if ($an->data->{gathered}{drbd}{resource}{$resource}{syncing})
		{
			### NOTE: This will be used later to show the percentage complete and ETA of a resync
			my $percent_synced =  ($an->data->{gathered}{drbd}{resource}{$resource}{synced} =~ /(\d.*?) %/)[0];
			   $percent_synced .= "%";
			my $eta_seconds    =  ($an->data->{gathered}{drbd}{resource}{$resource}{eta_to_sync} =~ /(\d+) Seconds/i)[0];
			my $say_eta        =  $an->Readable->time({
					'time'  => $eta_seconds, 
					process => 1, 
					suffix  => "long"
				});
			if (not defined $percent_synced)
			{
				$percent_synced = $an->data->{gathered}{drbd}{resource}{$resource}{synced};
			}
			if (not defined $eta_seconds)
			{
				$say_eta = $an->data->{gathered}{drbd}{resource}{$resource}{eta_to_sync};
			}
			$percent_synced = $an->Readable->center_text({string => $percent_synced, width => $an->data->{padding}{drbd}{sync_percent}});
			$percent_synced = colored($percent_synced, $an->data->{colours}{drbd}{to_resync}{percent});
			$say_eta        = $an->Readable->center_text({string => $say_eta, width => $an->data->{padding}{drbd}{sync_eta}});
			$say_eta        = colored($say_eta, $an->data->{colours}{drbd}{to_resync}{eta});
			
			$page .= $an->String->get({key => "acs_report_0008", variables => { 
				sync_percent => $percent_synced,
				sync_eta     => $say_eta,
			}})."\n";
		}
	}
	
	# Close 'er up.
	$page .= $an->String->get({key => "acs_report_0009"})."\n";
	
	return($page);
}

# This builds the section for bonds and their interfaces.
sub build_bond_section
{
	my ($an, $node1_key, $node2_key) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "build_bond_section" }, message_key => "an_variables_0002", message_variables => { 
		name1 => "node1_key", value1 => $node1_key,  
		name2 => "node2_key", value2 => $node2_key,  
	}, file => $THIS_FILE, line => __LINE__});
	
	my $bonds = 0;
	my $page  = "";
	foreach my $bond (sort {$a cmp $b} keys %{$an->data->{gathered}{bonds}})
	{
		$bonds++;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0002", message_variables => {
			name1 => "bonds", value1 => $bonds, 
			name2 => "bond",  value2 => $bond, 
		}, file => $THIS_FILE, line => __LINE__});
		
		if ($bonds == 1)
		{
			# Print the header
			$page .= $an->String->get({key => "acs_report_0014"})."\n";
		}
		
		# Padding values for easier use in sprintf
		my $pad_bond_name = $an->data->{padding}{bond}{bond_name};
		my $pad_interface = $an->data->{padding}{bond}{interface};
		my $pad_updelay   = $an->data->{padding}{bond}{updelay};
		
		# Gather the data
		my $bond_name     = $bond;
		   $bond_name     = sprintf("%-${pad_bond_name}s", $bond_name);
		   $bond_name     = colored($bond_name, $an->data->{colours}{bond}{bond_name});
		my $bond_state    = $an->data->{gathered}{bonds}{$bond}{mii_status};		# up / down
		my $active_iface  = $an->data->{gathered}{bonds}{$bond}{active_interface};	# 
		   $active_iface  = sprintf("%-${pad_interface}s", $active_iface);
		   $active_iface  = colored($active_iface, $an->data->{colours}{bond}{active_interface});
		my $iface_updelay = ($an->data->{gathered}{bonds}{$bond}{up_delay} =~ /^(\d+) /)[0];
		
		# Translate the state
		if ($bond_state eq "up")
		{
			$bond_state = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0050"}), width => $an->data->{padding}{bond}{'state'}});
			$bond_state = colored($bond_state, $an->data->{colours}{bond}{'state'}{up});
		}
		elsif ($bond_state eq "down")
		{
			$bond_state = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0051"}), width => $an->data->{padding}{bond}{'state'}});
			$bond_state = colored($bond_state, $an->data->{colours}{bond}{'state'}{down});
		}
		else
		{
			$bond_state = $an->Readable->center_text({string => "?".$bond_state."?", width => $an->data->{padding}{bond}{'state'}});
			$bond_state = colored($bond_state, $an->data->{colours}{bond}{'state'}{unknown_entry});
		}
		
		# and the up delay
		if ($iface_updelay =~ /^\d+$/)
		{
			$iface_updelay /= 1000;
			$iface_updelay .= $iface_updelay == 1 ? " ".$an->String->get({key => "suffix_0014"}) : " ".$an->String->get({key => "suffix_0015"});	# Singular vs plural
			$iface_updelay =  sprintf("%-${pad_updelay}s", $iface_updelay);
			$iface_updelay =  colored($iface_updelay, $an->data->{colours}{bond}{updelay}{good});
		}
		else
		{
			$iface_updelay = sprintf("%-${pad_updelay}s", "?".$iface_updelay."?");
			$iface_updelay = colored($iface_updelay, $an->data->{colours}{bond}{updelay}{unknown_entry});
		}
		$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
			name1 => "bond_name",   value1 => $bond_name, 
			name2 => "bond_state",  value2 => $bond_state, 
			name3 => "active_iface",  value3 => $active_iface, 
			name4 => "iface_updelay", value4 => $iface_updelay, 
		}, file => $THIS_FILE, line => __LINE__});
		
		# Now sort out the interfaces
		my $link1_name    = "";
		my $link1_speed   = "";
		my $link1_duplex  = "";
		my $link1_state   = "";
		my $link2_name    = "";
		my $link2_speed   = "";
		my $link2_duplex  = "";
		my $link2_state   = "";
		foreach my $iface (sort {$a cmp $b} keys %{$an->data->{gathered}{bonds}{$bond}{interface}})
		{
			$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
				name1 => "iface",                                                     value1 => $iface, 
				name2 => "gathered::bonds::${bond}::interface::${iface}::speed",      value2 => $an->data->{gathered}{bonds}{$bond}{interface}{$iface}{speed}, 
				name3 => "gathered::bonds::${bond}::interface::${iface}::duplex",     value3 => $an->data->{gathered}{bonds}{$bond}{interface}{$iface}{duplex}, 
				name4 => "gathered::bonds::${bond}::interface::${iface}::mii_status", value4 => $an->data->{gathered}{bonds}{$bond}{interface}{$iface}{mii_status}, 
			}, file => $THIS_FILE, line => __LINE__});
			
			# Interface name
			
			my $interface_name = sprintf("%-${pad_interface}s", $iface);
			   $interface_name = colored($interface_name, $an->data->{colours}{bond}{interface});
			
			# Process the state
			my $link_state = $an->data->{gathered}{bonds}{$bond}{interface}{$iface}{mii_status};
			if ($link_state eq "up")
			{
				$link_state = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0050"}), width => $an->data->{padding}{bond}{'state'}});
				$link_state = colored($link_state, $an->data->{colours}{bond}{'state'}{up});
			}
			elsif ($link_state eq "down")
			{
				$link_state = $an->Readable->center_text({string => $an->String->get({key => "acs_message_0051"}), width => $an->data->{padding}{bond}{'state'}});
				$link_state = colored($link_state, $an->data->{colours}{bond}{'state'}{down});
			}
			else
			{
				$link_state = $an->Readable->center_text({string => "?".$link_state."?", width => $an->data->{padding}{bond}{'state'}});
				$link_state = colored($link_state, $an->data->{colours}{bond}{'state'}{unknown_entry});
			}
			
			# Process the speed
			my $pad_speed  = $an->data->{padding}{bond}{'link'}{speed};
			my $link_speed = ($an->data->{gathered}{bonds}{$bond}{interface}{$iface}{speed} =~ /^(\d+) /)[0];
			if ($link_speed > 1001)
			{
				# 10 Gbps or better
				$link_speed = sprintf("%-${pad_speed}s", $link_speed);
				$link_speed = colored($link_speed, $an->data->{colours}{bond}{speed}{'10000'});
			}
			elsif ($link_speed == 1000)
			{
				# Gbit
				$link_speed = sprintf("%-${pad_speed}s", $link_speed);
				$link_speed = colored($link_speed, $an->data->{colours}{bond}{speed}{'1000'});
			}
			elsif ($link_speed == 100)
			{
				# 100 Mbit... uh oh
				$link_speed = sprintf("%-${pad_speed}s", $link_speed);
				$link_speed = colored($link_speed, $an->data->{colours}{bond}{speed}{'100'});
			}
			elsif ($link_speed == 10)
			{
				# 10 Mbit. Hello 90s.
				$link_speed = sprintf("%-${pad_speed}s", $link_speed);
				$link_speed = colored($link_speed, $an->data->{colours}{bond}{speed}{'10'});
			}
			else
			{
				# wat?
				$link_speed = sprintf("%-${pad_speed}s", "?".$link_speed."?");
				$link_speed = colored($link_speed, $an->data->{colours}{bond}{speed}{unknown_entry});
			}
			
			# Process the duplex
			my $pad_duplex  = $an->data->{padding}{bond}{'link'}{duplex};
			my $link_duplex = $an->data->{gathered}{bonds}{$bond}{interface}{$iface}{duplex};
			if ($link_duplex eq "full")
			{
				# Full duplex
				$link_duplex = $an->String->get({key => "acs_message_0052"});
				$link_duplex = sprintf("%-${pad_duplex}s", $link_duplex);
				$link_duplex = colored($link_duplex, $an->data->{colours}{bond}{duplex}{full});
			}
			elsif ($link_duplex eq "half")
			{
				# Half duplex... not good.
				$link_duplex = $an->String->get({key => "acs_message_0053"});
				$link_duplex = sprintf("%-${pad_duplex}s", $link_duplex);
				$link_duplex = colored($link_duplex, $an->data->{colours}{bond}{duplex}{half});
			}
			else
			{
				# *sigh*
				$link_duplex = sprintf("%-${pad_duplex}s", "?".$link_duplex."?");
				$link_duplex = colored($link_duplex, $an->data->{colours}{bond}{duplex}{unknown_entry});
			}
			
			# Now store it
			if ($iface =~ /1$/)
			{
				# Link 1
				$link1_name   = $interface_name;
				$link1_speed  = $link_speed;
				$link1_duplex = $link_duplex;
				$link1_state  = $link_state;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
					name1 => "link1_name",   value1 => $link1_name, 
					name2 => "link1_speed",  value2 => $link1_speed, 
					name3 => "link1_duplex", value3 => $link1_duplex, 
					name4 => "link1_state",  value4 => $link1_state, 
				}, file => $THIS_FILE, line => __LINE__});
			}
			else
			{
				# Link 2
				$link2_name   = $interface_name;
				$link2_speed  = $link_speed;
				$link2_duplex = $link_duplex;
				$link2_state  = $link_state;
				$an->Log->entry({log_level => 3, message_key => "an_variables_0004", message_variables => {
					name1 => "link2_name",   value1 => $link2_name, 
					name2 => "link2_speed",  value2 => $link2_speed, 
					name3 => "link2_duplex", value3 => $link2_duplex, 
					name4 => "link2_state",  value4 => $link2_state, 
				}, file => $THIS_FILE, line => __LINE__});
			}
		}
		
		$an->Log->entry({log_level => 3, message_key => "an_variables_0012", message_variables => {
			name1  => "bond_name",     value1  => $bond_name, 
			name2  => "bond_state",    value2  => $bond_state, 
			name3  => "active_iface",  value3  => $active_iface, 
			name4  => "iface_updelay", value4  => $iface_updelay, 
			name5  => "link1_name",    value5  => $link1_name, 
			name6  => "link1_speed",   value6  => $link1_speed, 
			name7  => "link1_duplex",  value7  => $link1_duplex, 
			name8  => "link1_state",   value8  => $link1_state, 
			name9  => "link2_name",    value9  => $link2_name, 
			name10 => "link2_speed",   value10 => $link2_speed, 
			name11 => "link2_duplex",  value11 => $link2_duplex, 
			name12 => "link2_state",   value12 => $link2_state, 
		}, file => $THIS_FILE, line => __LINE__});
		# #!variable!!#
		# | #!variable!bond_name!# - #!variable!bond_state!# | #!variable!active_iface!# | #!variable!link1_name!# - #!variable!link1_state!# - #!variable!link1_speed!# #!variable!link1_duplex!# | #!variable!link2_name!# - #!variable!link2_state!# - #!variable!link2_speed!# #!variable!link2_duplex!# | #!variable!iface_updelay!# |
		$page .= $an->String->get({key => "acs_report_0015", variables => {
			bond_name     => $bond_name, 
			bond_state    => $bond_state, 
			active_iface  => $active_iface, 
			iface_updelay => $iface_updelay, 
			link1_name    => $link1_name, 
			link1_speed   => $link1_speed, 
			link1_duplex  => $link1_duplex, 
			link1_state   => $link1_state, 
			link2_name    => $link2_name, 
			link2_speed   => $link2_speed, 
			link2_duplex  => $link2_duplex, 
			link2_state   => $link2_state, 
		}})."\n";
		
	}
	
	if ($bonds)
	{
		$page .= $an->String->get({key => "acs_report_0009"})."\n";
	}
	
	return($page);
}

# This prints out the information we gathered
sub report_status
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "report_status" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	# Build the header
	my $page = build_header($an);
	
	# Am I node 1 or 2? 
	my $node1_key = "me";
	my $node2_key = "peer";
	if (($an->data->{gathered}{clustat}{name}{me} =~ /n2/)    or 
	    ($an->data->{gathered}{clustat}{name}{me} =~ /n02/)   or 
	    ($an->data->{gathered}{clustat}{name}{me} =~ /node2/) or 
	    ($an->data->{gathered}{clustat}{name}{me} =~ /node02/))
	{
		$node1_key = "peer";
		$node2_key = "me";
	}
	
	# Build the clustat section
	$page .= build_clustat_section($an, $node1_key, $node2_key);
	
	# Build the DRBD section.
	$page .= build_drbd_section($an, $node1_key, $node2_key);
	
	# Build the Bonds section.
	$page .= build_bond_section($an, $node1_key, $node2_key);
	
	# We're ready!
	print $page;
	
	return(0);
}

# This calls 'anvil-report-state' to gather information about the node.
sub gather_data
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "gather_data" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	my $shell_call = $an->data->{path}{'anvil-report-state'}." --fast";
	$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
		name1 => "shell_call", value1 => $shell_call, 
	}, file => $THIS_FILE, line => __LINE__});
	open (my $file_handle, "$shell_call 2>&1 |") or $an->Alert->error({title_key => "error_title_0020", message_key => "error_message_0022", message_variables => { shell_call => $shell_call, error => $! }, code => 30, file => $THIS_FILE, line => __LINE__});
	while(<$file_handle>)
	{
		chomp;
		my $line = $_;
		$an->Log->entry({log_level => 3, message_key => "an_variables_0001", message_variables => {
			name1 => "line", value1 => $line, 
		}, file => $THIS_FILE, line => __LINE__});
		
		if ($line =~ /(.*?) = \[(.*?)\]/)
		{
			my $variable = "gathered::".$1;
			my $value    = $2;
			$an->_make_hash_reference($an->data, $variable, $value);
		}
	}
	close $file_handle;
	
	return(0);
}

# Print the usage information.
sub print_usage
{
	my ($an) = @_;
	$an->Log->entry({log_level => 3, title_key => "tools_log_0001", title_variables => { function => "print_usage" }, message_key => "tools_log_0002", file => $THIS_FILE, line => __LINE__});
	
	open (my $file_handle, ">", "/tmp/${THIS_FILE}.help") or die "Couldn't write help to /tmp/, error was: $!\n";
	print $file_handle $an->String->get({key => "acs_message_0001"})."\n";
	close $file_handle;
	
	system($an->data->{path}{'less'}." /tmp/${THIS_FILE}.help");

	return(0);
}
